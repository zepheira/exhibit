

/* collection.js */

Exhibit.Collection=function(database){this._database=database;this._listeners=new SimileAjax.ListenerQueue();this._facets=[];this._updating=false;this._items=null;this._restrictedItems=null;var self=this;this._listener={onAfterLoadingItems:function(){self._update();}};database.addListener(this._listener);};Exhibit.Collection.getCollection=function(configuration,exhibit){var id=configuration["collectionID"];if(id==null){return exhibit.getDefaultCollection();}else{return exhibit.getCollection(id);}};Exhibit.Collection.getCollectionFromDOM=function(elmt,configuration,exhibit){var id=Exhibit.getAttribute(elmt,"collectionID");if(id==null){return Exhibit.Collection.getCollection(configuration,exhibit);}else{return exhibit.getCollection(id);}};Exhibit.Collection.createFromDOM=function(elmt,database){var collection=new Exhibit.Collection(database);var itemTypes=Exhibit.getAttribute(elmt,"itemTypes",",");if(itemTypes!=null&&itemTypes.length>0){collection._itemTypes=itemTypes;collection._update=Exhibit.Collection._typeBasedCollection_update;}else{collection._update=Exhibit.Collection._allItemsCollection_update;}
collection._update();return collection;};Exhibit.Collection.createAllItemsCollection=function(database){var collection=new Exhibit.Collection(database);collection._update=Exhibit.Collection._allItemsCollection_update;collection._update();return collection;};Exhibit.Collection._allItemsCollection_update=function(){this._items=this._database.getAllItems();this._onRootItemsChanged();};Exhibit.Collection._typeBasedCollection_update=function(){var newItems=new Exhibit.Set();for(var i=0;i<this._itemTypes.length;i++){this._database.getSubjects(this._itemTypes[i],"type",newItems);}
this._items=newItems;this._onRootItemsChanged();};Exhibit.Collection.prototype.dispose=function(){this._database.removeListener(this._listener);this._database=null;};Exhibit.Collection.prototype.addListener=function(listener){this._listeners.add(listener);};Exhibit.Collection.prototype.removeListener=function(listener){this._listeners.remove(listener);};Exhibit.Collection.prototype.addFacet=function(facet){this._facets.push(facet);if(facet.hasRestrictions()){this._computeRestrictedItems();this._updateFacets(null);this._listeners.fire("onItemsChanged",[]);}else{facet.update(this.getRestrictedItems());}};Exhibit.Collection.prototype.removeFacet=function(facet){for(var i=0;i<this._facets.length;i++){if(facet==this._facets[i]){this._facets.splice(i,1);if(facet.hasRestrictions()){this._computeRestrictedItems();this._updateFacets(null);this._listeners.fire("onItemsChanged",[]);}
break;}}};Exhibit.Collection.prototype.clearAllRestrictions=function(){var restrictions=[];this._updating=true;for(var i=0;i<this._facets.length;i++){restrictions.push(this._facets[i].clearAllRestrictions());}
this._updating=false;this.onFacetUpdated(null);return restrictions;};Exhibit.Collection.prototype.applyRestrictions=function(restrictions){this._updating=true;for(var i=0;i<this._facets.length;i++){this._facets[i].applyRestrictions(restrictions[i]);}
this._updating=false;this.onFacetUpdated(null);};Exhibit.Collection.prototype.getAllItems=function(){return new Exhibit.Set(this._items);};Exhibit.Collection.prototype.countAllItems=function(){return this._items.size();};Exhibit.Collection.prototype.getRestrictedItems=function(){return new Exhibit.Set(this._restrictedItems);};Exhibit.Collection.prototype.countRestrictedItems=function(){return this._restrictedItems.size();};Exhibit.Collection.prototype.onFacetUpdated=function(facetChanged){if(!this._updating){this._computeRestrictedItems();this._updateFacets(facetChanged);this._listeners.fire("onItemsChanged",[]);}}
Exhibit.Collection.prototype._onRootItemsChanged=function(){this._computeRestrictedItems();this._updateFacets(null);this._listeners.fire("onItemsChanged",[]);};Exhibit.Collection.prototype._updateFacets=function(facetChanged){var restrictedFacetCount=0;for(var i=0;i<this._facets.length;i++){if(this._facets[i].hasRestrictions()){restrictedFacetCount++;}}
for(var i=0;i<this._facets.length;i++){var facet=this._facets[i];if(facet.hasRestrictions()){if(restrictedFacetCount<=1){facet.update(this.getAllItems());}else{var items=this.getAllItems();for(var j=0;j<this._facets.length;j++){if(i!=j){items=this._facets[j].restrict(items);}}
facet.update(items);}}else{facet.update(this.getRestrictedItems());}}};Exhibit.Collection.prototype._computeRestrictedItems=function(){this._restrictedItems=this._items;for(var i=0;i<this._facets.length;i++){var facet=this._facets[i];if(facet.hasRestrictions()){this._restrictedItems=facet.restrict(this._restrictedItems);}}};

/* component.js */

Exhibit.Component={};Exhibit.Component.create=function(configuration,elmt,exhibit){var role=configuration.role;if(role=="exhibit-lens"){Exhibit.Component.registerLens(configuration,exhibit.getLensRegistry());return null;}else if(role=="exhibit-view"){return Exhibit.Component.createView(configuration,elmt,exhibit.getLensRegistry(),exhibit);}else if(role=="exhibit-facet"){return Exhibit.Component.createFacet(configuration,elmt,exhibit);}else if(role=="exhibit-viewPanel"){return Exhibit.ViewPanel.create(configuration,elmt,exhibit);}else if(role=="exhibit-logo"){return Exhibit.Logo.create(configuration,elmt,exhibit);}else if(role=="exhibit-hiddenContent"){elmt.style.display="none";return null;}else{return null;}};Exhibit.Component.createFromDOM=function(elmt,exhibit){var role=Exhibit.getAttribute(elmt,"role");if(role=="exhibit-lens"){Exhibit.Component.registerLensFromDOM(elmt,exhibit.getLensRegistry());return null;}else if(role=="exhibit-view"){return Exhibit.Component.createViewFromDOM(elmt,null,exhibit.getLensRegistry(),exhibit);}else if(role=="exhibit-facet"){return Exhibit.Component.createFacetFromDOM(elmt,null,exhibit);}else if(role=="exhibit-viewPanel"){return Exhibit.ViewPanel.createFromDOM(elmt,exhibit);}else if(role=="exhibit-logo"){return Exhibit.Logo.createFromDOM(elmt,exhibit);}else if(role=="exhibit-hiddenContent"){elmt.style.display="none";return null;}else{return null;}};Exhibit.Component.createView=function(configuration,elmt,lensRegistry,exhibit){var viewClass="viewClass"in configuration?configuration.viewClass:Exhibit.TileView;return viewClass.create(configuration,elmt,lensRegistry,exhibit);};Exhibit.Component.createViewFromDOM=function(elmt,container,lensRegistry,exhibit){var viewClassString=Exhibit.getAttribute(elmt,"viewClass");var viewClass=null;try{viewClass=eval(viewClassString);}catch(e){viewClass=Exhibit.TileView;}
return viewClass.createFromDOM(elmt,container,lensRegistry,exhibit);};Exhibit.Component.createFacet=function(configuration,elmt,exhibit){var facetClass="facetClass"in configuration?configuration.facetClass:Exhibit.ListFacet;return facetClass.create(configuration,elmt,container,exhibit);};Exhibit.Component.createFacetFromDOM=function(elmt,container,exhibit){var facetClassString=Exhibit.getAttribute(elmt,"facetClass");var facetClass=Exhibit.ListFacet;if(facetClassString!=null&&facetClassString.length>0){facetClass=eval(facetClassString);}
return facetClass.createFromDOM(elmt,container,exhibit);};Exhibit.Component.registerLens=function(configuration,lensRegistry){var template=configuration.templateFile;if(template!=null){if("itemTypes"in configuration){for(var i=0;i<configuration.itemTypes.length;i++){lensRegistry.registerLensForType(template,configuration.itemTypes[i]);}}else{lensRegistry.registerDefaultLens(template);}}};Exhibit.Component.registerLensFromDOM=function(elmt,lensRegistry){var itemTypes=Exhibit.getAttribute(elmt,"itemTypes",",");var template=null;var url=Exhibit.getAttribute(elmt,"templateFile");if(url!=null&&url.length>0){template=url;}else{var id=Exhibit.getAttribute(elmt,"template");var elmt2=document.getElementById(id);if(elmt2!=null){template=elmt2;}else{template=elmt;}}
if(template!=null){if(itemTypes==null||itemTypes.length==0){lensRegistry.registerDefaultLens(template);}else{for(var i=0;i<itemTypes.length;i++){lensRegistry.registerLensForType(template,itemTypes[i]);}}}};Exhibit.Component.registerLenses=function(configuration,lensRegistry){if("lenses"in configuration){for(var i=0;i<configuration.lenses.length;i++){Exhibit.Component.registerLens(configuration.lenses[i],lensRegistry);}}
if("lensSelector"in configuration){var lensSelector=configuration.lensSelector;if(typeof lensSelector=="function"){lensRegistry.addLensSelector(lensSelector);}else{SimileAjax.Debug.log("lensSelector is not a function");}}};Exhibit.Component.registerLensesFromDOM=function(parentNode,lensRegistry){var node=parentNode.firstChild;while(node!=null){if(node.nodeType==1){var role=Exhibit.getAttribute(node,"role");if(role=="exhibit-lens"){Exhibit.Component.registerLensFromDOM(node,lensRegistry);}}
node=node.nextSibling;}
var lensSelectorString=Exhibit.getAttribute(parentNode,"lensSelector");if(lensSelectorString!=null&&lensSelectorString.length>0){try{var lensSelector=eval(lensSelectorString);if(typeof lensSelector=="function"){lensRegistry.addLensSelector(lensSelector);}else{SimileAjax.Debug.log("lensSelector expression "+lensSelectorString+" is not a function");}}catch(e){SimileAjax.Debug.exception("Bad lensSelector expression: "+lensSelectorString,e);}}};Exhibit.Component.createLensRegistry=function(configuration,parentLensRegistry){var lensRegistry=new Exhibit.LensRegistry(parentLensRegistry);Exhibit.Component.registerLenses(configuration,lensRegistry);return lensRegistry;};Exhibit.Component.createLensRegistryFromDOM=function(parentNode,configuration,parentLensRegistry){var lensRegistry=new Exhibit.LensRegistry(parentLensRegistry);Exhibit.Component.registerLensesFromDOM(parentNode,lensRegistry);Exhibit.Component.registerLenses(configuration,lensRegistry);return lensRegistry;};

/* create.js */

(function(){if(document.body==null&&window.onload==null){var f=function(){if(document.body.onload==null||document.body.onload==f){var fDone=function(){window.exhibit=Exhibit.create();window.exhibit.configureFromDOM();};try{var s=Exhibit.getAttribute(document.body,"ondataload");if(s!=null&&typeof s=="string"&&s.length>0){fDone=function(){var f=eval(s);if(typeof f=="function"){f.call();}}}}catch(e){}
window.database=Exhibit.Database.create();window.database.loadDataLinks(fDone);}};window.onload=f;}})();

/* database.js */

Exhibit.Database=new Object();Exhibit.Database.create=function(){return new Exhibit.Database._Impl();};Exhibit.Database._Impl=function(){this._types={};this._properties={};this._propertyArray={};this._listeners=new SimileAjax.ListenerQueue();this._spo={};this._ops={};this._items=new Exhibit.Set();var l10n=Exhibit.Database.l10n;var itemType=new Exhibit.Database._Type("Item");itemType._uri="http://simile.mit.edu/2006/11/exhibit#Item";itemType._label=l10n.itemType.label;itemType._pluralLabel=l10n.itemType.pluralLabel;this._types["Item"]=itemType;var labelProperty=new Exhibit.Database._Property("label");labelProperty._uri="http://www.w3.org/2000/01/rdf-schema#label";labelProperty._valueType="text";labelProperty._label=l10n.labelProperty.label;labelProperty._pluralLabel=l10n.labelProperty.pluralLabel;labelProperty._reverseLabel=l10n.labelProperty.reverseLabel;labelProperty._reversePluralLabel=l10n.labelProperty.reversePluralLabel;labelProperty._groupingLabel=l10n.labelProperty.groupingLabel;labelProperty._reverseGroupingLabel=l10n.labelProperty.reverseGroupingLabel;this._properties["label"]=labelProperty;var typeProperty=new Exhibit.Database._Property("type");typeProperty._uri="http://www.w3.org/1999/02/22-rdf-syntax-ns#type";typeProperty._valueType="text";typeProperty._label="type";typeProperty._pluralLabel=l10n.typeProperty.label;typeProperty._reverseLabel=l10n.typeProperty.reverseLabel;typeProperty._reversePluralLabel=l10n.typeProperty.reversePluralLabel;typeProperty._groupingLabel=l10n.typeProperty.groupingLabel;typeProperty._reverseGroupingLabel=l10n.typeProperty.reverseGroupingLabel;this._properties["type"]=typeProperty;var uriProperty=new Exhibit.Database._Property("uri");uriProperty._uri="http://simile.mit.edu/2006/11/exhibit#uri";uriProperty._valueType="url";uriProperty._label="URI";uriProperty._pluralLabel="URIs";uriProperty._reverseLabel="URI of";uriProperty._reversePluralLabel="URIs of";uriProperty._groupingLabel="URIs";uriProperty._reverseGroupingLabel="things named by these URIs";this._properties["uri"]=uriProperty;};Exhibit.Database._Impl.prototype.createDatabase=function(){return Exhibit.Database.create();};Exhibit.Database._Impl.prototype.addListener=function(listener){this._listeners.add(listener);};Exhibit.Database._Impl.prototype.removeListener=function(listener){this._listeners.remove(listener);};Exhibit.Database._Impl.prototype.loadDataLinks=function(fDone){var links=[];var heads=document.documentElement.getElementsByTagName("head");for(var h=0;h<heads.length;h++){var linkElmts=heads[h].getElementsByTagName("link");for(var l=0;l<linkElmts.length;l++){var link=linkElmts[l];if(link.rel=="exhibit/data"){links.push(link);}}}
this._loadLinks(links,fDone);};Exhibit.Database._Impl.prototype._loadLinks=function(links,fDone){links=[].concat(links);var database=this;var fNext=function(){while(links.length>0){var link=links.shift();var importer=Exhibit.importers[link.type];if(importer){try{importer.load(link,database,fNext);return;}catch(e){SimileAjax.Debug.log("Error using importer for data of type "+link.type);}}else{SimileAjax.Debug.log("No importer for data of type "+link.type);}}
if(fDone!=null){fDone();}};fNext();};Exhibit.Database._Impl.prototype.loadData=function(o,baseURI){if("types"in o){this.loadTypes(o.types,baseURI);}
if("properties"in o){this.loadProperties(o.properties,baseURI);}
if("items"in o){this.loadItems(o.items,baseURI);}};Exhibit.Database._Impl.prototype.loadTypes=function(typeEntries,baseURI){this._listeners.fire("onBeforeLoadingTypes",[]);try{var lastChar=baseURI.substr(baseURI.length-1)
if(lastChar=="#"){baseURI=baseURI.substr(0,baseURI.length-1)+"/";}else if(lastChar!="/"&&lastChar!=":"){baseURI+="/";}
for(var typeID in typeEntries){if(typeID!=undefined&&typeID!=null){var typeEntry=typeEntries[typeID];var type;if(typeID in this._types){type=this._types[typeID];}else{type=new Exhibit.Database._Type(typeID);this._types[typeID]=type;};type._uri=("uri"in typeEntry)?typeEntry.uri:(baseURI+"type#"+encodeURIComponent(typeID));type._label=("label"in typeEntry)?typeEntry.label:typeID;type._pluralLabel=("pluralLabel"in typeEntry)?typeEntry.pluralLabel:type._label;if("origin"in typeEntry){type._origin=typeEntry.origin;}}}
this._listeners.fire("onAfterLoadingTypes",[]);}catch(e){SimileAjax.Debug.exception("Database.loadTypes failed",e);}};Exhibit.Database._Impl.prototype.loadProperties=function(propertyEntries,baseURI){this._listeners.fire("onBeforeLoadingProperties",[]);try{var lastChar=baseURI.substr(baseURI.length-1)
if(lastChar=="#"){baseURI=baseURI.substr(0,baseURI.length-1)+"/";}else if(lastChar!="/"&&lastChar!=":"){baseURI+="/";}
for(var propertyID in propertyEntries){var propertyEntry=propertyEntries[propertyID];var property;if(propertyID in this._properties){property=this._properties[propertyID];}else{property=new Exhibit.Database._Property(propertyID,this);this._properties[propertyID]=property;};property._uri=("uri"in propertyEntry)?propertyEntry.uri:(baseURI+"property#"+encodeURIComponent(propertyID));property._valueType=("valueType"in propertyEntry)?propertyEntry.valueType:"text";property._label=("label"in propertyEntry)?propertyEntry.label:propertyID;property._pluralLabel=("pluralLabel"in propertyEntry)?propertyEntry.pluralLabel:property._label;property._reverseLabel=("reverseLabel"in propertyEntry)?propertyEntry.reverseLabel:("!"+property._label);property._reversePluralLabel=("reversePluralLabel"in propertyEntry)?propertyEntry.reversePluralLabel:("!"+property._pluralLabel);property._groupingLabel=("groupingLabel"in propertyEntry)?propertyEntry.groupingLabel:property._label;property._reverseGroupingLabel=("reverseGroupingLabel"in propertyEntry)?propertyEntry.reverseGroupingLabel:property._reverseLabel;if("origin"in propertyEntry){property._origin=propertyEntry.origin;}}
this._propertyArray=null;this._listeners.fire("onAfterLoadingProperties",[]);}catch(e){SimileAjax.Debug.exception("Database.loadProperties failed",e);}};Exhibit.Database._Impl.prototype.loadItems=function(itemEntries,baseURI){this._listeners.fire("onBeforeLoadingItems",[]);try{var lastChar=baseURI.substr(baseURI.length-1);if(lastChar=="#"){baseURI=baseURI.substr(0,baseURI.length-1)+"/";}else if(lastChar!="/"&&lastChar!=":"){baseURI+="/";}
var spo=this._spo;var ops=this._ops;var indexPut=Exhibit.Database._indexPut;var indexTriple=function(s,p,o){indexPut(spo,s,p,o);indexPut(ops,o,p,s);};for(var i=0;i<itemEntries.length;i++){var entry=itemEntries[i];if(entry!=null&&typeof entry!="undefined"){this._loadItem(entry,indexTriple,baseURI);}}
this._propertyArray=null;this._listeners.fire("onAfterLoadingItems",[]);}catch(e){SimileAjax.Debug.exception("Database.loadItems failed",e);}};Exhibit.Database._Impl.prototype.getType=function(typeID){return this._types[typeID];};Exhibit.Database._Impl.prototype.getProperty=function(propertyID){return propertyID in this._properties?this._properties[propertyID]:null;};Exhibit.Database._Impl.prototype.getAllProperties=function(){if(this._propertyArray==null){this._propertyArray=[];for(var propertyID in this._properties){this._propertyArray.push(propertyID);}}
return[].concat(this._propertyArray);};Exhibit.Database._Impl.prototype.getAllItems=function(){var items=new Exhibit.Set();items.addSet(this._items);return items;};Exhibit.Database._Impl.prototype.getAllItemsCount=function(){return this._items.size();};Exhibit.Database._Impl.prototype.containsItem=function(itemID){return this._items.contains(itemID);};Exhibit.Database._Impl.prototype.getNamespaces=function(idToQualifiedName,prefixToBase){var bases={};for(var propertyID in this._properties){var property=this._properties[propertyID];var uri=property.getURI();var hash=uri.indexOf("#");if(hash>0){var base=uri.substr(0,hash+1);bases[base]=true;idToQualifiedName[propertyID]={base:base,localName:uri.substr(hash+1)};continue;}
var slash=uri.lastIndexOf("/");if(slash>0){var base=uri.substr(0,slash+1);bases[base]=true;idToQualifiedName[propertyID]={base:base,localName:uri.substr(slash+1)};continue;}}
var baseToPrefix={};var letters="abcdefghijklmnopqrstuvwxyz";var i=0;for(var base in bases){var prefix=letters.substr(i++,1);prefixToBase[prefix]=base;baseToPrefix[base]=prefix;}
for(var propertyID in idToQualifiedName){var qname=idToQualifiedName[propertyID];qname.prefix=baseToPrefix[qname.base];}};Exhibit.Database._Impl.prototype._loadItem=function(itemEntry,indexFunction,baseURI){if(!("label"in itemEntry)&&!("id"in itemEntry)){SimileAjax.Debug.warn("Item entry has no label and no id: "+itemEntry);return;}
var id;if(!("label"in itemEntry)){id=itemEntry.id;if(!this._items.contains(id)){SimileAjax.Debug.warn("Cannot add new item containing no label: "+itemEntry);}}else{var label=itemEntry.label;var id=("id"in itemEntry)?itemEntry.id:label;var uri=("uri"in itemEntry)?itemEntry.uri:(baseURI+"item#"+encodeURIComponent(id));var type=("type"in itemEntry)?itemEntry.type:"Item";this._items.add(id);indexFunction(id,"uri",uri);indexFunction(id,"label",label);indexFunction(id,"type",type);this._ensureTypeExists(type,baseURI);}
for(var p in itemEntry){if(p!="uri"&&p!="label"&&p!="id"&&p!="type"){this._ensurePropertyExists(p,baseURI)._onNewData();var v=itemEntry[p];if(v instanceof Array){for(var j=0;j<v.length;j++){indexFunction(id,p,v[j]);}}else{indexFunction(id,p,v);}}}};Exhibit.Database._Impl.prototype._ensureTypeExists=function(typeID,baseURI){if(!(typeID in this._types)){var type=new Exhibit.Database._Type(typeID);type._uri=baseURI+"type#"+encodeURIComponent(typeID);type._label=typeID;type._pluralLabel=type._label;this._types[typeID]=type;}};Exhibit.Database._Impl.prototype._ensurePropertyExists=function(propertyID,baseURI){if(!(propertyID in this._properties)){var property=new Exhibit.Database._Property(propertyID);property._uri=baseURI+"property#"+encodeURIComponent(propertyID);property._valueType="text";property._label=propertyID;property._pluralLabel=property._label;property._reverseLabel="reverse of "+property._label;property._reversePluralLabel="reverse of "+property._pluralLabel;property._groupingLabel=property._label;property._reverseGroupingLabel=property._reverseLabel;this._properties[propertyID]=property;return property;}else{return this._properties[propertyID];}};Exhibit.Database._indexPut=function(index,x,y,z){var hash=index[x];if(!hash){hash={};index[x]=hash;}
var array=hash[y];if(!array){array=new Array();hash[y]=array;}else{for(var i=0;i<array.length;i++){if(z==array[i]){return;}}}
array.push(z);};Exhibit.Database._indexPutList=function(index,x,y,list){var hash=index[x];if(!hash){hash={};index[x]=hash;}
var array=hash[y];if(!array){hash[y]=list;}else{hash[y]=hash[y].concat(list);}};Exhibit.Database._Impl.prototype._indexFillSet=function(index,x,y,set,filter){var hash=index[x];if(hash){var array=hash[y];if(array){if(filter){for(var i=0;i<array.length;i++){var z=array[i];if(filter.contains(z)){set.add(z);}}}else{for(var i=0;i<array.length;i++){set.add(array[i]);}}}}};Exhibit.Database._Impl.prototype._indexCountDistinct=function(index,x,y,filter){var count=0;var hash=index[x];if(hash){var array=hash[y];if(array){if(filter){for(var i=0;i<array.length;i++){if(filter.contains(array[i])){count++;}}}else{count=array.length;}}}
return count;};Exhibit.Database._Impl.prototype._get=function(index,x,y,set,filter){if(!set){set=new Exhibit.Set();}
this._indexFillSet(index,x,y,set,filter);return set;};Exhibit.Database._Impl.prototype._getUnion=function(index,xSet,y,set,filter){if(!set){set=new Exhibit.Set();}
var database=this;xSet.visit(function(x){database._indexFillSet(index,x,y,set,filter);});return set;};Exhibit.Database._Impl.prototype._countDistinctUnion=function(index,xSet,y,filter){var count=0;var database=this;xSet.visit(function(x){count+=database._indexCountDistinct(index,x,y,filter);});return count;};Exhibit.Database._Impl.prototype._countDistinct=function(index,x,y,filter){return this._indexCountDistinct(index,x,y,filter);};Exhibit.Database._Impl.prototype._getProperties=function(index,x){var hash=index[x];var properties=[]
if(hash){for(var p in hash){properties.push(p);}}
return properties;};Exhibit.Database._Impl.prototype.getObjects=function(s,p,set,filter){return this._get(this._spo,s,p,set,filter);};Exhibit.Database._Impl.prototype.countDistinctObjects=function(s,p,filter){return this._countDistinct(this._spo,s,p,filter);};Exhibit.Database._Impl.prototype.getObjectsUnion=function(subjects,p,set,filter){return this._getUnion(this._spo,subjects,p,set,filter);};Exhibit.Database._Impl.prototype.countDistinctObjectsUnion=function(subjects,p,filter){return this._countDistinctUnion(this._spo,subjects,p,filter);};Exhibit.Database._Impl.prototype.getSubjects=function(o,p,set,filter){return this._get(this._ops,o,p,set,filter);};Exhibit.Database._Impl.prototype.countDistinctSubjects=function(o,p,filter){return this._countDistinct(this._ops,o,p,filter);};Exhibit.Database._Impl.prototype.getSubjectsUnion=function(objects,p,set,filter){return this._getUnion(this._ops,objects,p,set,filter);};Exhibit.Database._Impl.prototype.countDistinctSubjectsUnion=function(objects,p,filter){return this._countDistinctUnion(this._ops,objects,p,filter);};Exhibit.Database._Impl.prototype.getObject=function(s,p){var hash=this._spo[s];if(hash){var array=hash[p];if(array){return array[0];}}
return null;};Exhibit.Database._Impl.prototype.getSubject=function(o,p){var hash=this._ops[o];if(hash){var array=hash[p];if(array){return array[0];}}
return null;};Exhibit.Database._Impl.prototype.getForwardProperties=function(s){return this._getProperties(this._spo,s);};Exhibit.Database._Impl.prototype.getBackwardProperties=function(o){return this._getProperties(this._ops,o);};Exhibit.Database._Impl.prototype.getSubjectsInRange=function(p,min,max,inclusive,set,filter){if(!set){set=new Exhibit.Set();}
var property=this.getProperty(p);if(property!=null){var rangeIndex=property.getRangeIndex();if(rangeIndex!=null){var f=(filter!=null)?function(item){if(filter.contains(item)){set.add(item);}}:function(item){set.add(item);};rangeIndex.getRange(f,min,max,inclusive);}}
return set;};Exhibit.Database._Impl.prototype.getTypeLabels=function(set){var typeIDSet=this.getObjectsUnion(set,"type",null,null);var labels=[];var pluralLabels=[];var database=this;typeIDSet.visit(function(typeID){var type=database.getType(typeID);if(type!=null){labels.push(type.getLabel());pluralLabels.push(type.getPluralLabel());}});return[labels,pluralLabels];};Exhibit.Database._Type=function(id){this._id=id;};Exhibit.Database._Type.prototype={getID:function(){return this._id;},getURI:function(){return this._uri;},getLabel:function(){return this._label;},getPluralLabel:function(){return this._pluralLabel;},getSuperTypeID:function(){return this._superTypeID;},getOrigin:function(){return this._origin;}};Exhibit.Database._Property=function(id,database){this._id=id;this._database=database;this._rangeIndex=null;};Exhibit.Database._Property.prototype={getID:function(){return this._id;},getURI:function(){return this._uri;},getValueType:function(){return this._valueType;},getLabel:function(){return this._label;},getPluralLabel:function(){return this._pluralLabel;},getReverseLabel:function(){return this._reverseLabel;},getReversePluralLabel:function(){return this._reversePluralLabel;},getGroupingLabel:function(){return this._groupingLabel;},getGroupingPluralLabel:function(){return this._groupingPluralLabel;},getOrigin:function(){return this._origin;}};Exhibit.Database._Property.prototype._onNewData=function(){this._rangeIndex=null;};Exhibit.Database._Property.prototype.getRangeIndex=function(){if(this._rangeIndex==null){this._buildRangeIndex();}
return this._rangeIndex;};Exhibit.Database._Property.prototype._buildRangeIndex=function(){var getter;var database=this._database;var p=this._id;switch(this.getValueType()){case"number":getter=function(item,f){database.getObjects(item,p,null,null).visit(function(value){if(typeof value!="number"){value=parseFloat(value);}
if(!isNaN(value)){f(value);}});};break;case"date":getter=function(item,f){database.getObjects(item,p,null,null).visit(function(value){if(value!=null&&!(value instanceof Date)){value=SimileAjax.DateTime.parseIso8601DateTime(value);}
if(value instanceof Date){f(value.getTime());}});};break;default:getter=function(item,f){};}
this._rangeIndex=new Exhibit.Database._RangeIndex(this._database.getAllItems(),getter);};Exhibit.Database._RangeIndex=function(items,getter){pairs=[];items.visit(function(item){getter(item,function(value){pairs.push({item:item,value:value});});});pairs.sort(function(p1,p2){var c=p1.value-p2.value;return c!=0?c:p1.item.localeCompare(p2.item);});this._pairs=pairs;};Exhibit.Database._RangeIndex.prototype.getCount=function(){return this._pairs.count();};Exhibit.Database._RangeIndex.prototype.getMin=function(){return this._pairs.length>0?this._pairs[0].value:Number.POSITIVE_INFINITY;};Exhibit.Database._RangeIndex.prototype.getMax=function(){return this._pairs.length>0?this._pairs[this._pairs.length-1].value:Number.NEGATIVE_INFINITY;};Exhibit.Database._RangeIndex.prototype.getRange=function(visitor,min,max,inclusive){var startIndex=this._indexOf(min);var pairs=this._pairs;var l=pairs.length;inclusive=(inclusive);while(startIndex<l){var pair=pairs[startIndex++];var value=pair.value;if(value<max||(value==max&&inclusive)){visitor(pair.item);}else{break;}}};Exhibit.Database._RangeIndex.prototype.countRange=function(min,max,inclusive){var startIndex=this._indexOf(min);var endIndex=this._indexOf(max);if(inclusive){var pairs=this._pairs;var l=pairs.length;while(endIndex<l){if(pairs[endIndex].value==max){endIndex++;}else{break;}}}
return endIndex-startIndex;};Exhibit.Database._RangeIndex.prototype._indexOf=function(v){var pairs=this._pairs;if(pairs.length==0||pairs[0]==v){return 0;}
var from=0;var to=pairs.length;while(from+1<to){var middle=(from+to)>>1;var v2=pairs[middle].value;if(v2>=v){to=middle;}else{from=middle;}}
return to;};

/* exhibit.js */

Exhibit.create=function(database){return new Exhibit._Impl(database);};Exhibit.getAttribute=function(elmt,name,splitOn){try{var value=elmt.getAttribute(name);if(value==null){value=elmt.getAttribute("ex:"+name);}
if(splitOn==null){return value;}
var values=value.split(splitOn);for(var i=0;value=values[i];i++){values[i]=value.trim();}
return values;}catch(e){return null;}};Exhibit.getConfigurationFromDOM=function(elmt){var c=Exhibit.getAttribute(elmt,"configuration");if(c!=null&&c.length>0){try{var o=eval(c);if(typeof o=="object"){return o;}}catch(e){}}
return{};};Exhibit.getExporters=function(){Exhibit._initializeExporters();return[].concat(Exhibit._exporters);};Exhibit.addExporters=function(exporter){Exhibit._initializeExporters();Exhibit._exporters.push(exporter);};Exhibit._initializeExporters=function(){if(!("_exporters"in Exhibit)){Exhibit._exporters=[Exhibit.RdfXmlExporter,Exhibit.SemanticWikitextExporter,Exhibit.TSVExporter,Exhibit.ExhibitJsonExporter];}};Exhibit._Impl=function(database){this._database=database!=null?database:("database"in window?window.database:Exhibit.Database.create());this._collectionMap={};this._componentMap={};this._lensRegistry=new Exhibit.LensRegistry();var self=this;this._focusID=null;this._databaseListener={onAfterLoadingItems:function(){}};this._database.addListener(this._databaseListener);this._historyListener={onBeforePerform:function(action){if(action.lengthy){Exhibit.UI.showBusyIndicator();}},onAfterPerform:function(action){if(action.lengthy){Exhibit.UI.hideBusyIndicator();}},onBeforeUndoSeveral:function(){Exhibit.UI.showBusyIndicator();},onAfterUndoSeveral:function(){Exhibit.UI.hideBusyIndicator();},onBeforeRedoSeveral:function(){Exhibit.UI.showBusyIndicator();},onAfterRedoSeveral:function(){Exhibit.UI.hideBusyIndicator();}};SimileAjax.History.addListener(this._historyListener);var hash=document.location.hash;if(hash.length>1){this._focusID=decodeURIComponent(hash.substr(1));}};Exhibit._Impl.prototype.dispose=function(){SimileAjax.History.removeListener(this._historyListener);this._database.removeListener(this._databaseListener);for(var id in this._componentMap){try{this._componentMap[id].dispose();}catch(e){SimileAjax.Debug.exception("Failed to dispose component",e);}}
for(var id in this._collectionMap){try{this._collectionMap[id].dispose();}catch(e){SimileAjax.Debug.exception("Failed to dispose collection",e);}}
this._database=null;};Exhibit._Impl.prototype.getDatabase=function(){return this._database;};Exhibit._Impl.prototype.getLensRegistry=function(){return this._lensRegistry;};Exhibit._Impl.prototype.getCollection=function(id){var collection=this._collectionMap[id];if(collection==null&&id=="default"){collection=Exhibit.Collection.createAllItemsCollection(this._database);this.setDefaultCollection(collection);}
return collection;};Exhibit._Impl.prototype.getDefaultCollection=function(){return this.getCollection("default");};Exhibit._Impl.prototype.setCollection=function(id,c){if(id in this._collectionMap){try{this._collectionMap[id].dispose();}catch(e){SimileAjax.Debug.exception(e);}}
this._collectionMap[id]=c;};Exhibit._Impl.prototype.setDefaultCollection=function(c){this.setCollection("default",c);};Exhibit._Impl.prototype.getComponent=function(id){return this._componentMap[id];};Exhibit._Impl.prototype.setComponent=function(id,c){if(id in this._componentMap){try{this._componentMap[id].dispose();}catch(e){SimileAjax.Debug.exception(e);}}
this._componentMap[id]=c;};Exhibit._Impl.prototype.configure=function(configuration){if("collections"in configuration){for(var i=0;i<configuration.collections.length;i++){var config=configuration.collections[i];var id=config.id;if(id==null||id.length==0){id="default";}
this.setCollection(id,Exhibit.Collection.create(config,this.getDatabase()));}}
if("components"in configuration){for(var i=0;i<configuration.components.length;i++){var config=configuration.components[i];var component=Exhibit.Component.create(config,this);if(component!=null){var id=elmt.id;if(id==null||id.length==0){id="component"+Math.floor(Math.random()*1000000);}
this.setComponent(id,component);}}}};Exhibit._Impl.prototype.configureFromDOM=function(){var collectionElmts=[];var componentElmts=[];var f=function(elmt){var role=Exhibit.getAttribute(elmt,"role");if(role!=null&&role.length>0){if(role=="exhibit-collection"){collectionElmts.push(elmt);}else{componentElmts.push(elmt);}}else{var node=elmt.firstChild;while(node!=null){if(node.nodeType==1){f(node);}
node=node.nextSibling;}}};f(document.body);for(var i=0;i<collectionElmts.length;i++){var elmt=collectionElmts[i];var id=elmt.id;if(id==null||id.length==0){id="default";}
this.setCollection(id,Exhibit.Collection.createFromDOM(elmt,this.getDatabase()));}
for(var i=0;i<componentElmts.length;i++){var elmt=componentElmts[i];var component=Exhibit.Component.createFromDOM(elmt,this);if(component!=null){var id=elmt.id;if(id==null||id.length==0){id="component"+Math.floor(Math.random()*1000000);}
this.setComponent(id,component);}}};

/* bibtex-exporter.js */

Exhibit.BibtexExporter={getLabel:function(){return"Bibtex";},_excludeProperties:{"pub-type":true,"type":true,"uri":true,"key":true}};Exhibit.BibtexExporter.exportOne=function(itemID,database){return Exhibit.BibtexExporter._wrap(Exhibit.BibtexExporter._exportOne(itemID,database));};Exhibit.BibtexExporter.exportMany=function(set,database){var s="";set.visit(function(itemID){s+=Exhibit.BibtexExporter._exportOne(itemID,database)+"\n";});return Exhibit.BibtexExporter._wrap(s);};Exhibit.BibtexExporter._exportOne=function(itemID,database){var s="";var type=database.getObject(itemID,"pub-type");var key=database.getObject(itemID,"key");s+="@"+type+"{"+(key!=null?key:itemID)+"\n";var allProperties=database.getAllProperties();for(var i=0;i<allProperties.length;i++){var propertyID=allProperties[i];var property=database.getProperty(propertyID);var values=database.getObjects(itemID,propertyID);var valueType=property.getValueType();if(values.size()>0&&!(propertyID in Exhibit.BibtexExporter._excludeProperties)){s+="\t"+(propertyID=="label"?"title":propertyID)+" = \"";var strings;if(valueType=="item"){strings=[];values.visit(function(value){strings.push(database.getObject(value,"label"));});}else{if(valueType=="url"){strings=[];values.visit(function(value){strings.push(Exhibit.Persistence.resolveURL(value));});}else{strings=values.toArray();}}
s+=strings.join(" and ")+"\",\n";}}
s+="\torigin = \""+Exhibit.Persistence.getItemLink(itemID)+"\"\n";s+="}\n";return s;};Exhibit.BibtexExporter._wrap=function(s){return s;}

/* exhibit-json-exporter.js */

Exhibit.ExhibitJsonExporter={getLabel:function(){return Exhibit.l10n.exhibitJsonExporterLabel;}};Exhibit.ExhibitJsonExporter.exportOne=function(itemID,database){return Exhibit.ExhibitJsonExporter._wrap(Exhibit.ExhibitJsonExporter._exportOne(itemID,database)+"\n");};Exhibit.ExhibitJsonExporter.exportMany=function(set,database){var s="";var size=set.size();var count=0;set.visit(function(itemID){s+=Exhibit.ExhibitJsonExporter._exportOne(itemID,database)+((count++<size-1)?",\n":"\n");});return Exhibit.ExhibitJsonExporter._wrap(s);};Exhibit.ExhibitJsonExporter._exportOne=function(itemID,database){var s="";var uri=database.getObject(itemID,"uri");s+="\t\t{\tid: \""+itemID+"\",\n";var allProperties=database.getAllProperties();for(var i=0;i<allProperties.length;i++){var propertyID=allProperties[i];var property=database.getProperty(propertyID);var values=database.getObjects(itemID,propertyID);var valueType=property.getValueType();if(values.size()>0){var array;if(valueType=="url"){array=[];values.visit(function(value){array.push(Exhibit.Persistence.resolveURL(value));});}else{array=values.toArray();}
s+="\t\t\t"+propertyID+":\t";if(array.length==1){s+="\""+array[0]+"\"";}else{s+="[ ";for(var j=0;j<array.length;j++){s+=(j>0?", ":"")+"\""+array[j]+"\"";}
s+=" ]";}
s+=",\n";}}
s+="\t\t\torigin: \""+Exhibit.Persistence.getItemLink(itemID)+"\"\n";s+="\t\t}";return s;};Exhibit.ExhibitJsonExporter._wrap=function(s){return"{\n"+"\titems: [\n"+
s+"\t]\n"+"}";}

/* rdf-xml-exporter.js */

Exhibit.RdfXmlExporter={getLabel:function(){return Exhibit.l10n.rdfXmlExporterLabel;}};Exhibit.RdfXmlExporter.exportOne=function(itemID,database){var propertyIDToQualifiedName={};var prefixToBase={};database.getNamespaces(propertyIDToQualifiedName,prefixToBase);return Exhibit.RdfXmlExporter._wrapRdf(Exhibit.RdfXmlExporter._exportOne(itemID,database,propertyIDToQualifiedName,prefixToBase),prefixToBase);};Exhibit.RdfXmlExporter.exportMany=function(set,database){var s="";var propertyIDToQualifiedName={};var prefixToBase={};database.getNamespaces(propertyIDToQualifiedName,prefixToBase);set.visit(function(itemID){s+=Exhibit.RdfXmlExporter._exportOne(itemID,database,propertyIDToQualifiedName,prefixToBase)+"\n";});return Exhibit.RdfXmlExporter._wrapRdf(s,prefixToBase);};Exhibit.RdfXmlExporter._exportOne=function(itemID,database,propertyIDToQualifiedName,prefixToBase){var s="";var uri=database.getObject(itemID,"uri");s+="<rdf:Description rdf:about='"+uri+"'>\n"
var allProperties=database.getAllProperties();for(var i=0;i<allProperties.length;i++){var propertyID=allProperties[i];var property=database.getProperty(propertyID);var values=database.getObjects(itemID,propertyID);var valueType=property.getValueType();var propertyString;if(propertyID in propertyIDToQualifiedName){var qname=propertyIDToQualifiedName[propertyID];propertyString=qname.prefix+":"+qname.localName;}else{propertyString=property.getURI();}
if(valueType=="item"){values.visit(function(value){s+="\t<"+propertyString+" rdf:resource='"+value+"' />\n";});}else if(propertyID!="uri"){if(valueType=="url"){values.visit(function(value){s+="\t<"+propertyString+">"+Exhibit.Persistence.resolveURL(value)+"</"+propertyString+">\n";});}else{values.visit(function(value){s+="\t<"+propertyString+">"+value+"</"+propertyString+">\n";});}}}
s+="\t<exhibit:origin>"+Exhibit.Persistence.getItemLink(itemID)+"</exhibit:origin>\n";s+="</rdf:Description>";return s;};Exhibit.RdfXmlExporter._wrapRdf=function(s,prefixToBase){var s2="<?xml version='1.0'?>\n"+"<rdf:RDF xmlns:rdf='http://www.w3.org/1999/02/22-rdf-syntax-ns#'\n"+"\txmlns:exhibit='http://simile.mit.edu/2006/11/exhibit#'";for(prefix in prefixToBase){s2+="\n\txmlns:"+prefix+"='"+prefixToBase[prefix]+"'";}
s2+=">\n"+s+"\n</rdf:RDF>";return s2;}

/* semantic-wikitext-exporter.js */

Exhibit.SemanticWikitextExporter={getLabel:function(){return Exhibit.l10n.smwExporterLabel;}};Exhibit.SemanticWikitextExporter.exportOne=function(itemID,database){return Exhibit.SemanticWikitextExporter._wrap(Exhibit.SemanticWikitextExporter._exportOne(itemID,database));};Exhibit.SemanticWikitextExporter.exportMany=function(set,database){var s="";set.visit(function(itemID){s+=Exhibit.SemanticWikitextExporter._exportOne(itemID,database)+"\n";});return Exhibit.SemanticWikitextExporter._wrap(s);};Exhibit.SemanticWikitextExporter._exportOne=function(itemID,database){var s="";var uri=database.getObject(itemID,"uri");s+=uri+"\n"
var allProperties=database.getAllProperties();for(var i=0;i<allProperties.length;i++){var propertyID=allProperties[i];var property=database.getProperty(propertyID);var values=database.getObjects(itemID,propertyID);var valueType=property.getValueType();if(valueType=="item"){values.visit(function(value){s+="[["+propertyID+"::"+value+"]]\n";});}else{if(valueType=="url"){values.visit(function(value){s+="[["+propertyID+":="+Exhibit.Persistence.resolveURL(value)+"]]\n";});}else{values.visit(function(value){s+="[["+propertyID+":="+value+"]]\n";});}}}
s+="[[origin:="+Exhibit.Persistence.getItemLink(itemID)+"]]\n";s+="\n";return s;};Exhibit.SemanticWikitextExporter._wrap=function(s){return s;}

/* tsv-exporter.js */

Exhibit.TSVExporter={getLabel:function(){return Exhibit.l10n.tsvExporterLabel;}};Exhibit.TSVExporter.exportOne=function(itemID,database){return Exhibit.TSVExporter._wrap(Exhibit.TSVExporter._exportOne(itemID,database),database);};Exhibit.TSVExporter.exportMany=function(set,database){var s="";set.visit(function(itemID){s+=Exhibit.TSVExporter._exportOne(itemID,database)+"\n";});return Exhibit.TSVExporter._wrap(s,database);};Exhibit.TSVExporter._exportOne=function(itemID,database){var s="";var allProperties=database.getAllProperties();for(var i=0;i<allProperties.length;i++){var propertyID=allProperties[i];var property=database.getProperty(propertyID);var values=database.getObjects(itemID,propertyID);var valueType=property.getValueType();s+=values.toArray().join("; ")+"\t";}
return s;};Exhibit.TSVExporter._wrap=function(s,database){var header="";var allProperties=database.getAllProperties();for(var i=0;i<allProperties.length;i++){var propertyID=allProperties[i];var property=database.getProperty(propertyID);var valueType=property.getValueType();header+=propertyID+":"+valueType+"\t";}
return header+"\n"+s;}

/* expression.js */

Exhibit.Expression=new Object();Exhibit.Expression.parse=function(s){var expressions=Exhibit.Expression.parseSeveral(s);if(expressions.length>1){throw new Error("Expected only one expression");}
return expressions[0];};Exhibit.Expression.parseSeveral=function(s){var tokens=Exhibit.Expression._tokenize(s);var x=-1;var token;var consumeToken=function(){++x;token=x<tokens.length?tokens[x]:null;};consumeToken();var parseFactor=function(){if(token==null){throw new Error("Missing factor");}
var result=null;switch(token.type){case Exhibit.Expression._Token.NUMBER:result=new Exhibit.Expression._Constant(token.value,"number");break;case Exhibit.Expression._Token.STRING:result=new Exhibit.Expression._Constant(token.value,"text");break;case Exhibit.Expression._Token.PATH:result=token.value;break;case Exhibit.Expression._Token.FUNCTION:var name=token.value;consumeToken();if(token.type==Exhibit.Expression._Token.DELIMITER&&token.value=="("){consumeToken();result=new Exhibit.Expression._FunctionCall(name,parseExpressionList());if(token==null||token.type!=Exhibit.Expression._Token.DELIMITER||token.value!=")"){throw new Error("Missing ) after function call");}}else{throw new Error("Missing ( after function name");}
break;case Exhibit.Expression._Token.CONTROL:var name=token.value;consumeToken();if(token.type==Exhibit.Expression._Token.DELIMITER&&token.value=="("){consumeToken();result=new Exhibit.Expression._ControlCall(name,parseExpressionList());if(token==null||token.type!=Exhibit.Expression._Token.DELIMITER||token.value!=")"){throw new Error("Missing ) to end "+name);}}else{throw new Error("Missing ( to start "+name);}
break;case Exhibit.Expression._Token.DELIMITER:if(token.value=="("){consumeToken();result=parseExpression();if(token==null||token.type!=Exhibit.Expression._Token.DELIMITER||token.value!=")"){throw new Error("Missing )");}
break;}
default:throw new Error("Unexpected token "+token);}
consumeToken();return result;};var parseTerm=function(){var term=parseFactor();while(token!=null&&token.type==Exhibit.Expression._Token.OPERATOR&&(token.value=="*"||token.value=="/")){var operator=token.value;consumeToken();term=new Exhibit.Expression._Operator(operator,[term,parseFactor()]);}
return term;};var parseSubExpression=function(){var subExpression=parseTerm();while(token!=null&&token.type==Exhibit.Expression._Token.OPERATOR&&(token.value=="+"||token.value=="-")){var operator=token.value;consumeToken();subExpression=new Exhibit.Expression._Operator(operator,[subExpression,parseTerm()]);}
return subExpression;};var parseExpression=function(){var expression=parseSubExpression();while(token!=null&&token.type==Exhibit.Expression._Token.OPERATOR&&(token.value=="="||token.value=="!="||token.value=="<"||token.value=="<="||token.value==">"||token.value==">=")){var operator=token.value;consumeToken();expression=new Exhibit.Expression._Operator(operator,[expression,parseSubExpression()]);}
return expression;};var parseExpressionList=function(){var expressions=[parseExpression()];while(token!=null&&token.type==Exhibit.Expression._Token.DELIMITER&&token.value==","){consumeToken();expressions.push(parseExpression());}
return expressions;}
var roots=parseExpressionList();if(token!=null){throw new Error("Extra text found at the end of the code");}
var expressions=[];for(var r=0;r<roots.length;r++){expressions.push(new Exhibit.Expression._Impl(roots[r]));}
return expressions;};Exhibit.Expression._delimiters={"(":true,")":true,",":true};Exhibit.Expression._tokenizeNoStringLiterals=function(s){s=s.replace(/\s+/g,' ').replace(/\s+\./g,'.').replace(/\s+\!/g,'!').replace(/\s?\(\s?/g,' ( ').replace(/\s?\)\s?/g,' ) ').replace(/\s\+\s/g,' + ').replace(/\s\-\s/g,' - ').replace(/\s\*\s/g,' * ').replace(/\s\/\s/g,' / ').replace(/\s?\,\s?/g,' , ').trim();var tokens=s.split(" ");var results=[];for(var i=0;i<tokens.length;i++){var token=tokens[i].trim();if(token==""){}else if(token in Exhibit.Expression._delimiters){results.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.DELIMITER,token));}else if(token in Exhibit.Expression._operators){results.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.OPERATOR,token));}else if(token in Exhibit.Functions){results.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.FUNCTION,token));}else if(token=="foreach"){results.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.CONTROL,token));}else{var n=parseFloat(token);if(isNaN(n)){results.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.PATH,Exhibit.Expression._parsePath(token)));}else{results.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.NUMBER,n));}}}
return results;};Exhibit.Expression._tokenize=function(s){var tokens=[];var findClosingDelimiter=function(d){var start=0;while(start<s.length){var closing=s.indexOf(d,start);if(closing>0){if(s.substr(closing-1,1)=="\\"){start=closing+1;continue;}}
return closing;}
return-1;}
while(s.length>0){var delimiter="'";var opening=s.indexOf(delimiter);if(opening<0){delimiter='"';opening=s.indexOf(delimiter);}
if(opening<0){break;}else{tokens=tokens.concat(Exhibit.Expression._tokenizeNoStringLiterals(s.substr(0,opening)));s=s.substr(opening+1);var closing=findClosingDelimiter(delimiter);if(closing>=0){tokens.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.STRING,s.substr(0,closing)));s=s.substr(closing+1);}else{throw new Error("String missing closing delimiter");}}}
if(s.length>0){tokens=tokens.concat(Exhibit.Expression._tokenizeNoStringLiterals(s));}
return tokens;};Exhibit.Expression._parsePath=function(s){var path=new Exhibit.Expression.Path();if(s.length>0){var dotBang=s.search(/[\.!]/);if(dotBang>0){path.setRootName(s.substr(0,dotBang));s=s.substr(dotBang);}else if(dotBang<0){path.setRootName(s);s="";}
var regex=/[\.!][^\.!]+/g;var result;while((result=regex.exec(s))!=null){var segment=result[0];var dotBang=segment.substr(0,1);var property=segment.substr(1);var isList=false;var at=property.indexOf("@");if(at>0){if(property.substr(at+1)=="list"){isList=true;}
property=property.substr(0,at);}
path.appendSegment(property,dotBang==".",isList);}}
return path;};Exhibit.Expression._Token=function(type,value){this.type=type;this.value=value;};Exhibit.Expression._Token.DELIMITER=0;Exhibit.Expression._Token.CONTROL=1;Exhibit.Expression._Token.PATH=2;Exhibit.Expression._Token.OPERATOR=3;Exhibit.Expression._Token.FUNCTION=4;Exhibit.Expression._Token.NUMBER=5;Exhibit.Expression._Token.STRING=6;Exhibit.Expression._Impl=function(rootNode){this._rootNode=rootNode;};Exhibit.Expression._Impl.prototype.evaluate=function(roots,rootValueTypes,defaultRootName,database){return this._rootNode.evaluate(roots,rootValueTypes,defaultRootName,database);};Exhibit.Expression._Impl.prototype.evaluateOnItem=function(itemID,database){return this.evaluate({"value":itemID},{"value":"item"},"value",database);};Exhibit.Expression._Impl.prototype.evaluateSingle=function(roots,rootValueTypes,defaultRootName,database){var results=this._rootNode.evaluate(roots,rootValueTypes,defaultRootName,database);var result={value:null,valueType:results.valueType};results.values.visit(function(v){result.value=v;return true;});return result;};Exhibit.Expression._Impl.prototype.evaluateSingleOnItem=function(itemID,database){return this.evaluateSingle({"value":itemID},{"value":"item"},"value",database);};Exhibit.Expression._Impl.prototype.testExists=function(roots,rootValueTypes,defaultRootName,database){return this.isPath()?this._rootNode.testExists(roots,rootValueTypes,defaultRootName,database):false;};Exhibit.Expression._Impl.prototype.isPath=function(){return this._rootNode instanceof Exhibit.Expression.Path;};Exhibit.Expression._Impl.prototype.getPath=function(){return this.isPath()?this._rootNode:null;};Exhibit.Expression.Path=function(){this._rootName=null;this._segments=[];};Exhibit.Expression.Path.create=function(property,forward){var path=new Exhibit.Expression.Path();path._segments.push({property:property,forward:forward,isList:false});return path;};Exhibit.Expression.Path.prototype.setRootName=function(rootName){this._rootName=rootName;};Exhibit.Expression.Path.prototype.appendSegment=function(property,forward,isList){this._segments.push({property:property,forward:forward,isList:isList});};Exhibit.Expression.Path.prototype.getSegment=function(index){if(index<this._segments.length){var segment=this._segments[index];return{property:segment.property,forward:segment.forward};}else{return null;}};Exhibit.Expression.Path.prototype.getLastSegment=function(){return this.getSegment(this._segments.length-1);};Exhibit.Expression.Path.prototype.getSegmentCount=function(){return this._segments.length;};Exhibit.Expression.Path.prototype.evaluate=function(roots,rootValueTypes,defaultRootName,database){var rootName=this._rootName!=null?this._rootName:defaultRootName;var set=new Exhibit.Set();var root=roots[rootName];if(root instanceof Exhibit.Set){set.addSet(root);}else{set.add(root);}
return this._walkForward(set,rootValueTypes[rootName],database);};Exhibit.Expression.Path.prototype.evaluateBackward=function(value,valueType,filter,database){var set=new Exhibit.Set();set.add(value);return this._walkBackward(set,valueType,filter,database);}
Exhibit.Expression.Path.prototype.walkForward=function(values,valueType,database){return this._walkForward(new Exhibit.Set(values),valueType,database);};Exhibit.Expression.Path.prototype.walkBackward=function(values,valueType,filter,database){return this._walkBackward(new Exhibit.Set(values),valueType,filter,database);};Exhibit.Expression.Path.prototype._walkForward=function(set,valueType,database){for(var i=0;i<this._segments.length;i++){var segment=this._segments[i];if(segment.forward){set=database.getObjectsUnion(set,segment.property);var property=database.getProperty(segment.property);valueType=property!=null?property.getValueType():"text";}else{set=database.getSubjectsUnion(set,segment.property);valueType="item";}}
return{valueType:valueType,values:set,count:set.size()};};Exhibit.Expression.Path.prototype._walkBackward=function(set,valueType,filter,database){for(var i=this._segments.length-1;i>=0;i--){var segment=this._segments[i];if(segment.forward){set=database.getSubjectsUnion(set,segment.property,null,i==0?filter:null);valueType="item";}else{set=database.getObjectsUnion(set,segment.property,null,i==0?filter:null);var property=database.getProperty(segment.property);valueType=property!=null?property.getValueType():"text";}}
return{valueType:valueType,values:set,count:set.size()};};Exhibit.Expression.Path.prototype.rangeBackward=function(from,to,filter,database){var set=new Exhibit.Set();var valueType="item";if(this._segments.length>0){var segment=this._segments[0];if(segment.forward){database.getSubjectsInRange(segment.property,from,to,false,set,this._segments.length==1?filter:null);}else{throw new Error("Last path of segment must be forward");}
for(var i=this._segments.length-1;i>0;i--){segment=this._segments[i];if(segment.forward){set=database.getSubjectsUnion(set,segment.property,null,i==0?filter:null);valueType="item";}else{set=database.getObjectsUnion(set,segment.property,i==0?filter:null);var property=database.getProperty(segment.property);valueType=property!=null?property.getValueType():"text";}}}
return{valueType:valueType,values:set,count:set.size()};};Exhibit.Expression.Path.prototype.testExists=function(roots,rootValueTypes,defaultRootName,database){return this.evaluate(roots,rootValueTypes,defaultRootName,database).count>0;};Exhibit.Expression._Constant=function(value,valueType){this._value=value;this._valueType=valueType;};Exhibit.Expression._Constant.prototype.evaluate=function(roots,rootValueTypes,defaultRootName,database){var set=new Exhibit.Set();set.add(this._value);return{valueType:this._valueType,values:set,count:1};};Exhibit.Expression._Operator=function(operator,args){this._operator=operator;this._args=args;};Exhibit.Expression._Operator.prototype.evaluate=function(roots,rootValueTypes,defaultRootName,database){var set=new Exhibit.Set();var args=[];for(var i=0;i<this._args.length;i++){args.push(this._args[i].evaluate(roots,rootValueTypes,defaultRootName,database));}
var operator=Exhibit.Expression._operators[this._operator];var f=operator.f;if(operator.argumentType=="number"){args[0].values.visit(function(v1){if(!(typeof v1=="number")){v1=parseFloat(v1);}
args[1].values.visit(function(v2){if(!(typeof v2=="number")){v2=parseFloat(v2);}
set.add(f(v1,v2));});});}else{args[0].values.visit(function(v1){args[1].values.visit(function(v2){set.add(f(v1,v2));});});}
return{valueType:operator.valueType,values:set,count:set.size()};};Exhibit.Expression._operators={"+":{argumentType:"number",valueType:"number",f:function(a,b){return a+b;}},"-":{argumentType:"number",valueType:"number",f:function(a,b){return a-b;}},"*":{argumentType:"number",valueType:"number",f:function(a,b){return a*b;}},"/":{argumentType:"number",valueType:"number",f:function(a,b){return a/b;}},"=":{valueType:"boolean",f:function(a,b){return a==b;}},"<":{argumentType:"number",valueType:"boolean",f:function(a,b){return a<b;}},">":{argumentType:"number",valueType:"boolean",f:function(a,b){return a>b;}},"<=":{argumentType:"number",valueType:"boolean",f:function(a,b){return a<=b;}},">=":{argumentType:"number",valueType:"boolean",f:function(a,b){return a>=b;}}}
Exhibit.Expression._FunctionCall=function(name,args){this._name=name;this._args=args;};Exhibit.Expression._FunctionCall.prototype.evaluate=function(roots,rootValueTypes,defaultRootName,database){var args=[];for(var i=0;i<this._args.length;i++){args.push(this._args[i].evaluate(roots,rootValueTypes,defaultRootName,database));}
return Exhibit.Functions[this._name].f(args);};Exhibit.Expression._ControlCall=function(name,args){this._name=name;this._args=args;};Exhibit.Expression._ControlCall.prototype.evaluate=function(roots,rootValueTypes,defaultRootName,database){var self=this;if(this._name=="foreach"){var collection=this._args[0].evaluate(roots,rootValueTypes,defaultRootName,database);var oldValue=roots["value"];var oldValueType=rootValueTypes["value"];rootValueTypes["value"]=collection.valueType;var results=new Exhibit.Set();var valueType="text";collection.values.visit(function(element){roots["value"]=element;var r=self._args[1].evaluate(roots,rootValueTypes,defaultRootName,database);valueType=r.valueType;results.addSet(r.values);});roots["value"]=oldValue;rootValueTypes["value"]=oldValueType;return{valueType:valueType,values:results,count:results.size()};}
return{valueType:"text",values:new Exhibit.Set(),count:0};};

/* list-facet.js */

Exhibit.ListFacet=function(collection,containerElmt,exhibit){this._collection=collection;this._div=containerElmt;this._exhibit=exhibit;this.path=null;this._facetLabel=null;this._dom=null;this._topValueDoms=null;this._groupingBoxDom=null;this.valueSet=null;this.groupings=[];this.selectedCount=0;};Exhibit.ListFacet.create=function(configuration,containerElmt,exhibit){var collection=Exhibit.Collection.getCollection(configuration,exhibit);var facet=new Exhibit.ListFacet(collection,containerElmt!=null?containerElmt:configElmt,exhibit);Exhibit.ListFacet._configure(facet,configuration);facet._initializeUI();collection.addFacet(facet);return facet;};Exhibit.ListFacet.createFromDOM=function(configElmt,containerElmt,exhibit){var configuration=Exhibit.getConfigurationFromDOM(configElmt);var collection=Exhibit.Collection.getCollectionFromDOM(configElmt,configuration,exhibit);var facet=new Exhibit.ListFacet(collection,containerElmt!=null?containerElmt:configElmt,exhibit);try{var expressionString=Exhibit.getAttribute(configElmt,"expression");if(expressionString!=null&&expressionString.length>0){var expression=Exhibit.Expression.parse(expressionString);if(expression.isPath()){facet.path=expression.getPath();}}
var facetLabel=Exhibit.getAttribute(configElmt,"facetLabel");if(facetLabel!=null&&facetLabel.length>0){facet._facetLabel=facetLabel;}
var selection=Exhibit.getAttribute(configElmt,"selection",";");if(selection!=null&&selection.length>0){facet.valueSet=new Exhibit.Set();for(var i=0,s;s=selection[i];i++){facet.valueSet.add(s);facet.selectedCount++;}}}catch(e){SimileAjax.Debug.exception("ListFacet: Error processing configuration of list facet",e);}
facet._initializeUI();collection.addFacet(facet);return facet;};Exhibit.ListFacet._configure=function(facet,configuration){if("expression"in configuration){var expression=Exhibit.Expression.parse(configuration.expression);if(expression.isPath()){facet.path=expression.getPath();}}
if("facetLabel"in configuration){facet._facetLabel=configuration.facetLabel;}
if("selection"in configuration){facet.valueSet=new Exhibit.Set();var selection=configuration.selection;for(var i=0;i<selection.length;i++){facet.valueSet.add(selection[i]);facet.selectedCount++;}}}
Exhibit.ListFacet.prototype.dispose=function(){this._dom.close();if(this._groupingBoxDom!=null){this._groupingBoxDom.elmt.parentNode.removeChild(this._groupingBoxDom.elmt);this._groupingBoxDom=null;}
this._dom=null;this._topValueDoms=null;this._collection=null;this._div=null;this._exhibit=null;};Exhibit.ListFacet.prototype.hasRestrictions=function(){return this.selectedCount>0;};Exhibit.ListFacet.prototype.clearAllRestrictions=function(){var restrictions=[];if(this.selectedCount>0){if(this.valueSet!=null){this.valueSet.visit(function(v){restrictions.push({level:-1,value:v});});this.valueSet=null;}
for(var i=0;i<this.groupings.length;i++){if(this.groupings[i].valueSet!=null){this.groupings[i].valueSet.visit(function(v){restrictions.push({level:i,value:v});});this.groupings[i].valueSet=null;}}
this.selectedCount=0;this._notifyCollection();}
return restrictions;};Exhibit.ListFacet.prototype.applyRestrictions=function(restrictions){for(var i=0;i<restrictions.length;i++){var r=restrictions[i];this.setSelection(r.level,r.value,true);}
this._notifyCollection();};Exhibit.ListFacet.prototype.setSelection=function(level,value,selected){if(selected){if(level==-1){if(!this.valueSet){this.valueSet=new Exhibit.Set();}
if(this.valueSet.add(value)){this.selectedCount++;}}else{var grouping=this.groupings[level];if(!grouping.valueSet){grouping.valueSet=new Exhibit.Set();}
if(grouping.valueSet.add(value)){this.selectedCount++;}}}else{if(level==-1){if(this.valueSet){if(this.valueSet.remove(value)){this.selectedCount--;}}}else{var grouping=this.groupings[level];if(grouping.valueSet){if(grouping.valueSet.remove(value)){this.selectedCount--;}}}}}
Exhibit.ListFacet.prototype.getValueSet=function(level){return level<0?this.valueSet:this.groupings[level].valueSet;}
Exhibit.ListFacet.prototype.getPath=function(level){if(level<0||level==undefined){return this.path;}else if(level<this.groupings.length){var grouping=this.groupings[level];return Exhibit.Expression.Path.create(grouping.property,grouping.forward);}else{throw new Error("No such level in restriction");}}
Exhibit.ListFacet.prototype.getLevelCount=function(){return this.groupings.length;};Exhibit.ListFacet.prototype.restrict=function(items){var self=this;var recurseGetRestrictionValues=function(level,results,intersectResultsWith){var path=self.getPath(level);var rangeSet=new Exhibit.Set();var userSelectedSet=self.getValueSet(level);if(userSelectedSet&&userSelectedSet.size()>0){rangeSet.addSet(userSelectedSet);}
if(level<self.getLevelCount()-1){recurseGetRestrictionValues(level+1,rangeSet,null);}
if(rangeSet.size()>0){results.addSet(path.walkBackward(rangeSet,"item",intersectResultsWith,database).values);return results;}else{return intersectResultsWith;}};return recurseGetRestrictionValues(-1,new Exhibit.Set(),items);};Exhibit.ListFacet.prototype.update=function(items){this._dom.valuesContainer.style.display="none";this._dom.valuesContainer.innerHTML="";var facetData=this._computeFacet(items);if(facetData!=null){this._constructBody(facetData);}
this._dom.valuesContainer.style.display="block";};Exhibit.ListFacet.prototype._computeFacet=function(currentSet){var database=this._exhibit.getDatabase();var results=this.getPath().walkForward(currentSet,"item",database);var values=results.values;if(values.size()==0){return null;}
var slideSet=this.getPath().walkForward(currentSet,"item",database).values;var facetData=this._createFacetTemplate(values,results.valueType,slideSet);var self=this;var f=function(level,domainSets,valueToFacetValueMap){var domainSet=domainSets[domainSets.length-1];var path=self.getPath(level);var resultStruct=path.walkForward(domainSet,"item",database);var rangeSet=resultStruct.values;var rangeValuesAreItems=resultStruct.valueType=="item";var previousSelectedRangeSet=self.getValueSet(level);if(previousSelectedRangeSet){rangeSet.addSet(previousSelectedRangeSet);facetData.selectedCount+=previousSelectedRangeSet.size();}
var results=[];var map={};var facetSortFunc=function(a,b){return a.label.localeCompare(b.label);};if(resultStruct.valueType=="number"){facetSortFunc=function(a,b){a=parseFloat(a.value);b=parseFloat(b.value);return a<b?-1:a>b?1:0;}}
rangeSet.visit(function(rangeValue){var domainSubset=path.evaluateBackward(rangeValue,"item",domainSet,database).values;var firstDomainSubset=domainSubset;for(var i=level-1;i>=-1;i--){firstDomainSubset=r.getPath(i).walkBackward(firstDomainSubset,"item",domainSets[i+1],database).values;}
var label=rangeValuesAreItems?database.getObject(rangeValue,"label"):rangeValue;var facetValue={value:rangeValue,count:firstDomainSubset.size(),label:label!=null?label:rangeValue,selected:(previousSelectedRangeSet)?previousSelectedRangeSet.contains(rangeValue):false,filtered:level==-1&&slideSet.contains(rangeValue),level:level,children:[]};if(valueToFacetValueMap){domainSubset.visit(function(domainValue){var childFacetValue=valueToFacetValueMap[domainValue];facetValue.children.push(childFacetValue);});facetValue.children.sort(facetSortFunc);}
results.push(facetValue);map[rangeValue]=facetValue;});if(level<self.getLevelCount()-1){domainSets.push(rangeSet);return arguments.callee(level+1,domainSets,map);}else{results.sort(facetSortFunc);return results;}};facetData.values=f(-1,[currentSet],null);return facetData;}
Exhibit.ListFacet.prototype._createFacetTemplate=function(values,valueType,slideSet){var database=this._exhibit.getDatabase();var segment=this.getPath(-1).getLastSegment();var property=segment.property;var forward=segment.forward;var propertyData=database.getProperty(property);var facetLabel=forward?propertyData.getPluralLabel():propertyData.getReversePluralLabel();var typeLabels=database.getTypeLabels(values);var valueLabel=typeLabels[0].length>0?typeLabels[0].join(", "):"option";var pluralValueLabel=typeLabels[1].length>0?typeLabels[1].join(", "):"options";var itemValues=(!forward||propertyData.getValueType()=="item");return{facetLabel:facetLabel,valueLabel:valueLabel,pluralValueLabel:pluralValueLabel,count:values.size(),selectedCount:0,filteredCount:slideSet.size(),groupLevelCount:this.getLevelCount(),groupable:itemValues,values:[]};};Exhibit.ListFacet.prototype._notifyCollection=function(){this._collection.onFacetUpdated(this);};Exhibit.ListFacet.prototype._initializeUI=function(){var facet=this;var onGroup=function(elmt,evt,target){facet._openGroupingUI();SimileAjax.DOM.cancelEvent(evt);return false;};var onCollapseAll=function(elmt,evt,target){facet._collapseGroups();SimileAjax.DOM.cancelEvent(evt);return false;};var onExpandAll=function(elmt,evt,target){facet._expandGroups();SimileAjax.DOM.cancelEvent(evt);return false;};var onClearSelections=function(elmt,evt,target){facet._clearSelections();SimileAjax.DOM.cancelEvent(evt);return false;};this._dom=Exhibit.ListFacet.theme.constructFacetFrame(this._exhibit,this._div,this._facetLabel,this._groupable,this._groupLevelCount>0,onGroup,onCollapseAll,onExpandAll,onClearSelections);this._dom.open();};Exhibit.ListFacet.prototype._constructBody=function(facetData){var listFacet=this;this._topValueDoms=[];this._dom.setGroupControlsVisible(facetData.groupLevelCount>0);var constructValue=function(value,containerDiv,level){var hasChildren=value.children.length>0;var expanded=false;var onSelect=function(elmt,evt,target){listFacet._filter(valueDom);SimileAjax.DOM.cancelEvent(evt);return false;};var valueDom=Exhibit.ListFacet.theme.constructFacetItem(listFacet._exhibit,value.label,value.count,level,value.selected,hasChildren,expanded,onSelect);valueDom.value=value.value;valueDom.selected=value.selected;valueDom.level=level;containerDiv.appendChild(valueDom.elmt);if(level==0){listFacet._topValueDoms.push(valueDom);}
if(value.children.length>0){var childrenContainer=Exhibit.ListFacet.theme.constructFacetChildrenContainer(listFacet._exhibit,expanded);constructValues(value.children,childrenContainer,level+1);containerDiv.appendChild(childrenContainer);valueDom.childrenContainer=childrenContainer;}};var constructValues=function(values,containerDiv,level){for(var j=0;j<values.length;j++){constructValue(values[j],containerDiv,level);}};constructValues(facetData.values,this._dom.valuesContainer,0);this._groupLevelCount=facetData.groupLevelCount;this._dom.setSelectionCount(facetData.selectedCount);};Exhibit.ListFacet.prototype.setSelection=function(level,value,selected){if(selected){if(level==-1){if(!this.valueSet){this.valueSet=new Exhibit.Set();}
if(this.valueSet.add(value)){this.selectedCount++;}}else{var grouping=this.groupings[level];if(!grouping.valueSet){grouping.valueSet=new Exhibit.Set();}
if(grouping.valueSet.add(value)){this.selectedCount++;}}}else{if(level==-1){if(this.valueSet){if(this.valueSet.remove(value)){this.selectedCount--;}}}else{var grouping=this.groupings[level];if(grouping.valueSet){if(grouping.valueSet.remove(value)){this.selectedCount--;}}}}
this._notifyCollection();};Exhibit.ListFacet.prototype._filter=function(valueDom){var level=this._groupLevelCount-valueDom.level-1;var value=valueDom.value;var selected=!valueDom.selected;var self=this;SimileAjax.History.addAction({perform:function(){self.setSelection(level,value,selected);},undo:function(){self.setSelection(level,value,!selected);},label:selected?("set "+this._facetLabel+" = "+value):("unset "+this._facetLabel+" = "+value),uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.ListFacet.prototype._clearSelections=function(){var state={};var self=this;SimileAjax.History.addAction({perform:function(){state.restrictions=self.clearAllRestrictions();},undo:function(){self.applyRestrictions(state.restrictions);},label:"clear selections",uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.ListFacet.prototype._openGroupingUI=function(){if(this._groupingBoxDom!=null){return;}
var coords=SimileAjax.DOM.getPageCoordinates(this._dom.elmt);var listFacet=this;this._groupingBoxDom=Exhibit.ListFacet.theme.constructGroupingBox(this._exhibit,coords.left>(document.body.scrollWidth/2),function(elmt,evt,target){listFacet._ungroupAll();SimileAjax.DOM.cancelEvent(evt);return false;},function(elmt,evt,target){listFacet._closeGroupingUI();SimileAjax.DOM.cancelEvent(evt);return false;});this._reconstructGroupingBox();this._dom.elmt.appendChild(this._groupingBoxDom.elmt);}
Exhibit.ListFacet.prototype._closeGroupingUI=function(){if(this._groupingBoxDom!=null){this._groupingBoxDom.elmt.parentNode.removeChild(this._groupingBoxDom.elmt);this._groupingBoxDom=null;}}
Exhibit.ListFacet.prototype._reconstructGroupingBox=function(){var listFacet=this;this._groupingBoxDom.clearGroups();var makeGroup=function(group,level){var groupDom=Exhibit.ListFacet.theme.constructGroup(listFacet._exhibit,level==0,group.grouped,function(elmt,evt,target){listFacet._ungroup(groupDom);SimileAjax.DOM.cancelEvent(evt);return false;});groupDom.level=level;listFacet._groupingBoxDom.appendGroup(groupDom);var makeGroupOption=function(groupingOption){var optionDom=Exhibit.ListFacet.theme.constructGroupingOption(listFacet._exhibit,groupingOption.label,groupingOption.selected,function(elmt,evt,target){listFacet._toggleGroup(groupDom,optionDom);SimileAjax.DOM.cancelEvent(evt);return false;});optionDom.property=groupingOption.property;optionDom.forward=groupingOption.forward;optionDom.selected=groupingOption.selected;groupDom.appendOption(optionDom);};var groupingOptions=group.groupingOptions;for(var j=0;j<groupingOptions.length;j++){makeGroupOption(groupingOptions[j]);}};var groups=this._exhibit.getBrowseEngine().getGroups(this._facetID);for(var i=0;i<groups.length;i++){makeGroup(groups[i],i);}}
Exhibit.ListFacet.prototype._toggleGroup=function(groupDom,optionDom){if(optionDom.selected){this._ungroup(groupDom);}else{this._group(groupDom,optionDom);}}
Exhibit.ListFacet.prototype._group=function(groupDom,optionDom){var property=optionDom.property;var forward=optionDom.forward;var selected=optionDom.selected;var level=groupDom.level;this._exhibit.getBrowseEngine().group(this._facetID,level,property,forward);this._reconstructGroupingBox();var facet=this._exhibit.getBrowseEngine().getFacet(this._facetID);if(facet!=null){this.update(facet);}}
Exhibit.ListFacet.prototype._ungroup=function(groupDom){this._exhibit.getBrowseEngine().ungroup(this._facetID,groupDom.level);this._reconstructGroupingBox();var facet=this._exhibit.getBrowseEngine().getFacet(this._facetID);if(facet!=null){this.update(facet);}}
Exhibit.ListFacet.prototype._ungroupAll=function(){this._exhibit.getBrowseEngine().ungroup(this._facetID,0);this._reconstructGroupingBox();var facet=this._exhibit.getBrowseEngine().getFacet(this._facetID);if(facet!=null){this.update(facet);}}
Exhibit.ListFacet.prototype._collapseGroups=function(){for(var i=0;i<this._topValueDoms.length;i++){this._topValueDoms[i].collapseGroup();}}
Exhibit.ListFacet.prototype._expandGroups=function(valueDom){for(var i=0;i<this._topValueDoms.length;i++){this._topValueDoms[i].expandGroup();}}

/* numeric-range-facet.js */

Exhibit.NumericRangeFacet=function(collection,containerElmt,exhibit){this._collection=collection;this._div=containerElmt;this._exhibit=exhibit;this._path=null;this._facetLabel=null;this._interval=10;this._dom=null;this._ranges=[];};Exhibit.NumericRangeFacet.create=function(configuration,containerElmt,exhibit){var collection=Exhibit.Collection.getCollection(configuration,exhibit);var facet=new Exhibit.NumericRangeFacet(collection,containerElmt!=null?containerElmt:configElmt,exhibit);Exhibit.NumericRangeFacet._configure(facet,configuration);facet._initializeUI();collection.addFacet(facet);return facet;};Exhibit.NumericRangeFacet.createFromDOM=function(configElmt,containerElmt,exhibit){var configuration=Exhibit.getConfigurationFromDOM(configElmt);var collection=Exhibit.Collection.getCollectionFromDOM(configElmt,configuration,exhibit);var facet=new Exhibit.NumericRangeFacet(collection,containerElmt!=null?containerElmt:configElmt,exhibit);try{var expressionString=Exhibit.getAttribute(configElmt,"expression");if(expressionString!=null&&expressionString.length>0){var expression=Exhibit.Expression.parse(expressionString);if(expression.isPath()){facet._path=expression.getPath();}}
var facetLabel=Exhibit.getAttribute(configElmt,"facetLabel");if(facetLabel!=null&&facetLabel.length>0){facet._facetLabel=facetLabel;}
var interval=Exhibit.getAttribute(configElmt,"interval");if(interval!=null&&interval.length>0){facet._interval=parseFloat(interval);}}catch(e){SimileAjax.Debug.exception("NumericRangeFacet: Error processing configuration of numeric range facet",e);}
facet._initializeUI();collection.addFacet(facet);return facet;};Exhibit.NumericRangeFacet._configure=function(facet,configuration){if("expression"in configuration){var expression=Exhibit.Expression.parse(configuration.expression);if(expression.isPath()){facet._path=expression.getPath();}}
if("facetLabel"in configuration){facet._facetLabel=configuration.facetLabel;}
if("interval"in configuration){facet._interval=configuration.interval;}}
Exhibit.NumericRangeFacet.prototype.dispose=function(){this._dom.close();this._dom=null;this._collection=null;this._div=null;this._exhibit=null;};Exhibit.NumericRangeFacet.prototype.hasRestrictions=function(){return this._ranges.length>0;};Exhibit.NumericRangeFacet.prototype.clearAllRestrictions=function(){var restrictions=[];if(this._ranges.length>0){restrictions=restrictions.concat(this._ranges);this._ranges=[];this._notifyCollection();}
return restrictions;};Exhibit.NumericRangeFacet.prototype.applyRestrictions=function(restrictions){this._ranges=restrictions;this._notifyCollection();};Exhibit.NumericRangeFacet.prototype.setRange=function(from,to,selected){if(selected){for(var i=0;i<this._ranges.length;i++){var range=this._ranges[i];if(range.from==from&&range.to==to){return;}}
this._ranges.push({from:from,to:to});}else{for(var i=0;i<this._ranges.length;i++){var range=this._ranges[i];if(range.from==from&&range.to==to){this._ranges.splice(i,1);break;}}}
this._notifyCollection();}
Exhibit.NumericRangeFacet.prototype.restrict=function(items){var path=this._path;var database=this._exhibit.getDatabase();var set=new Exhibit.Set();for(var i=0;i<this._ranges.length;i++){var range=this._ranges[i];set.addSet(path.rangeBackward(range.from,range.to,items,database).values);}
return set;};Exhibit.NumericRangeFacet.prototype.update=function(items){this._dom.valuesContainer.style.display="none";this._dom.valuesContainer.innerHTML="";this._reconstruct(items);this._dom.valuesContainer.style.display="block";};Exhibit.NumericRangeFacet.prototype._reconstruct=function(items){var database=this._exhibit.getDatabase();var propertyID=this._path.getLastSegment().property;var property=database.getProperty(propertyID);if(property==null){return null;}
var rangeIndex=property.getRangeIndex();var min=rangeIndex.getMin();var max=rangeIndex.getMax();min=Math.floor(min/this._interval)*this._interval;max=Math.ceil(max/this._interval)*this._interval;var ranges=[];for(var x=min;x<max;x+=this._interval){var range={from:x,to:x+this._interval,selected:false};range.items=this._path.rangeBackward(range.from,range.to,items,database).values
for(var i=0;i<this._ranges.length;i++){var range2=this._ranges[i];if(range2.from==range.from&&range2.to==range.to){range.selected=true;break;}}
ranges.push(range);}
var self=this;var containerDiv=this._dom.valuesContainer;var makeFacetValue=function(from,to,count,selected){var onSelect=function(elmt,evt,target){self._toggleRange(from,to,selected);SimileAjax.DOM.cancelEvent(evt);return false;};var valueDom=Exhibit.NumericRangeFacet.theme.constructFacetItem(self._exhibit,from+" - "+to,count,selected,onSelect);containerDiv.appendChild(valueDom.elmt);};for(var i=0;i<ranges.length;i++){var range=ranges[i];if(range.selected||range.items.size()>0){makeFacetValue(range.from,range.to,range.items.size(),range.selected);}}
this._dom.setSelectionCount(this._ranges.length);}
Exhibit.NumericRangeFacet.prototype._notifyCollection=function(){this._collection.onFacetUpdated(this);};Exhibit.NumericRangeFacet.prototype._initializeUI=function(){var facet=this;var onClearSelections=function(elmt,evt,target){facet._clearSelections();SimileAjax.DOM.cancelEvent(evt);return false;};this._dom=Exhibit.NumericRangeFacet.theme.constructFacetFrame(this._exhibit,this._div,this._facetLabel,onClearSelections);this._dom.open();};Exhibit.NumericRangeFacet.prototype._toggleRange=function(from,to,selected){var self=this;var range=from+" to "+to;SimileAjax.History.addAction({perform:function(){self.setRange(from,to,!selected);},undo:function(){self.setRange(from,to,selected);},label:selected?("Remove range "+range+" from "+this._facetLabel):("Add range "+range+" to "+this._facetLabel),uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.NumericRangeFacet.prototype._clearSelections=function(){var state={};var self=this;SimileAjax.History.addAction({perform:function(){state.restrictions=self.clearAllRestrictions();},undo:function(){self.applyRestrictions(state.restrictions);},label:"clear selections",uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};

/* functions.js */

Exhibit.Functions={};Exhibit.Functions["union"]={f:function(args){var set=new Exhibit.Set();if(args.length==0){return{valueType:"text",values:set,count:0};}else{var valueType=args[0].valueType;set.addSet(args[0].values);for(var i=1;i<args.length;i++){var arg=args[i];if(valueType==arg.valueType){set.addSet(arg.values);}}
return{valueType:valueType,values:set,count:set.size()};}}};Exhibit.Functions["contains"]={f:function(args){var result=args[0].values.size()>0;args[1].values.visit(function(v){if(!args[0].values.contains(v)){result=false;}});var set=new Exhibit.Set();set.add(result);return{valueType:"boolean",values:set,count:set.size()};}};Exhibit.Functions["count"]={f:function(args){var set=new Exhibit.Set();set.add(args[0].values.size());return{valueType:"number",values:set,count:set.size()};}};Exhibit.Functions["add"]={f:function(args){var total=0;for(var i=0;i<args.length;i++){args[i].values.visit(function(v){if(v!=null){if(typeof v=="number"){total+=v;}else{var n=parseFloat(v);if(!isNaN(n)){total+=n;}}}});}
var set=new Exhibit.Set();set.add(total);return{valueType:"number",values:set,count:set.size()};}};Exhibit.Functions["multiply"]={f:function(args){var product=1;for(var i=0;i<args.length;i++){args[i].values.visit(function(v){if(v!=null){if(typeof v=="number"){product*=v;}else{var n=parseFloat(v);if(!isNaN(n)){product*=n;}}}});}
var set=new Exhibit.Set();set.add(total);return{valueType:"number",values:set,count:set.size()};}};Exhibit.Functions["date-range"]={_parseDate:function(v){if(v==null){return Number.NEGATIVE_INFINITY;}else if(v instanceof Date){return v.getTime();}else{try{return SimileAjax.DateTime.parseIso8601DateTime(v).getTime();}catch(e){return Number.NEGATIVE_INFINITY;}}},_factors:{second:1000,minute:60*1000,hour:60*60*1000,day:24*60*60*1000,week:7*24*60*60*1000,month:30*24*60*60*1000,quarter:3*30*24*60*60*1000,year:365*24*60*60*1000,decade:10*365*24*60*60*1000,century:100*365*24*60*60*1000},_computeRange:function(from,to,interval){var range=to-from;if(isFinite(range)){if(interval in this._factors){range=Math.round(range/this._factors[interval]);}
return range;}
return null;},f:function(args){var self=this;var from=Number.POSITIVE_INFINITY;args[0].values.visit(function(v){from=Math.min(from,self._parseDate(v));});var to=Number.NEGATIVE_INFINITY;args[1].values.visit(function(v){to=Math.max(to,self._parseDate(v));});var interval="day";args[2].values.visit(function(v){interval=v;});var set=new Exhibit.Set();var range=this._computeRange(from,to,interval);if(range!=null){set.add(range);}
return{valueType:"number",values:set,count:set.size()};}};

/* exhibit-json-importer.js */

Exhibit.ExhibitJSONImporter={};Exhibit.importers["application/json"]=Exhibit.ExhibitJSONImporter;Exhibit.ExhibitJSONImporter.load=function(link,database,cont){var url=Exhibit.Persistence.resolveURL(link.href);var fError=function(statusText,status,xmlhttp){Exhibit.UI.hideBusyIndicator();Exhibit.UI.showHelp(Exhibit.l10n.failedToLoadDataFileMessage(url));if(cont)cont();};var fDone=function(xmlhttp){Exhibit.UI.hideBusyIndicator();try{var o=null;try{o=eval("("+xmlhttp.responseText+")");}catch(e){Exhibit.UI.showJsonFileValidation(Exhibit.l10n.badJsonMessage(url,e),url);}
if(o!=null){database.loadData(o,Exhibit.Persistence.getBaseURL(url));}}catch(e){SimileAjax.Debug.exception("Error loading Exhibit JSON data from "+url,e);}finally{if(cont)cont();}};Exhibit.UI.showBusyIndicator();SimileAjax.XmlHttp.get(url,fError,fDone);};

/* html-table-importer.js */

Exhibit.HtmlTableImporter={};Exhibit.importers["text/html"]=Exhibit.HtmlTableImporter;Exhibit.HtmlTableImporter.load=function(link,database,cont){try{var id=/#(.*)/.exec(link.href)[1];var table=document.getElementById(id);table.style.display="none";Exhibit.HtmlTableImporter.loadTable(table,database);}catch(e){window.console&&console.log&&console.log(e);}finally{if(cont){cont();}}}
Exhibit.HtmlTableImporter.loadTable=function(table,database){var textOf=function(n){return n.textContent||n.innerText||"";};var readAttributes=function(node,attributes){var result={},found=false,attr,value,i;for(i=0;attr=attributes[i];i++){value=Exhibit.getAttribute(node,attr);if(value){result[attr]=value;found=true;}}
return found&&result;}
var typelist=["uri","label","pluralLabel"];var proplist=["uri","valueType","label","reverseLabel","pluralLabel","reversePluralLabel","groupingLabel","reverseGroupingLabel"];var columnProps=["valueParser","arity"];var parsed={};var type=Exhibit.getAttribute(table,'type');var types=type&&readAttributes(table,typelist);if(types){parsed.types={};parsed.types[type]=types;}
var fields=[],props={},columnData=[],row,col;var tr,trs=table.getElementsByTagName("tr");var th,ths=trs[0].getElementsByTagName("th");for(col=0;th=ths[col];col++){var field=textOf(th).trim();var attr=readAttributes(th,proplist);var name=Exhibit.getAttribute(th,'name');if(name){attr=attr||{};attr.label=attr.label||field;field=name;}
if(attr){props[field]=attr;parsed.properties=props;}
fields.push(field);attr=readAttributes(th,columnProps)||{};if(attr.valueParser&&attr.valueParser in window){attr.valueParser=window[attr.valueParser];}else{if(attr.arity=="single"){attr.valueParser=function(text,node,rowNo,colNo){return text.trim();};}else{attr.valueParser=function(text,node,rowNo,colNo){if(text.indexOf(';')==-1)
return text.trim();var data=text.split(';');for(var i=0;i<data.length;i++)
data[i]=data[i].trim();return data;};}}
columnData[col]=attr;}
var img,imgs=table.getElementsByTagName("img");while(img=imgs[0])
img.parentNode.replaceChild(document.createTextNode(img.src),img);var items=[],td,raw;for(row=1;tr=trs[row];row++){var item={};var tds=tr.getElementsByTagName("td");for(col=0;td=tds[col];col++){var raw=textOf(td);data=columnData[col].valueParser(raw,td,row,col);if(data==null||raw===""){continue;}
if(typeof data=='object'&&!(data instanceof Array)){for(var property in data){item[property]=data[property];}}else{item[fields[col]]=data;}}
if(type)
item.type=type;items.push(item);parsed.items=items;}
database.loadData(parsed,Exhibit.Persistence.resolveURL(location.href));};

/* jsonp-importer.js */

Exhibit.JSONPImporter={_callbacks:{}};Exhibit.importers["application/jsonp"]=Exhibit.JSONPImporter;Exhibit.JSONPImporter.load=function(link,database,cont,fConvert,staticJSONPCallback){var url=link;if(typeof link!="string"){url=Exhibit.Persistence.resolveURL(link.href);fConvert=Exhibit.getAttribute(link,'converter');staticJSONPCallback=Exhibit.getAttribute(link,'jsonp-callback');}
if(typeof fConvert=="string"){var name=fConvert;name=name.charAt(0).toLowerCase()+name.substring(1)+'Converter';if(name in Exhibit.JSONPImporter){fConvert=Exhibit.JSONPImporter[name];}else{try{fConvert=eval(fConvert);}catch(e){fConvert=null;}}}
var next=Exhibit.JSONPImporter._callbacks.next||1;Exhibit.JSONPImporter._callbacks.next=next+1;var callbackName="cb"+next.toString(36);var callbackURL=url;if(callbackURL.indexOf("?")==-1)
callbackURL+="?";var lastChar=callbackURL.charAt(callbackURL.length-1);if(lastChar!="="){if(lastChar!='&'&&lastChar!="?")
callbackURL+="&";callbackURL+='callback=';}
var callbackFull="Exhibit.JSONPImporter._callbacks."+callbackName;callbackURL+=callbackFull;var cleanup=function(failedURL){try{Exhibit.UI.hideBusyIndicator();delete Exhibit.JSONPImporter._callbacks[callbackName+"_fail"];delete Exhibit.JSONPImporter._callbacks[callbackName];if(script&&script.parentNode){script.parentNode.removeChild(script);}}finally{if(failedURL){prompt("Failed to load javascript file:",failedURL);cont&&cont(undefined);}}};Exhibit.JSONPImporter._callbacks[callbackName+"_fail"]=cleanup;Exhibit.JSONPImporter._callbacks[callbackName]=function(json){try{cleanup(null);database.loadData(fConvert?fConvert(json,url):json,Exhibit.Persistence.getBaseURL(url));}finally{if(cont)cont(json);}};if(staticJSONPCallback){eval(staticJSONPCallback+"="+callbackFull);}
var fail=callbackFull+"_fail('"+callbackURL+"');";var script=SimileAjax.includeJavascriptFile(document,callbackURL,fail);Exhibit.UI.showBusyIndicator();return Exhibit.JSONPImporter._callbacks[callbackName];};Exhibit.JSONPImporter.transformJSON=function(json,index,mapping,converters){var objects=json,items=[];if(index){index=index.split(".");while(index.length){objects=objects[index.shift()];}}
for(var i=0,object;object=objects[i];i++){var item={};for(var name in mapping){var index=mapping[name];if(!mapping.hasOwnProperty(name)||!object.hasOwnProperty(index))continue;var property=object[index];if(converters&&converters.hasOwnProperty(name)){property=converters[name](property,object,i,objects,json);}
if(typeof property!="undefined"){item[name]=property;}}
items.push(item);}
return items;};Exhibit.JSONPImporter.deliciousConverter=function(json,url){var items=Exhibit.JSONPImporter.transformJSON(json,null,{label:"u",note:"n",description:"d",tags:"t"});return{items:items,properties:{url:{valueType:"url"}}};};Exhibit.JSONPImporter.googleSpreadsheetsConverter=function(json,url){var items=[];var properties={};var types={};var valueTypes={"text":true,"number":true,"item":true,"url":true,"boolean":true};var entries=json.feed.entry;for(var i=0;i<entries.length;i++){var entry=entries[i];var item={label:entry.title.$t};var fields=entry.content.$t;var openBrace=fields.indexOf("{");while(openBrace>=0){var closeBrace=fields.indexOf("}",openBrace+1);if(closeBrace<0){break;}
var fieldSpec=fields.substring(openBrace+1,closeBrace).trim().split(":");openBrace=fields.indexOf("{",closeBrace+1);var fieldValues=openBrace>0?fields.substring(closeBrace+1,openBrace):fields.substr(closeBrace+1);fieldValues=fieldValues.replace(/^\:\s+|,\s+$/g,"");var fieldName=fieldSpec[0].trim();var property=properties[fieldName];if(!(property)){var fieldDetails=fieldSpec.length>1?fieldSpec[1].split(","):[];property={};for(var d=0;d<fieldDetails.length;d++){var detail=fieldDetails[d].trim();var property={single:false};if(detail in valueTypes){property.valueType=detail;}else if(detail=="single"){property.single=true;}}
properties[fieldName]=property;}
if(!property.single){fieldValues=fieldValues.split(";");for(var v=0;v<fieldValues.length;v++){fieldValues[v]=fieldValues[v].trim();}}
item[fieldName]=fieldValues;}
items.push(item);}
return{types:types,properties:properties,items:items};};

/* lens.js */

Exhibit.LensRegistry=function(parentRegistry){this._parentRegistry=parentRegistry;this._defaultLens=null;this._typeToLens={};this._lensSelectors=[];};Exhibit.LensRegistry.prototype.registerDefaultLens=function(elmtOrURL){this._defaultLens=elmtOrURL;};Exhibit.LensRegistry.prototype.registerLensForType=function(elmtOrURL,type){this._typeToLens[type]=elmtOrURL;};Exhibit.LensRegistry.prototype.addLensSelector=function(lensSelector){this._lensSelectors.unshift(lensSelector);};Exhibit.LensRegistry.prototype.getLens=function(itemID,database){for(var i=0;i<this._lensSelectors.length;i++){var lens=this._lensSelectors[i](itemID,database);if(lens!=null){return lens;}}
var type=database.getObject(itemID,"type");if(type in this._typeToLens){return this._typeToLens[type];}
if(this._defaultLens!=null){return this._defaultLens;}
if(this._parentRegistry){return this._parentRegistry.getLens(itemID,database);}
return null;};Exhibit.LensRegistry.prototype.createLens=function(itemID,div,exhibit){var lens=new Exhibit.Lens();var lensTemplate=this.getLens(itemID,exhibit.getDatabase());if(lensTemplate==null){lens._constructDefaultUI(itemID,div,exhibit);}else if(typeof lensTemplate=="string"){lens._constructFromLensTemplateURL(itemID,div,exhibit,lensTemplate);}else{lens._constructFromLensTemplateDOM(itemID,div,exhibit,lensTemplate);}
return lens;};Exhibit.Lens=function(){};Exhibit.Lens._commonProperties=null;Exhibit.Lens.prototype._constructDefaultUI=function(itemID,div,exhibit){var database=exhibit.getDatabase();if(Exhibit.Lens._commonProperties==null){Exhibit.Lens._commonProperties=database.getAllProperties();}
var properties=Exhibit.Lens._commonProperties;var label=database.getObject(itemID,"label");var template={elmt:div,className:"exhibit-lens",children:[{tag:"div",className:"exhibit-lens-title",title:label,children:[{elmt:Exhibit.UI.makeCopyButton(itemID,database),className:"exhibit-copyButton exhibit-lens-copyButton screen"},label+" (",{tag:"a",href:Exhibit.Persistence.getItemLink(itemID),target:"_blank",children:[Exhibit.l10n.itemLinkLabel]},")"]},{tag:"div",className:"exhibit-lens-body",children:[{tag:"table",className:"exhibit-lens-properties",field:"propertiesTable"}]}]};var dom=SimileAjax.DOM.createDOMFromTemplate(document,template);var pairs=Exhibit.ViewPanel.getPropertyValuesPairs(itemID,properties,database);for(var j=0;j<pairs.length;j++){var pair=pairs[j];var tr=dom.propertiesTable.insertRow(j);tr.className="exhibit-lens-property";var tdName=tr.insertCell(0);tdName.className="exhibit-lens-property-name";tdName.innerHTML=pair.propertyLabel+": ";var tdValues=tr.insertCell(1);tdValues.className="exhibit-lens-property-values";if(pair.valueType=="item"){for(var m=0;m<pair.values.length;m++){if(m>0){tdValues.appendChild(document.createTextNode(", "));}
tdValues.appendChild(Exhibit.UI.makeItemSpan(pair.values[m],null,null,exhibit.getLensRegistry(),exhibit));}}else{for(var m=0;m<pair.values.length;m++){if(m>0){tdValues.appendChild(document.createTextNode(", "));}
tdValues.appendChild(Exhibit.UI.makeValueSpan(pair.values[m],pair.valueType));}}}};Exhibit.Lens._compiledTemplates={};Exhibit.Lens._handlers=["onblur","onfocus","onkeydown","onkeypress","onkeyup","onmousedown","onmouseenter","onmouseleave","onmousemove","onmouseout","onmouseover","onmouseup","onclick","onresize","onscroll"];Exhibit.Lens.prototype._constructFromLensTemplateURL=function(itemID,div,exhibit,lensTemplateURL){var job={lens:this,itemID:itemID,div:div,exhibit:exhibit};var compiledTemplate=Exhibit.Lens._compiledTemplates[lensTemplateURL];if(compiledTemplate==null){Exhibit.Lens._startCompilingTemplate(lensTemplateURL,job);}else if(!compiledTemplate.compiled){compiledTemplate.jobs.push(job);}else{job.template=compiledTemplate;Exhibit.Lens._performConstructFromLensTemplateJob(job);}};Exhibit.Lens.prototype._constructFromLensTemplateDOM=function(itemID,div,exhibit,lensTemplateNode){var job={lens:this,itemID:itemID,div:div,exhibit:exhibit};var id=lensTemplateNode.id;if(id==null||id.length==0){id="exhibitLensTemplate"+Math.floor(Math.random()*10000);lensTemplateNode.id=id;}
var compiledTemplate=Exhibit.Lens._compiledTemplates[id];if(compiledTemplate==null){compiledTemplate={url:id,template:Exhibit.Lens._compileTemplate(lensTemplateNode,false),compiled:true,jobs:[]};Exhibit.Lens._compiledTemplates[id]=compiledTemplate;}
job.template=compiledTemplate;Exhibit.Lens._performConstructFromLensTemplateJob(job);};Exhibit.Lens._startCompilingTemplate=function(lensTemplateURL,job){var compiledTemplate={url:lensTemplateURL,template:null,compiled:false,jobs:[job]};Exhibit.Lens._compiledTemplates[lensTemplateURL]=compiledTemplate;var fError=function(statusText,status,xmlhttp){SimileAjax.Debug.log("Failed to load view template from "+lensTemplateURL+"\n"+statusText);};var fDone=function(xmlhttp){try{compiledTemplate.template=Exhibit.Lens._compileTemplate(xmlhttp.responseXML.documentElement,true);compiledTemplate.compiled=true;for(var i=0;i<compiledTemplate.jobs.length;i++){try{var job=compiledTemplate.jobs[i];job.template=compiledTemplate;Exhibit.Lens._performConstructFromLensTemplateJob(job);}catch(e){SimileAjax.Debug.exception("Lens: Error constructing lens template in job queue",e);}}
compiledTemplate.jobs=null;}catch(e){SimileAjax.Debug.exception("Lens: Error compiling lens template and processing template job queue",e);}};SimileAjax.XmlHttp.get(lensTemplateURL,fError,fDone);return compiledTemplate;};Exhibit.Lens._compileTemplate=function(rootNode,isXML){return Exhibit.Lens._processTemplateNode(rootNode,isXML);};Exhibit.Lens._processTemplateNode=function(node,isXML){if(node.nodeType==1){return Exhibit.Lens._processTemplateElement(node,isXML);}else{return node.nodeValue;}};Exhibit.Lens._processTemplateElement=function(elmt,isXML){var templateNode={tag:elmt.tagName,control:null,condition:null,content:null,contentAttributes:null,subcontentAttributes:null,attributes:[],styles:[],handlers:[],children:null};var attributes=elmt.attributes;for(var i=0;i<attributes.length;i++){var attribute=attributes[i];var name=attribute.nodeName;var value=attribute.nodeValue;if(value==null||typeof value!="string"||value.length==0||name=="contentEditable"){continue;}
if(name.length>3&&name.substr(0,3)=="ex:"){name=name.substr(3);if(name=="control"){templateNode.control=value;}else if(name=="content"){templateNode.content=Exhibit.Expression.parse(value);}else if(name=="if-exists"){templateNode.condition={test:"if-exists",expression:Exhibit.Expression.parse(value)};}else if(name=="if"){templateNode.condition={test:"if",expression:Exhibit.Expression.parse(value)};}else if(name=="select"){templateNode.condition={test:"select",expression:Exhibit.Expression.parse(value)};}else if(name=="case"){templateNode.condition={test:"case",value:value};}else{var x=name.indexOf("-content");if(x>0){if(templateNode.contentAttributes==null){templateNode.contentAttributes=[];}
templateNode.contentAttributes.push({name:name.substr(0,x),expression:Exhibit.Expression.parse(value)});}else{x=name.indexOf("-subcontent");if(x>0){if(templateNode.subcontentAttributes==null){templateNode.subcontentAttributes=[];}
templateNode.subcontentAttributes.push({name:name.substr(0,x),fragments:Exhibit.Lens._parseSubcontentAttribute(value)});}}}}else{if(name=="style"){Exhibit.Lens._processStyle(templateNode,value);}else if(name!="id"){if(name=="class"){if(SimileAjax.Platform.browser.isIE){name="className";}}else if(name=="cellspacing"){name="cellSpacing";}else if(name=="cellpadding"){name="cellPadding";}else if(name=="bgcolor"){name="bgColor";}
templateNode.attributes.push({name:name,value:value});}}}
if(!isXML&&SimileAjax.Platform.browser.isIE){var handlers=Exhibit.Lens._handlers;for(var h=0;h<handlers.length;h++){var handler=handlers[h];var code=elmt[handler];if(code!=null){templateNode.handlers.push({name:handler,code:code});}}}
var childNode=elmt.firstChild;if(childNode!=null){templateNode.children=[];while(childNode!=null){templateNode.children.push(Exhibit.Lens._processTemplateNode(childNode,isXML));childNode=childNode.nextSibling;}}
return templateNode;};Exhibit.Lens._processStyle=function(templateNode,styleValue){var styles=styleValue.split(";");for(var s=0;s<styles.length;s++){var pair=styles[s].split(":");if(pair.length>1){var n=pair[0].trim();var v=pair[1].trim();if(n=="float"){n=SimileAjax.Platform.browser.isIE?"styleFloat":"cssFloat";}else if(n=="-moz-opacity"){n="MozOpacity";}else{if(n.indexOf("-")>0){var segments=n.split("-");n=segments[0];for(var x=1;x<segments.length;x++){n+=segments[x].substr(0,1).toUpperCase()+segments[x].substr(1);}}}
templateNode.styles.push({name:n,value:v});}}};Exhibit.Lens._parseSubcontentAttribute=function(value){var fragments=[];var current=0;var open;while(current<value.length&&(open=value.indexOf("{{",current))>=0){var close=value.indexOf("}}",open);if(close<0){break;}
fragments.push(value.substring(current,open));fragments.push(Exhibit.Expression.parse(value.substring(open+2,close)));current=close+2;}
if(current<value.length){fragments.push(value.substr(current));}
return fragments;};Exhibit.Lens._performConstructFromLensTemplateJob=function(job){Exhibit.Lens._constructFromLensTemplateNode({"value":job.itemID},{"value":"item"},job.template.template,job.div,job.exhibit,job);var node=job.div.firstChild;var tagName=node.tagName;if(tagName=="span"){node.style.display="inline";}else{node.style.display="block";}};Exhibit.Lens._constructFromLensTemplateNode=function(roots,rootValueTypes,templateNode,parentElmt,exhibit,job){if(typeof templateNode=="string"){parentElmt.appendChild(document.createTextNode(templateNode));return;}
var database=exhibit.getDatabase();var children=templateNode.children;if(templateNode.condition!=null){if(templateNode.condition.test=="if-exists"){if(!templateNode.condition.expression.testExists(roots,rootValueTypes,"value",database)){return;}}else if(templateNode.condition.test=="if"){if(!templateNode.condition.expression.evaluate(roots,rootValueTypes,"value",database).values.contains(true)){return;}}else if(templateNode.condition.test=="select"){var values=templateNode.condition.expression.evaluate(roots,rootValueTypes,"value",database).values;if(children!=null){var lastChildTemplateNode=null;for(var c=0;c<children.length;c++){var childTemplateNode=children[c];if(childTemplateNode.condition!=null&&childTemplateNode.condition.test=="case"){if(values.contains(childTemplateNode.condition.value)){Exhibit.Lens._constructFromLensTemplateNode(roots,rootValueTypes,childTemplateNode,parentElmt,exhibit,job);return;}}else if(typeof childTemplateNode!="string"){lastChildTemplateNode=childTemplateNode;}}}
if(lastChildTemplateNode!=null){Exhibit.Lens._constructFromLensTemplateNode(roots,rootValueTypes,lastChildTemplateNode,parentElmt,exhibit,job);}
return;}}
var elmt=Exhibit.Lens._constructElmtWithAttributes(templateNode,parentElmt,database);if(templateNode.contentAttributes!=null){var contentAttributes=templateNode.contentAttributes;for(var i=0;i<contentAttributes.length;i++){var attribute=contentAttributes[i];var values=[];attribute.expression.evaluate(roots,rootValueTypes,"value",database).values.visit(function(v){values.push(v);});elmt.setAttribute(attribute.name,values.join(";"));}}
if(templateNode.subcontentAttributes!=null){var subcontentAttributes=templateNode.subcontentAttributes;for(var i=0;i<subcontentAttributes.length;i++){var attribute=subcontentAttributes[i];var fragments=attribute.fragments;var results="";for(var r=0;r<fragments.length;r++){var fragment=fragments[r];if(typeof fragment=="string"){results+=fragment;}else{results+=fragment.evaluateSingle(roots,rootValueTypes,"value",database).value;}}
elmt.setAttribute(attribute.name,results);}}
var handlers=templateNode.handlers;for(var h=0;h<handlers.length;h++){var handler=handlers[h];elmt[handler.name]=handler.code;}
if(templateNode.control!=null){switch(templateNode.control){case"copy-button":elmt.appendChild(Exhibit.UI.makeCopyButton(roots["value"],database));break;case"item-link":var a=document.createElement("a");a.innerHTML=Exhibit.l10n.itemLinkLabel;a.href=Exhibit.Persistence.getItemLink(roots["value"]);a.target="_blank";elmt.appendChild(a);}}else if(templateNode.content!=null){var results=templateNode.content.evaluate(roots,rootValueTypes,"value",database);if(children!=null){var rootValueTypes2={"value":results.valueType,"index":"number"};var index=1;var processOneValue=function(childValue){var roots2={"value":childValue,"index":index++};for(var i=0;i<children.length;i++){Exhibit.Lens._constructFromLensTemplateNode(roots2,rootValueTypes2,children[i],elmt,exhibit,job);}};if(results.values instanceof Array){for(var i=0;i<results.values.length;i++){processOneValue(results.values[i]);}}else{results.values.visit(processOneValue);}}else{Exhibit.Lens._constructDefaultValueList(results.values,results.valueType,elmt,exhibit);}}else if(children!=null){for(var i=0;i<children.length;i++){Exhibit.Lens._constructFromLensTemplateNode(roots,rootValueTypes,children[i],elmt,exhibit,job);}}};Exhibit.Lens._constructElmtWithAttributes=function(templateNode,parentElmt,database){var elmt;switch(templateNode.tag){case"tr":elmt=parentElmt.insertRow(parentElmt.rows.length);break;case"td":elmt=parentElmt.insertCell(parentElmt.cells.length);break;default:elmt=document.createElement(templateNode.tag);parentElmt.appendChild(elmt);}
var attributes=templateNode.attributes;for(var i=0;i<attributes.length;i++){var attribute=attributes[i];elmt.setAttribute(attribute.name,attribute.value);}
var styles=templateNode.styles;for(var i=0;i<styles.length;i++){var style=styles[i];elmt.style[style.name]=style.value;}
return elmt;};Exhibit.Lens._constructDefaultValueList=function(values,valueType,parentElmt,exhibit){var processOneValue=(valueType=="item")?function(value){addDelimiter();parentElmt.appendChild(Exhibit.UI.makeItemSpan(value,null,null,exhibit.getLensRegistry(),exhibit));}:function(value){addDelimiter();parentElmt.appendChild(Exhibit.UI.makeValueSpan(value,valueType));};if(values instanceof Array){var addDelimiter=Exhibit.l10n.createListDelimiter(parentElmt,values.length);for(var i=0;i<values.length;i++){processOneValue(values[i]);}}else{var addDelimiter=Exhibit.l10n.createListDelimiter(parentElmt,values.size());values.visit(processOneValue);}
addDelimiter();};

/* logo.js */

Exhibit.Logo=function(elmt,exhibit){this._exhibit=exhibit;this._elmt=elmt;this._color="Silver";}
Exhibit.Logo.create=function(configuration,elmt,exhibit){var logo=new Exhibit.Logo(elmt,exhibit);if("color"in configuration){this._color=configuration.color;}
Logo._initializeUI();return logo;};Exhibit.Logo.createFromDOM=function(elmt,exhibit){var logo=new Exhibit.Logo(elmt,exhibit);var color=Exhibit.getAttribute(elmt,"color");if(color!=null&&color.length>0){logo._color=color;}
logo._initializeUI();return logo;};Exhibit.Logo.prototype.dispose=function(){this._elmt=null;this._exhibit=null;};Exhibit.Logo.prototype._initializeUI=function(){var logoURL="http://static.simile.mit.edu/graphics/logos/exhibit/exhibit-small-"+this._color+".png";var img=SimileAjax.Graphics.createTranslucentImage(document,logoURL);var a=document.createElement("a");a.href="http://simile.mit.edu/exhibit/";a.title="http://simile.mit.edu/exhibit/";a.target="_blank";a.appendChild(img);this._elmt.appendChild(a);};

/* persistence.js */

Exhibit.Persistence={};Exhibit.Persistence.getBaseURL=function(url){if(url.indexOf("://")<0){var url2=Exhibit.Persistence.getBaseURL(document.location.href);if(url.substr(0,1)=="/"){url=url2.substr(0,url2.indexOf("/",url2.indexOf("://")+3))+url;}else{url=url2+url;}}
var i=url.lastIndexOf("/");if(i<0){return"";}else{return url.substr(0,i+1);}};Exhibit.Persistence.resolveURL=function(url){if(url.indexOf("://")<0){var url2=Exhibit.Persistence.getBaseURL(document.location.href);if(url.substr(0,1)=="/"){url=url2.substr(0,url2.indexOf("/",url2.indexOf("://")+3))+url;}else{url=url2+url;}}
return url;};Exhibit.Persistence.getURLWithoutQueryAndHash=function(){var url;if("_urlWithoutQueryAndHash"in Exhibit){url=Exhibit.Persistence._urlWithoutQueryAndHash;}else{url=document.location.href;var hash=url.indexOf("#");var question=url.indexOf("?");if(question>=0){url=url.substr(0,question);}else if(hash>=0){url=url.substr(0,hash);}
Exhibit.Persistence._urlWithoutQueryAndHash=url;}
return url;};Exhibit.Persistence.getURLWithoutQuery=function(){var url;if("_urlWithoutQuery"in Exhibit.Persistence){url=Exhibit.Persistence._urlWithoutQuery;}else{url=document.location.href;var question=url.indexOf("?");if(question>=0){url=url.substr(0,question);}
Exhibit.Persistence._urlWithoutQuery=url;}
return url;};Exhibit.Persistence.getItemLink=function(itemID){return Exhibit.Persistence.getURLWithoutQueryAndHash()+"#"+encodeURIComponent(itemID);};

/* ui.js */

Exhibit.UI=new Object();Exhibit.UI.docRoot="http://simile.mit.edu/wiki/";Exhibit.UI.validator="http://simile.mit.edu/babel/validator";Exhibit.UI.showHelp=function(message,url,target){target=(target)?target:"_blank";if(url!=null){if(window.confirm(message+"\n\n"+Exhibit.l10n.showDocumentationMessage)){window.open(url,target);}}else{window.alert(message);}};Exhibit.UI.showJavascriptExpressionValidation=function(message,expression){var target="_blank";if(window.confirm(message+"\n\n"+Exhibit.l10n.showJavascriptValidationMessage)){window.open(Exhibit.UI.validator+"?expresson="+encodeURIComponent(expression),target);}};Exhibit.UI.showJsonFileValidation=function(message,url){var target="_blank";if(url.indexOf("file:")==0){if(window.confirm(message+"\n\n"+Exhibit.l10n.showJsonValidationFormMessage)){window.open(Exhibit.UI.validator,target);}}else{if(window.confirm(message+"\n\n"+Exhibit.l10n.showJsonValidationMessage)){window.open(Exhibit.UI.validator+"?url="+url,target);}}};Exhibit.UI._busyIndicator=null;Exhibit.UI._busyIndicatorCount=0;Exhibit.UI.showBusyIndicator=function(){Exhibit.UI._busyIndicatorCount++;if(Exhibit.UI._busyIndicatorCount>1){return;}
if(Exhibit.UI._busyIndicator==null){Exhibit.UI._busyIndicator=Exhibit.Theme.createBusyIndicator();}
var scrollTop=("scrollTop"in document.body)?document.body.scrollTop:document.body.parentNode.scrollTop;var height=("innerHeight"in window)?window.innerHeight:("clientHeight"in document.body?document.body.clientHeight:document.body.parentNode.clientHeight);var top=Math.floor(scrollTop+height/3);Exhibit.UI._busyIndicator.style.top=top+"px";document.body.appendChild(Exhibit.UI._busyIndicator);};Exhibit.UI.hideBusyIndicator=function(){Exhibit.UI._busyIndicatorCount--;if(Exhibit.UI._busyIndicatorCount>0){return;}
try{document.body.removeChild(Exhibit.UI._busyIndicator);}catch(e){}};Exhibit.UI.protectUI=function(elmt){SimileAjax.DOM.appendClassName(elmt,"exhibit-ui-protection");};Exhibit.UI.makeActionLink=function(text,handler,layer){var a=document.createElement("a");a.href="javascript:";a.className="exhibit-action";a.innerHTML=text;var handler2=function(elmt,evt,target){if("true"==elmt.getAttribute("disabled")){SimileAjax.DOM.cancelEvent(evt);return false;}else{return handler(elmt,evt,target);}}
SimileAjax.WindowManager.registerEvent(a,"click",handler2,layer);return a;};Exhibit.UI.makeActionLinkWithObject=function(text,obj,handlerName,layer){var a=document.createElement("a");a.href="javascript:";a.className="exhibit-action";a.innerHTML=text;var handler2=function(elmt,evt,target){if("true"==elmt.getAttribute("disabled")){SimileAjax.DOM.cancelEvent(evt);return false;}else{return obj[handlerName].call(obj,elmt,evt,target);}}
SimileAjax.WindowManager.registerEvent(a,"click",handler2,layer);return a;};Exhibit.UI.enableActionLink=function(a,enabled){a.setAttribute("disabled",enabled?"false":"true");a.className=enabled?"exhibit-action":"exhibit-action-disabled";};Exhibit.UI.makeItemSpan=function(itemID,label,layer,lensRegistry,exhibit){if(label==null){label=database.getObject(itemID,"label");}
if(label==null){label=itemID;}
var a=document.createElement("a");a.href=Exhibit.Persistence.getItemLink(itemID);a.className="exhibit-item";a.innerHTML=label;var handler=function(elmt,evt,target){Exhibit.UI.showItemInPopup(itemID,elmt,lensRegistry,exhibit);SimileAjax.DOM.cancelEvent(evt);return false;}
SimileAjax.WindowManager.registerEvent(a,"click",handler,layer);return a;};Exhibit.UI.makeValueSpan=function(label,valueType,layer){var span=document.createElement("span");span.className="exhibit-value";if(valueType=="url"){var a=document.createElement("a");a.target="_blank";a.href=label;if(label.length>50){a.innerHTML=label.substr(0,20)+" ... "+label.substr(label.length-20);}else{a.innerHTML=label;}
span.appendChild(a);}else{span.innerHTML=label;}
return span;};Exhibit.UI.showItemInPopup=function(itemID,elmt,lensRegistry,exhibit){var coords=SimileAjax.DOM.getPageCoordinates(elmt);var bubble=SimileAjax.Graphics.createBubbleForPoint(document,coords.left+Math.round(elmt.offsetWidth/2),coords.top+Math.round(elmt.offsetHeight/2),400,300);var itemLensDiv=document.createElement("div");var itemLens=lensRegistry.createLens(itemID,itemLensDiv,exhibit);bubble.content.appendChild(itemLensDiv);};Exhibit.UI.makeCopyButton=function(itemID,database,layer){var button=Exhibit.Theme.createCopyButton(false);var handler=function(elmt,evt,target){Exhibit.UI._showCopyMenu(elmt,itemID,database);SimileAjax.DOM.cancelEvent(evt);return false;}
SimileAjax.WindowManager.registerEvent(button,"click",handler,layer!=null?layer:SimileAjax.WindowManager.getHighestLayer());return button;};Exhibit.UI._showCopyMenu=function(elmt,itemID,database){var popupDom=Exhibit.Theme.createPopupMenuDom(elmt);var makeMenuItem=function(exporter){popupDom.appendMenuItem(exporter.getLabel(),null,function(){var text=exporter.exportOne(itemID,database);Exhibit.Theme.createCopyDialogBox(text).open();});}
var exporters=Exhibit.getExporters();for(var i=0;i<exporters.length;i++){makeMenuItem(exporters[i]);}
popupDom.open();};

/* set.js */

Exhibit.Set=function(a){this._hash={};this._count=0;if(a instanceof Array){for(var i=0;i<a.length;i++){this.add(a[i]);}}else if(a instanceof Exhibit.Set){this.addSet(a);}}
Exhibit.Set.prototype.add=function(o){if(!(o in this._hash)){this._hash[o]=true;this._count++;return true;}
return false;}
Exhibit.Set.prototype.addSet=function(set){for(o in set._hash){this.add(o);}}
Exhibit.Set.prototype.remove=function(o){if(o in this._hash){delete this._hash[o];this._count--;return true;}
return false;}
Exhibit.Set.prototype.removeSet=function(set){for(o in set._hash){this.remove(o);}}
Exhibit.Set.prototype.retainSet=function(set){for(o in this._hash){if(!set.contains(o)){delete this._hash[o];this._count--;}}}
Exhibit.Set.prototype.contains=function(o){return(o in this._hash);}
Exhibit.Set.prototype.size=function(){return this._count;}
Exhibit.Set.prototype.toArray=function(){var a=[];for(o in this._hash){a.push(o);}
return a;}
Exhibit.Set.prototype.visit=function(f){for(o in this._hash){if(f(o)==true){break;}}}

/* view-panel.js */

Exhibit.ViewPanel=function(div,exhibit){this._exhibit=exhibit;this._div=div;this._lensRegistry=new Exhibit.LensRegistry(exhibit.getLensRegistry());this._viewConstructors=[];this._viewConfigs=[];this._viewLabels=[];this._viewTooltips=[];this._viewDomConfigs=[];this._viewIndex=0;this._view=null;}
Exhibit.ViewPanel.create=function(configuration,div,exhibit){var viewPanel=new Exhibit.ViewPanel(div,exhibit);if("views"in configuration){for(var i=0;i<configuration.views.length;i++){var viewConfig=configuration.views[i];var viewClass=null;var label=null;var tooltip=null;if("viewClass"in view){viewClass=view.viewClass;}else{viewClass=Exhibit.TileView;}
if("label"in viewConfig){label=viewConfig.label;}else if("l10n"in viewClass&&"viewLabel"in viewClass.l10n){label=viewClass.l10n.viewLabel;}else{label=""+viewClass;}
if("tooltip"in viewConfig){tooltip=viewConfig.tooltip;}else if("l10n"in viewClass&&"viewTooltip"in viewClass.l10n){tooltip=viewClass.l10n.viewTooltip;}else{tooltip=label;}
viewPanel._viewConstructors.push(viewClass);viewPanel._viewConfigs.push(viewConfig);viewPanel._viewLabels.push(label);viewPanel._viewTooltips.push(tooltip);viewPanel._viewDomConfigs.push(null);}}
if("initialView"in configuration){viewPanel._viewIndex=configuration.initialView;}
viewPanel._internalValidate();viewPanel._initializeUI();return viewPanel;};Exhibit.ViewPanel.createFromDOM=function(div,exhibit){var viewPanel=new Exhibit.ViewPanel(div,exhibit);var node=div.firstChild;while(node!=null){if(node.nodeType==1){node.style.display="none";var role=Exhibit.getAttribute(node,"role");if(role=="exhibit-view"){var viewClass=Exhibit.TileView;var viewClassString=Exhibit.getAttribute(node,"viewClass");try{viewClass=eval(viewClassString);}catch(e){Exhibit.showJavascriptExpressionValidation(Exhibit.ViewPanel.l10n.badViewClassMessage(viewClassString),viewClassString);}
var label=Exhibit.getAttribute(node,"label");var tooltip=Exhibit.getAttribute(node,"title");if(label==null){if("viewLabel"in viewClass.l10n){label=viewClass.l10n.viewLabel;}else{label=""+viewClass;}}
if(tooltip==null){if("l10n"in viewClass&&"viewTooltip"in viewClass.l10n){tooltip=viewClass.l10n.viewTooltip;}else{tooltip=label;}}
viewPanel._viewConstructors.push(viewClass);viewPanel._viewConfigs.push(null);viewPanel._viewLabels.push(label);viewPanel._viewTooltips.push(tooltip);viewPanel._viewDomConfigs.push(node);}}
node=node.nextSibling;}
Exhibit.Component.registerLensesFromDOM(div,viewPanel._lensRegistry);var initialView=Exhibit.getAttribute(div,"initialView");if(initialView!=null){try{viewPanel._viewIndex=parseInt(initialView);}catch(e){}}
viewPanel._internalValidate();viewPanel._initializeUI();return viewPanel;};Exhibit.ViewPanel.prototype.dispose=function(){if(this._view!=null){this._view.dispose();this._view=null;}};Exhibit.ViewPanel.prototype._internalValidate=function(){if(this._viewConstructors.length==0){this._viewConstructors.push(Exhibit.TileView);this._viewConfigs.push({});this._viewLabels.push(Exhibit.TileView.l10n.viewLabel);this._viewTooltips.push(Exhibit.TileView.l10n.viewTooltip);this._viewDomConfigs.push(null);}
this._viewIndex=Math.max(0,Math.min(this._viewIndex,this._viewConstructors.length-1));};Exhibit.ViewPanel.prototype._initializeUI=function(){var div=document.createElement("div");if(this._div.firstChild!=null){this._div.insertBefore(div,this._div.firstChild);}else{this._div.appendChild(div);}
var self=this;this._dom=Exhibit.ViewPanel.theme.constructDom(this._exhibit,this._div.firstChild,this._viewLabels,this._viewTooltips,function(index){self._selectView(index);});this._createView();};Exhibit.ViewPanel.prototype._createView=function(){if(this._view){this._view.dispose();}
var viewContainer=this._dom.getViewContainer();viewContainer.innerHTML="";var viewDiv=document.createElement("div");viewContainer.appendChild(viewDiv);var index=this._viewIndex;if(this._viewDomConfigs[index]!=null){this._view=this._viewConstructors[index].createFromDOM(this._viewDomConfigs[index],viewContainer,this._lensRegistry,this._exhibit);}else{this._view=this._viewConstructors[index].create(this._viewConfigs[index],viewContainer,this._lensRegistry,this._exhibit);}
this._dom.setViewIndex(index);};Exhibit.ViewPanel.prototype._selectView=function(newIndex){var oldIndex=this._viewIndex;var self=this;SimileAjax.History.addAction({perform:function(){self._viewIndex=newIndex;self._createView();},undo:function(){self._viewIndex=oldIndex;self._createView();},label:Exhibit.ViewPanel.l10n.createSelectViewActionTitle(self._viewLabels[newIndex]),uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.ViewPanel.resetCollection=function(collection){var state={};SimileAjax.History.addAction({perform:function(){state.restrictions=collection.clearAllRestrictions();},undo:function(){collection.applyRestrictions(state.restrictions);},label:Exhibit.OrderedViewFrame.l10n.resetActionTitle,uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.ViewPanel.getPropertyValuesPairs=function(itemID,propertyEntries,database){var pairs=[];var enterPair=function(propertyID,forward){var property=database.getProperty(propertyID);var values=forward?database.getObjects(itemID,propertyID):database.getSubjects(itemID,propertyID);var count=values.size();if(count>0){var itemValues=property.getValueType()=="item";var pair={propertyLabel:forward?(count>1?property.getPluralLabel():property.getLabel()):(count>1?property.getReversePluralLabel():property.getReverseLabel()),valueType:property.getValueType(),values:[]};if(itemValues){values.visit(function(value){var label=database.getObject(value,"label");pair.values.push(label!=null?label:value);});}else{values.visit(function(value){pair.values.push(value);});}
pairs.push(pair);}};for(var i=0;i<propertyEntries.length;i++){var entry=propertyEntries[i];if(typeof entry=="string"){enterPair(entry,true);}else{enterPair(entry.property,entry.forward);}}
return pairs;};Exhibit.ViewPanel.makeCopyAllButton=function(collection,database,generatedContentElmtRetriever,layer){var button=Exhibit.Theme.createCopyButton(true);var handler=function(elmt,evt,target){Exhibit.ViewPanel._showCopyMenu(elmt,collection,database,generatedContentElmtRetriever);SimileAjax.DOM.cancelEvent(evt);return false;}
SimileAjax.WindowManager.registerEvent(button,"click",handler,layer!=null?layer:SimileAjax.WindowManager.getHighestLayer());return button;};Exhibit.ViewPanel._showCopyMenu=function(elmt,collection,database,generatedContentElmtRetriever){var popupDom=Exhibit.Theme.createPopupMenuDom(elmt);var makeMenuItem=function(exporter){popupDom.appendMenuItem(exporter.getLabel(),null,function(){var text=exporter.exportMany(collection.getRestrictedItems(),database);Exhibit.Theme.createCopyDialogBox(text).open();});}
var exporters=Exhibit.getExporters();for(var i=0;i<exporters.length;i++){makeMenuItem(exporters[i]);}
if(generatedContentElmtRetriever!=null){popupDom.appendMenuItem(Exhibit.l10n.htmlExporterLabel,null,function(){Exhibit.Theme.createCopyDialogBox(generatedContentElmtRetriever().innerHTML).open();});}
popupDom.open();};

/* map-view.js */

Exhibit.MapView=function(collection,containerElmt,lensRegistry,exhibit){this._collection=collection;this._div=containerElmt;this._lensRegistry=lensRegistry;this._exhibit=exhibit;this._mapSettings={maxAutoZoom:18,size:"small",scaleControl:true,overviewControl:false,type:"normal"};this._latlngCache=new Object();this._markerKeyCache=new Object();this._markerCache=new Object();this._maxMarker=0;this._getLatLng=function(itemID,database){return{};};this._getMarkerKey=function(itemID,database){return"";};this._constructMap=null;var view=this;this._listener={onItemsChanged:function(){view._reconstruct();}};collection.addListener(this._listener);};Exhibit.MapView.create=function(configuration,containerElmt,lensRegistry,exhibit){var collection=Exhibit.Collection.getCollection(configuration,exhibit);var lensRegistry2=Exhibit.Component.createLensRegistry(configuration,lensRegistry);var view=new Exhibit.MapView(collection,containerElmt!=null?containerElmt:configElmt,lensRegistry2,exhibit);Exhibit.MapView._configure(view,configuration);view._initializeUI();return view;};Exhibit.MapView.createFromDOM=function(configElmt,containerElmt,lensRegistry,exhibit){var configuration=Exhibit.getConfigurationFromDOM(configElmt);var collection=Exhibit.Collection.getCollectionFromDOM(configElmt,configuration,exhibit);var lensRegistry2=Exhibit.Component.createLensRegistryFromDOM(configElmt,configuration,lensRegistry);var view=new Exhibit.MapView(collection,containerElmt!=null?containerElmt:configElmt,lensRegistry2,exhibit);try{var maxAZ=Exhibit.getAttribute(configElmt,"maxAutoZoom");if(maxAZ!=null&&maxAZ.length>0){maxAZ=Exhibit.Expression.parse(maxAZ);}else{maxAZ=null;}
var latlng=Exhibit.getAttribute(configElmt,"latlng");if(latlng!=null&&latlng.length>0){view._getLatLng=Exhibit.MapView._makeGetLatLng(latlng,maxAZ);}else{var lat=Exhibit.getAttribute(configElmt,"lat");var lng=Exhibit.getAttribute(configElmt,"lng");if(lat!=null&&lng!=null&&lat.length>0&&lng.length>0){view._getLatLng=Exhibit.MapView._makeGetLatLng2(lat,lng,maxAZ);}}}catch(e){SimileAjax.Debug.exception("MapView: Error processing lat/lng configuration of map view",e);}
try{var marker=Exhibit.getAttribute(configElmt,"marker");if(marker!=null&&marker.length>0){view._getMarkerKey=Exhibit.MapView._makeGetMarker(marker);}}catch(e){SimileAjax.Debug.exception("MapView: Error processing marker configuration of map view",e);}
var s=Exhibit.getAttribute(configElmt,"center",",");if(s!=null&&s.length==2){s[0]=parseFloat(s[0]);s[1]=parseFloat(s[1]);if(typeof s[0]=="number"&&typeof s[1]=="number"){view._mapSettings.center=s;}}
s=Exhibit.getAttribute(configElmt,"zoom");if(s!=null&&s.length>0){view._mapSettings.zoom=parseInt(s);}
s=Exhibit.getAttribute(configElmt,"size");if(s!=null&&s.length>0){view._mapSettings.size=s;}
s=Exhibit.getAttribute(configElmt,"scaleControl");if(s!=null&&s.length>0){view._mapSettings.scaleControl=(s=="true");}
s=Exhibit.getAttribute(configElmt,"overviewControl");if(s!=null&&s.length>0){view._mapSettings.overviewControl=(s=="true");}
s=Exhibit.getAttribute(configElmt,"type");if(s!=null&&s.length>0){view._mapSettings.type=s;}
view._initializeUI();return view;};Exhibit.MapView._configure=function(view,configuration){try{if("latlng"in configuration){view._getLatLng=Exhibit.MapView._makeGetLatLng(configuration.latlng);}else if("lat"in configuration&&"lng"in configuration){view._getLatLng=Exhibit.MapView._makeGetLatLng2(configuration.lat,configuration.lng);}}catch(e){SimileAjax.Debug.exception("MapView: Error processing lat/lng configuration of map view",e);}
try{if("marker"in configuration){view._getMarkerKey=Exhibit.MapView._makeGetMarker(configuration.marker);}}catch(e){SimileAjax.Debug.exception("MapView: Error processing marker configuration of map view",e);}
if("center"in configuration){view._mapSettings.center=configuration.center;}
if("zoom"in configuration){view._mapSettings.zoom=configuration.zoom;}
if("maxAutoZoom"in configuration){view._mapSettings.maxAutoZoom=configuration.maxAutoZoom;}
if("size"in configuration){view._mapSettings.size=configuration.size;}
if("scaleControl"in configuration){view._mapSettings.scaleControl=configuration.scaleControl;}
if("type"in configuration){view._mapSettings.type=configuration.type;}};Exhibit.MapView._makeGetLatLng=function(s,mazExpression){var latlngExpression=Exhibit.Expression.parse(s);return function(itemID,database){var result={};var x=Exhibit.MapView.evaluateSingle(latlngExpression,itemID,database);if(x!=null){var a=x.split(",");if(a.length==2){result.lat=(typeof a[0]=="number")?a[0]:parseFloat(a[0]);result.lng=(typeof a[1]=="number")?a[1]:parseFloat(a[1]);}}
var z=mazExpression&&Exhibit.MapView.evaluateSingle(mazExpression,itemID,database);if(z!=null){z=parseInt(z,10);if(typeof z=="number")
result.maxAutoZoom=z;}
return result;};};Exhibit.MapView._makeGetLatLng2=function(lat,lng,mazExpression){var latExpression=Exhibit.Expression.parse(lat);var lngExpression=Exhibit.Expression.parse(lng);return function(itemID,database){var result={};var lat=Exhibit.MapView.evaluateSingle(latExpression,itemID,database);var lng=Exhibit.MapView.evaluateSingle(lngExpression,itemID,database);if(lat!=null&&lng!=null){result.lat=(typeof lat=="number")?lat:parseFloat(lat);result.lng=(typeof lng=="number")?lng:parseFloat(lng);}
var z=mazExpression&&Exhibit.MapView.evaluateSingle(mazExpression,itemID,database);if(z!=null){z=parseInt(z,10);if(typeof z=="number")
result.maxAutoZoom=z;}
return result;}};Exhibit.MapView._makeGetMarker=function(s){var markerExpression=Exhibit.Expression.parse(s);return function(itemID,database){var key=Exhibit.MapView.evaluateSingle(markerExpression,itemID,database);return key!=null?key:"";};};Exhibit.MapView._markers=[{color:"FF9000"},{color:"5D7CBA"},{color:"A97838"},{color:"8B9BBA"},{color:"FFC77F"},{color:"003EBA"},{color:"29447B"},{color:"543C1C"}];Exhibit.MapView._wildcardMarker={color:"888888"};Exhibit.MapView._mixMarker={color:"FFFFFF"};Exhibit.MapView.evaluateSingle=function(expression,itemID,database){return expression.evaluateSingle({"value":itemID},{"value":"item"},"value",database).value;}
Exhibit.MapView.lookupLatLng=function(set,addressExpressionString,outputProperty,outputTextArea,database,accuracy){if(accuracy==undefined){accuracy=4;}
var expression=Exhibit.Expression.parse(addressExpressionString);var jobs=[];set.visit(function(item){var address=Exhibit.MapView.evaluateSingle(expression,item,database);if(address!=null){jobs.push({item:item,address:address});}});var results=[];var geocoder=new GClientGeocoder();var cont=function(){if(jobs.length>0){var job=jobs.shift();geocoder.getLocations(job.address,function(json){if("Placemark"in json){json.Placemark.sort(function(p1,p2){return p2.AddressDetails.Accuracy-p1.AddressDetails.Accuracy;});}
if("Placemark"in json&&json.Placemark.length>0&&json.Placemark[0].AddressDetails.Accuracy>=accuracy){var coords=json.Placemark[0].Point.coordinates;var lat=coords[1];var lng=coords[0];results.push("\t{ id: '"+job.item+"', "+outputProperty+": '"+lat+","+lng+"' }");}else{var segments=job.address.split(",");if(segments.length==1){results.push("\t{ id: '"+job.item+"' }");}else{job.address=segments.slice(1).join(",").replace(/^\s+/,"");jobs.unshift(job);}}
cont();});}else{outputTextArea.value=results.join(",\n");}};cont();};Exhibit.MapView.prototype.dispose=function(){this._collection.removeListener(this._listener);this._div.innerHTML="";this._dom.map=null;this._dom=null;this._div=null;this._collection=null;this._exhibit=null;GUnload();};Exhibit.MapView.prototype._initializeUI=function(){var self=this;this._div.innerHTML="";this._dom=Exhibit.MapView.theme.constructDom(this._collection,this._exhibit,this._div,function(elmt,evt,target){Exhibit.ViewPanel.resetCollection(self._collection);SimileAjax.DOM.cancelEvent(evt);return false;});var mapDiv=this._dom.getMapDiv();mapDiv.style.height="400px";if(this._constructMap!=null){this._dom.map=this._constructMap(mapDiv);}else{var settings=this._mapSettings;this._dom.map=new GMap2(mapDiv);this._dom.map.enableDoubleClickZoom();this._dom.map.enableContinuousZoom();this._dom.map.setCenter(new GLatLng(20,0),2);this._dom.map.addControl(settings.size=="small"?new GSmallMapControl():new GLargeMapControl());if(settings.overviewControl){this._dom.map.addControl(new GOverviewMapControl);}
if(settings.scaleControl){this._dom.map.addControl(new GScaleControl());}
this._dom.map.addControl(new GMapTypeControl());switch(settings.type){case"normal":this._dom.map.setMapType(G_NORMAL_MAP);break;case"satellite":this._dom.map.setMapType(G_SATELLITE_MAP);break;case"hybrid":this._dom.map.setMapType(G_HYBRID_MAP);break;}}
this._reconstruct();};Exhibit.MapView.prototype._reconstruct=function(){var self=this;var exhibit=this._exhibit;var database=exhibit.getDatabase();var originalSize=this._collection.countAllItems();var currentSize=this._collection.countRestrictedItems();var mappableSize=0;this._dom.map.clearOverlays();this._dom.clearLegend();if(currentSize>0){var currentSet=this._collection.getRestrictedItems();var locationToData={};currentSet.visit(function(itemID){var latlng;if(itemID in self._latlngCache){latlng=self._latlngCache[itemID];}else{latlng=self._getLatLng(itemID,database);self._latlngCache[itemID]=latlng;}
if("lat"in latlng&&"lng"in latlng){var markerKey;if(itemID in self._markerKeyCache){markerKey=self._markerKeyCache[itemID];}else{markerKey=self._getMarkerKey(itemID,database);self._markerKeyCache[itemID]=markerKey;}
var latlngKey=latlng.lat+","+latlng.lng;var locationData=locationToData[latlngKey];if(!(locationData)){locationData={latlng:latlng,items:[],markerKey:markerKey};locationToData[latlngKey]=locationData;}else if(locationData.markerKey!=markerKey){locationData.markerKey=null;}
locationData.items.push(itemID);mappableSize++;}});var usedKeys={};var shape=Exhibit.MapView._defaultMarkerShape;var bounds,maxAutoZoom=Infinity;var addMarkerAtLocation=function(locationData){var items=locationData.items;if(!bounds){bounds=new GLatLngBounds();}
var markerData;if(locationData.markerKey==null){markerData=Exhibit.MapView._mixMarker;}else{usedKeys[locationData.markerKey]=true;if(locationData.markerKey in self._markerCache){markerData=self._markerCache[locationData.markerKey];}else{markerData=Exhibit.MapView._markers[self._maxMarker];self._markerCache[locationData.markerKey]=markerData;self._maxMarker=(self._maxMarker+1)%Exhibit.MapView._markers.length;}}
var icon;if(items.length==1){if(!("icon"in markerData)){markerData.icon=Exhibit.MapView._makeIcon(shape,markerData.color,"space");}
icon=markerData.icon;}else{icon=Exhibit.MapView._makeIcon(shape,markerData.color,locationData.items.length>50?"...":locationData.items.length);}
var point=new GLatLng(locationData.latlng.lat,locationData.latlng.lng);var marker=new GMarker(point,icon);if(maxAutoZoom>locationData.latlng.maxAutoZoom)
maxAutoZoom=locationData.latlng.maxAutoZoom;bounds.extend(point);GEvent.addListener(marker,"click",function(){self._dom.map.openInfoWindow(marker.getPoint(),self._createInfoWindow(items));});self._dom.map.addOverlay(marker);}
for(latlngKey in locationToData){addMarkerAtLocation(locationToData[latlngKey]);}
if(bounds&&typeof this._mapSettings.zoom=="undefined"){var zoom=Math.max(0,self._dom.map.getBoundsZoomLevel(bounds)-1);zoom=Math.min(zoom,maxAutoZoom,this._mapSettings.maxAutoZoom);self._dom.map.setZoom(zoom);}
if(bounds&&typeof this._mapSettings.center=="undefined")
self._dom.map.setCenter(bounds.getCenter());var legendLabels=[];var legendIcons=[];var shape=Exhibit.MapView._defaultMarkerShape;for(markerKey in this._markerCache){if(markerKey in usedKeys){var markerData=this._markerCache[markerKey];legendLabels.push(markerKey);legendIcons.push(Exhibit.MapView._markerUrlPrefix+
[shape,markerData.color,["m",shape,markerData.color,"legend.png"].join("-")].join("/"));}}
legendLabels.push(Exhibit.MapView.l10n.mixedLegendKey);legendIcons.push(Exhibit.MapView._markerUrlPrefix+
[shape,"FFFFFF",["m",shape,"FFFFFF","legend.png"].join("-")].join("/"));this._dom.addLegendBlock(Exhibit.MapView.theme.constructLegendBlockDom(this._exhibit,Exhibit.MapView.l10n.colorLegendTitle,legendIcons,legendLabels));this._dom.setTypes(database.getTypeLabels(currentSet)[currentSize>1?1:0]);}
this._dom.setCounts(currentSize,mappableSize,originalSize);};Exhibit.MapView.prototype._createInfoWindow=function(items){if(items.length>1){var ul=document.createElement("ul");for(var i=0;i<items.length;i++){var li=document.createElement("li");li.appendChild(Exhibit.UI.makeItemSpan(items[i],null,null,this._lensRegistry,this._exhibit));ul.appendChild(li);}
return ul;}else{var itemLensDiv=document.createElement("div");var itemLens=this._lensRegistry.createLens(items[0],itemLensDiv,this._exhibit);return itemLensDiv;}};Exhibit.MapView._iconData=null;Exhibit.MapView._markerUrlPrefix="http://static.simile.mit.edu/graphics/maps/markers/";Exhibit.MapView._defaultMarkerShape="square";Exhibit.MapView._makeIcon=function(shape,color,label){if(Exhibit.MapView._iconData==null){Exhibit.MapView._iconData={iconSize:new GSize(40,35),iconAnchor:new GPoint(20,35),shadowSize:new GSize(55,40),infoWindowAnchor:new GPoint(19,1),imageMap:[6,0,6,22,15,22,20,34,25,25,34,22,34,0]};}
var data=Exhibit.MapView._iconData;var icon=new GIcon(G_DEFAULT_ICON);icon.image=Exhibit.MapView._markerUrlPrefix+
[shape,color,["m",shape,color,label+".png"].join("-")].join("/");icon.shadow=Exhibit.MapView._markerUrlPrefix+["m",shape,"shadow.png"].join("-");icon.iconSize=data.iconSize;icon.iconAnchor=data.iconAnchor;icon.imageMap=data.imageMap;icon.shadowSize=data.shadowSize;icon.infoWindowAnchor=data.infoWindowAnchor;return icon;};

/* ordered-view-frame.js */

Exhibit.OrderedViewFrame=function(collection,exhibit){this._collection=collection;this._exhibit=exhibit;this._orders=null;this._possibleOrders=null;this._initialCount=10;this._showAll=false;this._grouped=true;this._showDuplicates=false;};Exhibit.OrderedViewFrame.prototype.configure=function(configuration){if("orders"in configuration){this._orders=[];this._configureOrders(configuration.orders);}
if("possibleOrders"in configuration){this._possibleOrders=[];this._configurePossibleOrders(configuration.possibleOrders);}
if("initialCount"in configuration){this._initialCount=configuration.initialCount;}
if("showAll"in configuration){this._showAll=configuration.showAll;}
if("grouped"in configuration){this._grouped=configuration.grouped;}
if("showDuplicates"in configuration){this._showDuplicates=configuration.showDuplicates;}
this._internalValidate();};Exhibit.OrderedViewFrame.prototype.configureFromDOM=function(domConfiguration){var orders=Exhibit.getAttribute(domConfiguration,"orders",",");if(orders!=null&&orders.length>0){this._orders=[];this._configureOrders(orders);}
var directions=Exhibit.getAttribute(domConfiguration,"directions",",");if(directions!=null&&directions.length>0){for(var i=0;i<directions.length&&i<this._orders.length;i++){this._orders[i].ascending=(directions[i].toLowerCase()!="descending");}}
var possibleOrders=Exhibit.getAttribute(domConfiguration,"possibleOrders",",");if(possibleOrders!=null&&possibleOrders.length>0){this._possibleOrders=[];this._configurePossibleOrders(possibleOrders);}
var possibleDirections=Exhibit.getAttribute(domConfiguration,"possibleDirections",",");if(possibleDirections!=null&&possibleDirections.length>0){for(var i=0;i<possibleDirections.length&&i<this._possibleOrders.length;i++){this._possibleOrders.ascending=(possibleDirections[i].toLowerCase()!="descending");}}
var initialCount=Exhibit.getAttribute(domConfiguration,"initialCount");if(initialCount!=null&&initialCount.length>0){this._initialCount=parseInt(initialCount);}
var showAll=Exhibit.getAttribute(domConfiguration,"showAll");if(showAll!=null&&showAll.length>0){this._showAll=(showAll=="true");}
var grouped=Exhibit.getAttribute(domConfiguration,"grouped");if(grouped!=null&&grouped.length>0){this._grouped=(grouped=="true");}
var showDuplicates=Exhibit.getAttribute(domConfiguration,"showDuplicates");if(showDuplicates!=null&&showDuplicates.length>0){this._showDuplicates=(showDuplicates=="true");}
this._internalValidate();}
Exhibit.OrderedViewFrame.prototype._internalValidate=function(){if(this._possibleOrders==null){this._possibleOrders=[{property:"label",forward:true,ascending:true}];}
if(this._orders==null){this._orders=[this._possibleOrders[0]];}};Exhibit.OrderedViewFrame.prototype.dispose=function(){this._headerDom=null;this._footerDom=null;this._divHeader.innerHTML="";this._divFooter.innerHTML="";this._divHeader=null;this._divFooter=null;this._exhibit=null;};Exhibit.OrderedViewFrame.prototype._configureOrders=function(orders){for(var i=0;i<orders.length;i++){var order=orders[i];var expr;var ascending=true;if(typeof order=="string"){expr=order;}else{expr=order.expression,ascending=("ascending"in order)?(order.ascending):true;}
var expression=Exhibit.Expression.parse(expr);if(expression.isPath()){var path=expression.getPath();if(path.getSegmentCount()==1){var segment=path.getSegment(0);this._orders.push({property:segment.property,forward:segment.forward,ascending:ascending});}}}};Exhibit.OrderedViewFrame.prototype._configurePossibleOrders=function(possibleOrders){var hasLabel=false;for(var i=0;i<possibleOrders.length;i++){var order=possibleOrders[i];var expr;var ascending=true;if(typeof order=="string"){expr=order;}else{expr=order.expression,ascending=("ascending"in order)?(order.ascending):true;}
var expression=Exhibit.Expression.parse(expr);if(expression.isPath()){var path=expression.getPath();if(path.getSegmentCount()==1){var segment=path.getSegment(0);this._possibleOrders.push({property:segment.property,forward:segment.forward,ascending:ascending});if(segment.property=="label"&&segment.forward){hasLabel=true;}}}}
if(!hasLabel){this._possibleOrders.push({property:"label",forward:true,ascending:true});}};Exhibit.OrderedViewFrame.prototype.initializeUI=function(){this._divHeader.innerHTML="";this._divFooter.innerHTML="";var self=this;this._headerDom=Exhibit.OrderedViewFrame.theme.createHeaderDom(this._collection,this._exhibit,this._divHeader,function(elmt,evt,target){Exhibit.ViewPanel.resetCollection(self._collection);SimileAjax.DOM.cancelEvent(evt);return false;},function(elmt,evt,target){self._openSortPopup(elmt,-1);SimileAjax.DOM.cancelEvent(evt);return false;},function(elmt,evt,target){self._toggleGroup();SimileAjax.DOM.cancelEvent(evt);return false;},function(elmt,evt,target){self._toggleShowDuplicates();SimileAjax.DOM.cancelEvent(evt);return false;},this._generatedContentElmtRetriever);this._footerDom=Exhibit.OrderedViewFrame.theme.createFooterDom(this._exhibit,this._divFooter,function(elmt,evt,target){self._setShowAll(true);SimileAjax.DOM.cancelEvent(evt);return false;},function(elmt,evt,target){self._setShowAll(false);SimileAjax.DOM.cancelEvent(evt);return false;});};Exhibit.OrderedViewFrame.prototype.reconstruct=function(){var self=this;var exhibit=this._exhibit;var database=exhibit.getDatabase();var originalSize=this._collection.countAllItems();var currentSize=this._collection.countRestrictedItems();this._headerDom.setCounts(currentSize,originalSize);this._headerDom.setGrouped(this._grouped);this._headerDom.setShowDuplicates(this._showDuplicates);var hasSomeGrouping=false;if(currentSize>0){var currentSet=this._collection.getRestrictedItems();this._headerDom.setTypes(database.getTypeLabels(currentSet)[currentSize>1?1:0]);hasSomeGrouping=this._internalReconstruct(currentSet);var orderDoms=[];var buildOrderDom=function(order,index){var property=database.getProperty(order.property);var orderDom=Exhibit.OrderedViewFrame.theme.createOrderDom(exhibit,(order.forward)?property.getPluralLabel():property.getReversePluralLabel(),function(elmt,evt,target){self._openSortPopup(elmt,index);SimileAjax.DOM.cancelEvent(evt);return false;});orderDoms.push(orderDom);};for(var i=0;i<this._orders.length;i++){buildOrderDom(this._orders[i],i);}
this._headerDom.setOrders(orderDoms);this._headerDom.enableThenByAction(orderDoms.length<this._possibleOrders.length);}
this._footerDom.setCounts(currentSize,this._initialCount,this._showAll,!(hasSomeGrouping&&this._grouped));};Exhibit.OrderedViewFrame.prototype._internalReconstruct=function(allItems){var self=this;var exhibit=this._exhibit;var database=exhibit.getDatabase();var orders=this._orders;var itemIndex=0;var hasSomeGrouping=false;var createItem=function(itemID){if((hasSomeGrouping&&self._grouped)||self._showAll||itemIndex<self._initialCount){self.onNewItem(itemID,itemIndex++);}};var createGroup=function(label,valueType,index){if((hasSomeGrouping&&self._grouped)||self._showAll||itemIndex<self._initialCount){self.onNewGroup(label,valueType,index);}};var processLevel=function(items,index){var order=orders[index];var values=order.forward?database.getObjectsUnion(items,order.property):database.getSubjectsUnion(items,order.property);var valueType="text";if(order.forward){var property=database.getProperty(order.property);valueType=property!=null?property.getValueType():"text";}else{valueType="item";}
var keys=(valueType=="item"||valueType=="text")?processNonNumericLevel(items,index,values,valueType):processNumericLevel(items,index,values,valueType);var grouped=false;for(var k=0;k<keys.length;k++){if(keys[k].items.size()>1){grouped=true;}}
if(grouped){hasSomeGrouping=true;}
for(var k=0;k<keys.length;k++){var key=keys[k];if(key.items.size()>0){if(grouped&&self._grouped){createGroup(key.display,valueType,index);}
items.removeSet(key.items);if(key.items.size()>1&&index<orders.length-1){processLevel(key.items,index+1);}else{key.items.visit(createItem);}}}
if(items.size()>0){if(grouped&&self._grouped){createGroup(Exhibit.l10n.missingSortKey,valueType,index);}
if(items.size()>1&&index<orders.length-1){processLevel(items,index+1);}else{items.visit(createItem);}}};var processNonNumericLevel=function(items,index,values,valueType){var keys=[];var compareKeys;var retrieveItems;var order=orders[index];if(valueType=="item"){values.visit(function(itemID){var label=database.getObject(itemID,"label");label=label!=null?label:itemID;keys.push({itemID:itemID,display:label});});compareKeys=function(key1,key2){var c=key1.display.localeCompare(key2.display);return c!=0?c:key1.itemID.localeCompare(key2.itemID);};retrieveItems=order.forward?function(key){return database.getSubjects(key.itemID,order.property,null,items);}:function(key){return database.getObjects(key.itemID,order.property,null,items);};}else{values.visit(function(value){keys.push({display:value});});compareKeys=function(key1,key2){return key1.display.localeCompare(key2.display);};retrieveItems=order.forward?function(key){return database.getSubjects(key.display,order.property,null,items);}:function(key){return database.getObjects(key.display,order.property,null,items);};}
keys.sort(function(key1,key2){return(order.ascending?1:-1)*compareKeys(key1,key2);});for(var k=0;k<keys.length;k++){var key=keys[k];key.items=retrieveItems(key);if(!self._showDuplicates){items.removeSet(key.items);}}
return keys;};var processNumericLevel=function(items,index,values,valueType){var keys=[];var keyMap={};var order=orders[index];var valueParser;if(valueType=="number"){valueParser=function(value){if(typeof value=="number"){return value;}else{try{return parseFloat(value);}catch(e){return null;}}};}else{valueParser=function(value){if(value instanceof Date){return value.getTime();}else{try{return SimileAjax.DateTime.parseIso8601DateTime(value.toString()).getTime();}catch(e){return null;}}};}
values.visit(function(value){var sortkey=valueParser(value);if(sortkey!=null){var key=keyMap[sortkey];if(!key){key={sortkey:sortkey,display:value,values:[],items:new Exhibit.Set()};keyMap[sortkey]=key;keys.push(key);}
key.values.push(value);}});keys.sort(function(key1,key2){return(order.ascending?1:-1)*(key1.sortkey-key2.sortkey);});for(var k=0;k<keys.length;k++){var key=keys[k];var values=key.values;for(var v=0;v<values.length;v++){if(order.forward){database.getSubjects(values[v],order.property,key.items,items);}else{database.getObjects(values[v],order.property,key.items,items);}}
if(!self._showDuplicates){items.removeSet(key.items);}}
return keys;};processLevel(allItems,0);return hasSomeGrouping;};Exhibit.OrderedViewFrame.prototype._openSortPopup=function(elmt,index){var self=this;var database=this._exhibit.getDatabase();var popupDom=Exhibit.Theme.createPopupMenuDom(elmt);if(index>=0){var order=this._orders[index];var property=database.getProperty(order.property);var propertyLabel=order.forward?property.getPluralLabel():property.getReversePluralLabel();var valueType=order.forward?property.getValueType():"item";var sortLabels=Exhibit.Database.l10n.sortLabels[valueType];sortLabels=(sortLabels!=null)?sortLabels:Exhibit.Database.l10n.sortLabels["text"];popupDom.appendMenuItem(sortLabels.ascending,Exhibit.Theme.urlPrefix+
(order.ascending?"images/option-check.png":"images/option.png"),order.ascending?function(){}:function(){self._reSort(index,order.property,order.forward,true,false);});popupDom.appendMenuItem(sortLabels.descending,Exhibit.Theme.urlPrefix+
(order.ascending?"images/option.png":"images/option-check.png"),order.ascending?function(){self._reSort(index,order.property,order.forward,false,false);}:function(){});if(this._orders.length>1){popupDom.appendSeparator();popupDom.appendMenuItem(Exhibit.OrderedViewFrame.l10n.removeOrderLabel,null,function(){self._removeOrder(index);});}}
var orders=[];for(var i=0;i<this._possibleOrders.length;i++){var possibleOrder=this._possibleOrders[i];var skip=false;for(var j=(index<0)?this._orders.length-1:index;j>=0;j--){var existingOrder=this._orders[j];if(existingOrder.property==possibleOrder.property&&existingOrder.forward==possibleOrder.forward){skip=true;break;}}
if(!skip){var property=database.getProperty(possibleOrder.property);orders.push({property:possibleOrder.property,forward:possibleOrder.forward,ascending:possibleOrder.ascending,label:possibleOrder.forward?property.getPluralLabel():property.getReversePluralLabel()});}}
if(orders.length>0){if(index>=0){popupDom.appendSeparator();}
orders.sort(function(order1,order2){return order1.label.localeCompare(order2.label);});var appendOrder=function(order){popupDom.appendMenuItem(order.label,null,function(){self._reSort(index,order.property,order.forward,order.ascending,true);});}
for(var i=0;i<orders.length;i++){appendOrder(orders[i]);}}
popupDom.open();};Exhibit.OrderedViewFrame.prototype._reSort=function(index,propertyID,forward,ascending,slice){index=(index<0)?this._orders.length:index;var oldOrders=this._orders;var newOrders=this._orders.slice(0,index);newOrders.push({property:propertyID,forward:forward,ascending:ascending});if(!slice){newOrders=newOrders.concat(oldOrders.slice(index+1));}
var property=this._exhibit.getDatabase().getProperty(propertyID);var propertyLabel=forward?property.getPluralLabel():property.getReversePluralLabel();var valueType=forward?property.getValueType():"item";var sortLabels=Exhibit.Database.l10n.sortLabels[valueType];sortLabels=(sortLabels!=null)?sortLabels:Exhibit.Database.l10n.sortLabels["text"];var self=this;SimileAjax.History.addAction({perform:function(){self._orders=newOrders;self.parentReconstruct();},undo:function(){self._orders=oldOrders;self.parentReconstruct();},label:Exhibit.OrderedViewFrame.l10n.formatSortActionTitle(propertyLabel,ascending?sortLabels.ascending:sortLabels.descending),uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.OrderedViewFrame.prototype._removeOrder=function(index){var oldOrders=this._orders;var newOrders=this._orders.slice(0,index).concat(this._orders.slice(index+1));var order=oldOrders[index];var property=this._exhibit.getDatabase().getProperty(order.property);var propertyLabel=order.forward?property.getPluralLabel():property.getReversePluralLabel();var valueType=order.forward?property.getValueType():"item";var sortLabels=Exhibit.Database.l10n.sortLabels[valueType];sortLabels=(sortLabels!=null)?sortLabels:Exhibit.Database.l10n.sortLabels["text"];var self=this;SimileAjax.History.addAction({perform:function(){self._orders=newOrders;self.parentReconstruct();},undo:function(){self._orders=oldOrders;self.parentReconstruct();},label:Exhibit.OrderedViewFrame.l10n.formatRemoveOrderActionTitle(propertyLabel,order.ascending?sortLabels.ascending:sortLabels.descending),uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.OrderedViewFrame.prototype._setShowAll=function(showAll){this._showAll=showAll;this.parentReconstruct();};Exhibit.OrderedViewFrame.prototype._toggleGroup=function(){var oldGrouped=this._grouped;var self=this;SimileAjax.History.addAction({perform:function(){self._grouped=!oldGrouped;self.parentReconstruct();},undo:function(){self._grouped=oldGrouped;self.parentReconstruct();},label:Exhibit.OrderedViewFrame.l10n[oldGrouped?"ungroupActionTitle":"groupAsSortedActionTitle"],uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.OrderedViewFrame.prototype._toggleShowDuplicates=function(){var oldShowDuplicates=this._showDuplicates;var self=this;SimileAjax.History.addAction({perform:function(){self._showDuplicates=!oldShowDuplicates;self.parentReconstruct();},undo:function(){self._showDuplicates=oldShowDuplicates;self.parentReconstruct();},label:Exhibit.OrderedViewFrame.l10n[oldShowDuplicates?"hideDuplicatesActionTitle":"showDuplicatesActionTitle"],uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};

/* pivot-table-view.js */

Exhibit.PivotTableView=function(collection,containerElmt,lensRegistry,exhibit){this._collection=collection;this._div=containerElmt;this._lensRegistry=lensRegistry;this._exhibit=exhibit;this._rowPath=null;this._columnPath=null;this._cellExpression=null;this._settings={};var view=this;this._listener={onItemsChanged:function(){view._reconstruct();}};collection.addListener(this._listener);};Exhibit.PivotTableView.create=function(configuration,containerElmt,lensRegistry,exhibit){var collection=Exhibit.Collection.getCollection(configuration,exhibit);var lensRegistry2=Exhibit.Component.createLensRegistry(configuration,lensRegistry);var view=new Exhibit.PivotTableView(collection,containerElmt!=null?containerElmt:configElmt,lensRegistry2,exhibit);Exhibit.PivotTableView._configure(view,configuration);view._initializeUI();return view;};Exhibit.PivotTableView.createFromDOM=function(configElmt,containerElmt,lensRegistry,exhibit){var configuration=Exhibit.getConfigurationFromDOM(configElmt);var collection=Exhibit.Collection.getCollectionFromDOM(configElmt,configuration,exhibit);var lensRegistry2=Exhibit.Component.createLensRegistryFromDOM(configElmt,configuration,lensRegistry);var view=new Exhibit.PivotTableView(collection,containerElmt!=null?containerElmt:configElmt,lensRegistry2,exhibit);view._columnPath=Exhibit.PivotTableView._parsePath(Exhibit.getAttribute(configElmt,"column"));view._rowPath=Exhibit.PivotTableView._parsePath(Exhibit.getAttribute(configElmt,"row"));view._cellExpression=Exhibit.PivotTableView._parseExpression(Exhibit.getAttribute(configElmt,"cell"));view._initializeUI();return view;};Exhibit.PivotTableView._configure=function(view,configuration){view._columnPath=Exhibit.PivotTableView._parsePath(configuration.column);view._rowPath=Exhibit.PivotTableView._parsePath(configuration.row);view._cellExpression=Exhibit.PivotTableView._parseExpression(configuration.cell);};Exhibit.PivotTableView._parseExpression=function(s){try{return Exhibit.Expression.parse(s);}catch(e){SimileAjax.Debug.exception("Error parsing expression "+s,e);}
return null;};Exhibit.PivotTableView._parsePath=function(s){try{var expression=Exhibit.Expression.parse(s);if(expression.isPath()){return expression.getPath();}else{SimileAjax.Debug.log("Expecting a path but got a full expression: "+s);}}catch(e){SimileAjax.Debug.exception("Error parsing expression "+s,e);}
return null;};Exhibit.PivotTableView.prototype.dispose=function(){this._collection.removeListener(this._listener);this._div.innerHTML="";this._dom=null;this._div=null;this._collection=null;this._exhibit=null;};Exhibit.PivotTableView.prototype._initializeUI=function(){var self=this;this._div.innerHTML="";this._dom=Exhibit.PivotTableView.theme.constructDom(this._collection,this._exhibit,this._div,function(elmt,evt,target){Exhibit.ViewPanel.resetCollection(self._collection);SimileAjax.DOM.cancelEvent(evt);return false;});this._reconstruct();};Exhibit.PivotTableView.prototype._reconstruct=function(){this._dom.tableContainer.innerHTML="";var originalSize=this._collection.countAllItems();var currentSize=this._collection.countRestrictedItems();if(currentSize>0){var currentSet=this._collection.getRestrictedItems();if(this._columnPath!=null&&this._rowPath!=null&&this._cellExpression!=null){this._makeTable(currentSet);}
this._dom.setTypes(this._exhibit.getDatabase().getTypeLabels(currentSet)[currentSize>1?1:0]);}
this._dom.setCounts(currentSize,originalSize);};Exhibit.PivotTableView.prototype._makeTable=function(items){var self=this;var exhibit=this._exhibit;var database=exhibit.getDatabase();var rowResults=this._rowPath.walkForward(items,"item",database);var columnResults=this._columnPath.walkForward(items,"item",database);var rowValues=Exhibit.PivotTableView._sortValues(rowResults.values);var columnValues=Exhibit.PivotTableView._sortValues(columnResults.values);var rowCount=rowValues.length;var columnCount=columnValues.length;var evenColor="#eee";var oddColor="#fff";var table=document.createElement("table");table.cellPadding=2;table.cellSpacing=0;var rowToInsert=0;var tr,td;for(var c=0;c<columnCount;c++){var cellToInsert=0;tr=table.insertRow(rowToInsert++);td=tr.insertCell(cellToInsert++);if(c>0){td=tr.insertCell(cellToInsert++);td.rowSpan=columnCount-c+1;td.style.backgroundColor=(c%2)==0?oddColor:evenColor;td.innerHTML="\u00a0";}
td=tr.insertCell(cellToInsert++);td.colSpan=columnCount-c+1;td.style.backgroundColor=(c%2)==1?oddColor:evenColor;td.innerHTML=columnValues[c].label;}
tr=table.insertRow(rowToInsert++);td=tr.insertCell(0);td=tr.insertCell(1);td.style.backgroundColor=(columnCount%2)==0?oddColor:evenColor;td.innerHTML="\u00a0";td=tr.insertCell(2);for(var r=0;r<rowCount;r++){var cellToInsert=0;var rowPair=rowValues[r];var rowValue=rowPair.value;tr=table.insertRow(rowToInsert++);td=tr.insertCell(cellToInsert++);td.innerHTML=rowValues[r].label;td.style.borderBottom="1px solid #aaa";var rowItems=this._rowPath.evaluateBackward(rowValue,rowResults.valueType,items,database).values;for(var c=0;c<columnCount;c++){var columnPair=columnValues[c];var columnValue=columnPair.value;td=tr.insertCell(cellToInsert++);td.style.backgroundColor=(c%2)==1?oddColor:evenColor;td.style.borderBottom="1px solid #ccc";td.title=rowPair.label+" / "+columnPair.label;var cellItemResults=this._columnPath.evaluateBackward(columnValue,columnResults.valueType,rowItems,database);var cellResults=this._cellExpression.evaluate({"value":cellItemResults.values},{"value":cellItemResults.valueType},"value",database);if(cellResults.valueType=="number"&&cellResults.values.size()==1){cellResults.values.visit(function(v){if(v!=0){td.appendChild(document.createTextNode(v));}else{td.appendChild(document.createTextNode("\u00a0"));}});}else{var first=true;cellResults.values.visit(function(v){if(first){first=false;}else{td.appendChild(document.createTextNode(", "));}
td.appendChild(document.createTextNode(v));});}}}
this._dom.tableContainer.appendChild(table);};Exhibit.PivotTableView._sortValues=function(values,valueType,database){var a=[];values.visit(valueType=="item"?function(v){var label=database.getObject(v,"label");a.push({value:v,label:label!=null?label:v});}:function(v){a.push({value:v,label:v});});a.sort(function(o1,o2){var c=o1.label.localeCompare(o2.label);return c!=null?c:o1.value.localeCompare(o2.value);});return a;};Exhibit.PivotTableView.prototype._openPopup=function(elmt,items){var coords=SimileAjax.DOM.getPageCoordinates(elmt);var bubble=SimileAjax.Graphics.createBubbleForPoint(document,coords.left+Math.round(elmt.offsetWidth/2),coords.top+Math.round(elmt.offsetHeight/2),400,300);if(items.length>1){var ul=document.createElement("ul");for(var i=0;i<items.length;i++){var li=document.createElement("li");li.appendChild(Exhibit.UI.makeItemSpan(items[i],null,null,this._lensRegistry,this._exhibit));ul.appendChild(li);}
bubble.content.appendChild(ul);}else{var itemLensDiv=document.createElement("div");var itemLens=this._lensRegistry.createLens(items[0],itemLensDiv,this._exhibit);bubble.content.appendChild(itemLensDiv);}};

/* scatter-plot-view.js */

Exhibit.ScatterPlotView=function(collection,containerElmt,lensRegistry,exhibit){this._collection=collection;this._div=containerElmt;this._lensRegistry=lensRegistry;this._exhibit=exhibit;this._getXY=function(itemID,database){return{};};this._getColorKey=function(itemID,database){return"";};this._plotSettings={xAxisMin:Number.POSITIVE_INFINITY,xAxisMax:Number.NEGATIVE_INFINITY,yAxisMin:Number.POSITIVE_INFINITY,yAxisMax:Number.NEGATIVE_INFINITY,xLabel:"x",yLabel:"y"};this._xyCache=new Object();this._colorKeyCache=new Object();this._maxColor=0;var view=this;this._listener={onItemsChanged:function(){view._reconstruct();}};collection.addListener(this._listener);};Exhibit.ScatterPlotView.create=function(configuration,containerElmt,lensRegistry,exhibit){var collection=Exhibit.Collection.getCollection(configuration,exhibit);var lensRegistry2=Exhibit.Component.createLensRegistry(configuration,lensRegistry);var view=new Exhibit.ScatterPlotView(collection,containerElmt!=null?containerElmt:configElmt,lensRegistry2,exhibit);Exhibit.ScatterPlotView._configure(view,configuration);view._initializeUI();return view;};Exhibit.ScatterPlotView.createFromDOM=function(configElmt,containerElmt,lensRegistry,exhibit){var configuration=Exhibit.getConfigurationFromDOM(configElmt);var collection=Exhibit.Collection.getCollectionFromDOM(configElmt,configuration,exhibit);var lensRegistry2=Exhibit.Component.createLensRegistryFromDOM(configElmt,configuration,lensRegistry);var view=new Exhibit.ScatterPlotView(collection,containerElmt!=null?containerElmt:configElmt,lensRegistry2,exhibit);try{var xy=Exhibit.getAttribute(configElmt,"xy");if(xy!=null&&xy.length>0){view._getXY=Exhibit.ScatterPlotView._makeGetXY(xy);}else{var x=Exhibit.getAttribute(configElmt,"x");var y=Exhibit.getAttribute(configElmt,"y");if(x!=null&&y!=null&&x.length>0&&y.length>0){view._getXY=Exhibit.ScatterPlotView._makeGetXY2(x,y);}}}catch(e){SimileAjax.Debug.exception("ScatterPlotView: Error processing x/y configuration",e);}
try{var color=Exhibit.getAttribute(configElmt,"color");if(color!=null&&color.length>0){view._getColorKey=Exhibit.ScatterPlotView._makeGetColor(color);}}catch(e){SimileAjax.Debug.exception("ScatterPlotView: Error processing color configuration",e);}
var s=Exhibit.getAttribute(configElmt,"xAxisMin");if(s!=null&&s.length>0){view._plotSettings.xAxisMin=parseFloat(s);}
s=Exhibit.getAttribute(configElmt,"xAxisMax");if(s!=null&&s.length>0){view._plotSettings.xAxisMax=parseFloat(s);}
s=Exhibit.getAttribute(configElmt,"yAxisMin");if(s!=null&&s.length>0){view._plotSettings.yAxisMin=parseFloat(s);}
s=Exhibit.getAttribute(configElmt,"yAxisMax");if(s!=null&&s.length>0){view._plotSettings.yAxisMax=parseFloat(s);}
s=Exhibit.getAttribute(configElmt,"xLabel");if(s!=null&&s.length>0){view._plotSettings.xLabel=s;}
s=Exhibit.getAttribute(configElmt,"yLabel");if(s!=null&&s.length>0){view._plotSettings.yLabel=s;}
view._initializeUI();return view;};Exhibit.ScatterPlotView._configure=function(view,configuration){try{if("xy"in configuration){view._getXY=Exhibit.ScatterPlotView._makeGetXY(configuration.xy);}else if("x"in configuration&&"y"in configuration){view._getXY=Exhibit.ScatterPlotView._makeGetXY2(configuration.x,configuration.y);}}catch(e){SimileAjax.Debug.exception("ScatterPlotView: Error processing x/y configuration",e);}
try{if("color"in configuration){view._getColorKey=Exhibit.ScatterPlotView._makeGetColor(configuration.color);}}catch(e){SimileAjax.Debug.exception("ScatterPlotView: Error processing color configuration",e);}
if("xAxisMin"in configuration){view._plotSettings.xAxisMin=configuration.xAxisMin;}
if("xAxisMax"in configuration){view._plotSettings.xAxisMax=configuration.xAxisMax;}
if("yAxisMin"in configuration){view._plotSettings.yAxisMin=configuration.yAxisMin;}
if("yAxisMax"in configuration){view._plotSettings.yAxisMax=configuration.yAxisMax;}
if("xLabel"in configuration){view._plotSettings.xLabel=configuration.xLabel;}
if("yLabel"in configuration){view._plotSettings.yLabel=configuration.yLabel;}};Exhibit.ScatterPlotView._makeGetXY=function(s){var xyExpression=Exhibit.Expression.parse(s);return function(itemID,database){var result={};var x=Exhibit.ScatterPlotView.evaluateSingle(xyExpression,itemID,database);if(x!=null){var a=x.split(",");if(a.length==2){result.lat=(typeof a[0]=="number")?a[0]:parseFloat(a[0]);result.lng=(typeof a[1]=="number")?a[1]:parseFloat(a[1]);}}
return result;};};Exhibit.ScatterPlotView._makeGetXY2=function(x,y){var xExpression=Exhibit.Expression.parse(x);var yExpression=Exhibit.Expression.parse(y);return function(itemID,database){var result={};var x=Exhibit.ScatterPlotView.evaluateSingle(xExpression,itemID,database);var y=Exhibit.ScatterPlotView.evaluateSingle(yExpression,itemID,database);if(x!=null&&y!=null){result.x=(typeof x=="number")?x:parseFloat(x);result.y=(typeof y=="number")?y:parseFloat(y);}
return result;}};Exhibit.ScatterPlotView._makeGetColor=function(s){var colorExpression=Exhibit.Expression.parse(s);return function(itemID,database){var key=Exhibit.ScatterPlotView.evaluateSingle(colorExpression,itemID,database);return key!=null?key:"";};};Exhibit.ScatterPlotView._colors=[{color:"FF9000"},{color:"5D7CBA"},{color:"A97838"},{color:"8B9BBA"},{color:"FFC77F"},{color:"003EBA"},{color:"29447B"},{color:"543C1C"}];Exhibit.ScatterPlotView._wildcardMarker={color:"888888"};Exhibit.ScatterPlotView._mixMarker={color:"FFFFFF"};Exhibit.ScatterPlotView.evaluateSingle=function(expression,itemID,database){return expression.evaluateSingleOnItem(itemID,database).value;}
Exhibit.ScatterPlotView.prototype.dispose=function(){this._collection.removeListener(this._listener);this._div.innerHTML="";this._dom=null;this._div=null;this._collection=null;this._exhibit=null;};Exhibit.ScatterPlotView.prototype._initializeUI=function(){var self=this;this._div.innerHTML="";this._dom=Exhibit.ScatterPlotView.theme.constructDom(this._collection,this._exhibit,this._div,function(elmt,evt,target){Exhibit.ViewPanel.resetCollection(self._collection);SimileAjax.DOM.cancelEvent(evt);return false;});this._dom.plotContainer.style.height="400px";this._reconstruct();};Exhibit.ScatterPlotView.prototype._reconstruct=function(){var self=this;var exhibit=this._exhibit;var database=exhibit.getDatabase();this._dom.plotContainer.innerHTML="";var originalSize=this._collection.countAllItems();var currentSize=this._collection.countRestrictedItems();var mappableSize=0;this._dom.clearLegend();if(currentSize>0){var currentSet=this._collection.getRestrictedItems();var xyToData={};var xAxisMin=this._plotSettings.xAxisMin;var xAxisMax=this._plotSettings.xAxisMax;var yAxisMin=this._plotSettings.yAxisMin;var yAxisMax=this._plotSettings.yAxisMax;currentSet.visit(function(itemID){var xy;if(itemID in self._xyCache){xy=self._xyCache[itemID];}else{xy=self._getXY(itemID,database);self._xyCache[itemID]=xy;}
if("x"in xy&&"y"in xy){var colorKey;if(itemID in self._colorKeyCache){colorKey=self._colorKeyCache[itemID];}else{colorKey=self._getColorKey(itemID,database);self._colorKeyCache[itemID]=colorKey;}
var xyKey=xy.x+","+xy.y;var xyData=xyToData[xyKey];if(!(xyData)){xyData={xy:xy,items:[],colorKey:colorKey};xyToData[xyKey]=xyData;}else if(xyData.colorKey!=colorKey){xyData.colorKey=null;}
xyData.items.push(itemID);mappableSize++;xAxisMin=Math.min(xAxisMin,xy.x);xAxisMax=Math.max(xAxisMax,xy.x);yAxisMin=Math.min(yAxisMin,xy.y);yAxisMax=Math.max(yAxisMax,xy.y);}});var xDiff=xAxisMax-xAxisMin;var yDiff=yAxisMax-yAxisMin;var xInterval=1;if(xDiff>1){while(xInterval*20<xDiff){xInterval*=10;}}else{while(xInterval<xDiff*20){xInterval/=10;}}
xAxisMin=Math.floor(xAxisMin/xInterval)*xInterval;xAxisMax=Math.ceil(xAxisMax/xInterval)*xInterval;var yInterval=1;if(yDiff>1){while(yInterval*20<yDiff){yInterval*=10;}}else{while(yInterval<yDiff*20){yInterval/=10;}}
yAxisMin=Math.floor(yAxisMin/yInterval)*yInterval;yAxisMax=Math.ceil(yAxisMax/yInterval)*yInterval;this._plotSettings.xAxisMin=xAxisMin;this._plotSettings.xAxisMax=xAxisMax;this._plotSettings.yAxisMin=yAxisMin;this._plotSettings.yAxisMax=yAxisMax;var canvasFrame=document.createElement("div");canvasFrame.className=SimileAjax.Platform.browser.isIE?"exhibit-scatterPlotView-canvasFrame-ie":"exhibit-scatterPlotView-canvasFrame";this._dom.plotContainer.appendChild(canvasFrame);var canvasDiv=document.createElement("div");canvasDiv.className="exhibit-scatterPlotView-canvas";canvasDiv.style.height="100%";canvasFrame.appendChild(canvasDiv);var xAxisDiv=document.createElement("div");xAxisDiv.className="exhibit-scatterPlotView-xAxis";this._dom.plotContainer.appendChild(xAxisDiv);var xAxisDivInner=document.createElement("div");xAxisDivInner.style.position="relative";xAxisDiv.appendChild(xAxisDivInner);var yAxisDiv=document.createElement("div");yAxisDiv.className=SimileAjax.Platform.browser.isIE?"exhibit-scatterPlotView-yAxis-ie":"exhibit-scatterPlotView-yAxis";this._dom.plotContainer.appendChild(yAxisDiv);var yAxisDivInner=document.createElement("div");yAxisDivInner.style.position="relative";yAxisDivInner.style.height="100%";yAxisDiv.appendChild(yAxisDivInner);var canvasWidth=canvasDiv.offsetWidth;var canvasHeight=canvasDiv.offsetHeight;var xScale=canvasWidth/(xAxisMax-xAxisMin);var yScale=canvasHeight/(yAxisMax-yAxisMin);var makeMakeLabel=function(interval){if(interval>=1000000){return function(n){return Math.floor(n/1000000)+"M";};}else if(interval>=1000){return function(n){return Math.floor(n/1000)+"K";};}else{return function(n){return n;};}};var makeLabelX=makeMakeLabel(xInterval);var makeLabelY=makeMakeLabel(yInterval);for(var x=xAxisMin+xInterval;x<xAxisMax;x+=xInterval){var left=Math.floor((x-xAxisMin)*xScale);var div=document.createElement("div");div.className="exhibit-scatterPlotView-gridLine";div.style.width="1px";div.style.left=left+"px";div.style.top="0px";div.style.height="100%";canvasDiv.appendChild(div);var labelDiv=document.createElement("div");labelDiv.className="exhibit-scatterPlotView-xAxisLabel";labelDiv.style.left=left+"px";labelDiv.innerHTML=makeLabelX(x);xAxisDivInner.appendChild(labelDiv);}
var xNameDiv=document.createElement("div");xNameDiv.className="exhibit-scatterPlotView-xAxisName";xNameDiv.innerHTML=this._plotSettings.xLabel;xAxisDivInner.appendChild(xNameDiv);for(var y=yAxisMin+yInterval;y<yAxisMax;y+=yInterval){var bottom=Math.floor((y-yAxisMin)*yScale);var div=document.createElement("div");div.className="exhibit-scatterPlotView-gridLine";div.style.height="1px";div.style.bottom=bottom+"px";div.style.left="0px";div.style.width="100%";canvasDiv.appendChild(div);var labelDiv=document.createElement("div");labelDiv.className="exhibit-scatterPlotView-yAxisLabel";labelDiv.style.bottom=bottom+"px";labelDiv.innerHTML=makeLabelY(y);yAxisDivInner.appendChild(labelDiv);}
var yNameDiv=document.createElement("div");yNameDiv.className="exhibit-scatterPlotView-yAxisName";yNameDiv.innerHTML=this._plotSettings.yLabel;yAxisDivInner.appendChild(yNameDiv);var usedKeys={};var addPointAtLocation=function(xyData){var items=xyData.items;var colorData;if(xyData.colorKey==null){colorData=Exhibit.ScatterPlotView._mixMarker;}else{usedKeys[xyData.colorKey]=true;if(xyData.colorKey in self._colorKeyCache){colorData=self._colorKeyCache[xyData.colorKey];}else{colorData=Exhibit.ScatterPlotView._colors[self._maxColor];self._colorKeyCache[xyData.colorKey]=colorData;self._maxColor=(self._maxColor+1)%Exhibit.ScatterPlotView._colors.length;}}
var marker=Exhibit.ScatterPlotView._makePoint(colorData.color);var x=xyData.xy.x;var y=xyData.xy.y;var left=Math.floor((x-xAxisMin)*xScale);var bottom=Math.floor((y-yAxisMin)*yScale);marker.style.left=left+"px";marker.style.bottom=bottom+"px";SimileAjax.WindowManager.registerEvent(marker,"click",function(elmt,evt,target){self._openPopup(marker,items);SimileAjax.DOM.cancelEvent(evt);return false;});canvasDiv.appendChild(marker);}
for(xyKey in xyToData){addPointAtLocation(xyToData[xyKey]);}
var legendLabels=[];var legendColors=[];for(colorKey in this._colorKeyCache){if(colorKey in usedKeys){var colorData=this._colorKeyCache[colorKey];legendLabels.push(colorKey);legendColors.push("#"+colorData.color);}}
legendLabels.push(Exhibit.ScatterPlotView.l10n.mixedLegendKey);legendColors.push("white");this._dom.addLegendBlock(Exhibit.ScatterPlotView.theme.constructLegendBlockDom(this._exhibit,Exhibit.ScatterPlotView.l10n.colorLegendTitle,legendColors,legendLabels));this._dom.setTypes(database.getTypeLabels(currentSet)[currentSize>1?1:0]);}
this._dom.setCounts(currentSize,mappableSize,originalSize);};Exhibit.ScatterPlotView.prototype._openPopup=function(elmt,items){var coords=SimileAjax.DOM.getPageCoordinates(elmt);var bubble=SimileAjax.Graphics.createBubbleForPoint(document,coords.left+Math.round(elmt.offsetWidth/2),coords.top+Math.round(elmt.offsetHeight/2),400,300);if(items.length>1){var ul=document.createElement("ul");for(var i=0;i<items.length;i++){var li=document.createElement("li");li.appendChild(Exhibit.UI.makeItemSpan(items[i],null,null,this._lensRegistry,this._exhibit));ul.appendChild(li);}
bubble.content.appendChild(ul);}else{var itemLensDiv=document.createElement("div");var itemLens=this._lensRegistry.createLens(items[0],itemLensDiv,this._exhibit);bubble.content.appendChild(itemLensDiv);}};Exhibit.ScatterPlotView._makePoint=function(color){var div=document.createElement("div");div.className="exhibit-scatterPlotView-point";div.style.backgroundColor="#"+color;div.style.width="6px";div.style.height="6px";return div;};

/* tabular-view.js */

Exhibit.TabularView=function(collection,containerElmt,lensRegistry,exhibit){this._collection=collection;this._div=containerElmt;this._lensRegistry=lensRegistry;this._exhibit=exhibit;this._initialCount=10;this._showAll=true;this._columns=[];this._sortColumn=0;this._sortAscending=true;this._rowStyler=null;this._tableStyler=null;var view=this;this._listener={onItemsChanged:function(){view._reconstruct();}};collection.addListener(this._listener);};Exhibit.TabularView.create=function(configuration,containerElmt,lensRegistry,exhibit){var collection=Exhibit.Collection.getCollection(configuration,exhibit);var lensRegistry2=Exhibit.Component.createLensRegistry(configuration,lensRegistry);var view=new Exhibit.TabularView(collection,containerElmt!=null?containerElmt:configElmt,lensRegistry2,exhibit);Exhibit.TabularView._configure(view,configuration);view._internalValidate();view._initializeUI();return view;};Exhibit.TabularView.createFromDOM=function(configElmt,containerElmt,lensRegistry,exhibit){var configuration=Exhibit.getConfigurationFromDOM(configElmt);var collection=Exhibit.Collection.getCollectionFromDOM(configElmt,configuration,exhibit);var lensRegistry2=Exhibit.Component.createLensRegistryFromDOM(configElmt,configuration,lensRegistry);var view=new Exhibit.TabularView(collection,containerElmt!=null?containerElmt:configElmt,lensRegistry2,exhibit);try{var expressions=[];var labels=Exhibit.getAttribute(configElmt,"columnLabels",",")||[];var formats=Exhibit.getAttribute(configElmt,"columnFormats",",")||[];var s=Exhibit.getAttribute(configElmt,"columns");if(s!=null&&s.length>0){expressions=Exhibit.Expression.parseSeveral(s);}
for(var i=0;i<expressions.length;i++){var expression=expressions[i];var format=formats[i];if(format==null){format="list";}
view._columns.push({expression:expression,styler:null,label:labels[i],format:format});}}catch(e){SimileAjax.Debug.exception("TabularView: Error processing configuration of tabular view",e);}
var s=Exhibit.getAttribute(configElmt,"sortColumn");if(s!=null){view._sortColumn=parseInt(s);}
s=Exhibit.getAttribute(configElmt,"sortAscending");if(s!=null){view._sortAscending=(s=="true");}
s=Exhibit.getAttribute(configElmt,"initialCount");if(s!=null){view._initialCount=parseInt(s);}
s=Exhibit.getAttribute(configElmt,"showAll");if(s!=null){view._showAll=(s=="true");}
s=Exhibit.getAttribute(configElmt,"rowStyler");if(s!=null){var f=eval(s);if(typeof f=="function"){view._rowStyler=f;}}
s=Exhibit.getAttribute(configElmt,"tableStyler");if(s!=null){f=eval(s);if(typeof f=="function"){view._tableStyler=f;}}
view._internalValidate();view._initializeUI();return view;};Exhibit.TabularView._configure=function(view,configuration){var columns=configuration.columns;for(var i=0;i<columns.length;i++){var column=columns[i];var expr;var styler=null;var label=null;var format=null;if(typeof column=="string"){expr=column;}else{expr=column.expression;styler=column.styler;label=column.label;format=column.format;}
var expression=Exhibit.Expression.parse(expr);if(expression.isPath()){var path=expression.getPath();if(format==null){format="list";}
view._columns.push({expression:expression,styler:styler,label:label,format:format});}}
if("sortColumn"in configuration){view._sortColumn=configuration.sortColumn;}
if("sortAscending"in configuration){view._sortAscending=(configuration.sortAscending);}
if("initialCount"in configuration){view._initialCount=configuration.initialCount;}
if("showAll"in configuration){view._showAll=configuration.showAll;}
if("rowStyler"in configuration){view._rowStyler=configuration.rowStyler;}
if("tableStyler"in configuration){view._tableStyler=configuration.tableStyler;}};Exhibit.TabularView.prototype._internalValidate=function(){if(this._columns.length==0){var database=this._exhibit.getDatabase();var propertyIDs=database.getAllProperties();for(var i=0;i<propertyIDs.length;i++){var propertyID=propertyIDs[i];if(propertyID!="uri"){this._columns.push({expression:Exhibit.Expression.parse("."+propertyID),styler:null,label:database.getProperty(propertyID).getLabel(),format:"list"});}}}
this._sortColumn=Math.max(0,Math.min(this._sortColumn,this._columns.length-1));};Exhibit.TabularView.prototype.dispose=function(){this._collection.removeListener(this._listener);this._div.innerHTML="";this._dom=null;this._div=null;this._collection=null;this._exhibit=null;};Exhibit.TabularView.prototype._initializeUI=function(){var self=this;this._div.innerHTML="";this._dom=Exhibit.TabularView.theme.createDom(this._collection,this._exhibit,this._div,function(elmt,evt,target){Exhibit.ViewPanel.resetCollection(self._collection);SimileAjax.DOM.cancelEvent(evt);return false;});this._reconstruct();};Exhibit.TabularView.prototype._reconstruct=function(){var self=this;var exhibit=this._exhibit;var database=exhibit.getDatabase();var bodyDiv=this._dom.bodyDiv;bodyDiv.innerHTML="";var items=[];var originalSize=this._collection.countAllItems();if(originalSize>0){var currentSet=this._collection.getRestrictedItems();currentSet.visit(function(itemID){items.push({id:itemID,sortKey:""});});}
this._dom.setCounts(items.length,originalSize);if(items.length>0){this._dom.setTypes(database.getTypeLabels(currentSet)[items.length>1?1:0]);var sortColumn=this._columns[this._sortColumn];items.sort(this._createSortFunction(items,sortColumn.expression,this._sortAscending));var table=document.createElement("table");table.cellPadding=5;table.border=1;if(this._tableStyler!=null){this._tableStyler(table,database);}
var max=this._showAll?items.length:Math.min(items.length,this._initialCount);for(var i=0;i<max;i++){var item=items[i];var tr=table.insertRow(i);if(this._rowStyler!=null){this._rowStyler(item.id,database,tr,i);}
for(var c=0;c<this._columns.length;c++){var column=this._columns[c];var td=tr.insertCell(c);var results=column.expression.evaluate({"value":item.id},{"value":"item"},"value",database);switch(column.format){case"image":results.values.visit(function(url){var img=document.createElement("img");img.src=url;td.appendChild(img);});break;default:Exhibit.TabularView._constructDefaultValueList(results.values,results.valueType,td,exhibit);}
if(column.styler!=null){column.styler(item.id,database,td);}}}
var th=table.createTHead();tr=th.insertRow(0);var createColumnHeader=function(i){var column=self._columns[i];if(column.label==null){column.label=self._getColumnLabel(column.expression);}
var colgroup=document.createElement("colgroup");colgroup.className=column.label;table.appendChild(colgroup);var td=document.createElement("th");Exhibit.TabularView.theme.createColumnHeader(exhibit,td,column.label,i==self._sortColumn,self._sortAscending,function(elmt,evt,target){self._doSort(i);SimileAjax.DOM.cancelEvent(evt);return false;});tr.appendChild(td);};for(var i=0;i<this._columns.length;i++){createColumnHeader(i);}
bodyDiv.appendChild(table);}};Exhibit.TabularView.prototype._getColumnLabel=function(expression){var database=this._exhibit.getDatabase();var path=expression.getPath();var segment=path.getSegment(path.getSegmentCount()-1);var propertyID=segment.property;var property=database.getProperty(propertyID);if(property!=null){return segment.forward?property.getLabel():property.getReverseLabel();}else{return propertyID;}};Exhibit.TabularView.prototype._createSortFunction=function(items,expression,ascending){var database=this._exhibit.getDatabase();var multiply=ascending?1:-1;var numericFunction=function(item1,item2){return multiply*(item1.sortKey-item2.sortKey);};var textFunction=function(item1,item2){return multiply*item1.sortKey.localeCompare(item2.sortKey);};var valueTypes=[];var valueTypeMap={};for(var i=0;i<items.length;i++){var item=items[i];var r=expression.evaluate({"value":item.id},{"value":"item"},"value",database);r.values.visit(function(value){item.sortKey=value;});if(!(r.valueType in valueTypeMap)){valueTypeMap[r.valueType]=true;valueTypes.push(r.valueType);}}
var coercedValueType="text"
if(valueTypes.length==1){coercedValueType=valueTypes[0];}else{coercedValueType="text";}
var coersion;var sortingFunction;if(coercedValueType=="number"){sortingFunction=numericFunction;coersion=function(v){if(v==null){return Number.NEGATIVE_INFINITY;}else if(typeof v=="number"){return v;}else{var n=parseFloat(v);if(isNaN(n)){return Number.NEGATIVE_INFINITY;}else{return n;}}}}else if(coercedValueType=="date"){sortingFunction=numericFunction;coersion=function(v){if(v==null){return Number.NEGATIVE_INFINITY;}else if(v instanceof Date){return v.getTime();}else{try{return SimileAjax.DateTime.parseIso8601DateTime(v).getTime();}catch(e){return Number.NEGATIVE_INFINITY;}}}}else if(coercedValueType=="boolean"){sortingFunction=numericFunction;coersion=function(v){if(v==null){return Number.NEGATIVE_INFINITY;}else if(typeof v=="boolean"){return v?1:0;}else{return v.toString().toLowerCase()=="true";}}}else if(coercedValueType=="item"){sortingFunction=textFunction;coersion=function(v){if(v==null){return Exhibit.l10n.missingSortKey;}else{var label=database.getObject(v,"label");return(label==null)?v:label;}}}else{sortingFunction=textFunction;coersion=function(v){if(v==null){return Exhibit.l10n.missingSortKey;}else{return v.toString();}}}
for(var i=0;i<items.length;i++){var item=items[i];item.sortKey=coersion(item.sortKey);}
return sortingFunction;};Exhibit.TabularView.prototype._doSort=function(columnIndex){var oldSortColumn=this._sortColumn;var oldSortAscending=this._sortAscending;var newSortColumn=columnIndex;var newSortAscending=oldSortColumn==newSortColumn?!oldSortAscending:true;var self=this;SimileAjax.History.addAction({perform:function(){self._sortColumn=newSortColumn;self._sortAscending=newSortAscending;self._reconstruct();},undo:function(){self._sortColumn=oldSortColumn;self._sortAscending=oldSortAscending;self._reconstruct();},label:Exhibit.TabularView.l10n.makeSortActionTitle(this._columns[columnIndex].label,newSortAscending),uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.TabularView._constructDefaultValueList=function(values,valueType,parentElmt,exhibit){var view=this;var processOneValue=(valueType=="item")?function(value){addDelimiter();parentElmt.appendChild(Exhibit.UI.makeItemSpan(value,null,null,view._lensRegistry,view._exhibit));}:function(value){addDelimiter();parentElmt.appendChild(Exhibit.UI.makeValueSpan(value,valueType));};var addDelimiter=Exhibit.l10n.createListDelimiter(parentElmt,values.size());values.visit(processOneValue);addDelimiter();};

/* thumbnail-view.js */

Exhibit.ThumbnailView=function(collection,containerElmt,lensRegistry,exhibit){this._collection=collection;this._div=containerElmt;this._lensRegistry=lensRegistry;this._exhibit=exhibit;var view=this;this._listener={onItemsChanged:function(){view._reconstruct();}};collection.addListener(this._listener);this._orderedViewFrame=new Exhibit.OrderedViewFrame(this._collection,this._exhibit);this._orderedViewFrame.parentReconstruct=function(){view._reconstruct();}};Exhibit.ThumbnailView.create=function(configuration,containerElmt,lensRegistry,exhibit){};Exhibit.ThumbnailView.createFromDOM=function(configElmt,containerElmt,lensRegistry,exhibit){var configuration=Exhibit.getConfigurationFromDOM(configElmt);var collection=Exhibit.Collection.getCollectionFromDOM(configElmt,configuration,exhibit);var lensRegistry2=Exhibit.Component.createLensRegistryFromDOM(configElmt,configuration,lensRegistry);var view=new Exhibit.ThumbnailView(collection,containerElmt!=null?containerElmt:configElmt,lensRegistry2,exhibit);view._orderedViewFrame.configureFromDOM(configElmt);view._initializeUI();return view;};Exhibit.ThumbnailView.prototype.dispose=function(){this._collection.removeListener(this._listener);this._div.innerHTML="";this._orderedViewFrame.dispose();this._orderedViewFrame=null;this._dom=null;this._collection=null;this._div=null;this._lensRegistry=null;this._exhibit=null;};Exhibit.ThumbnailView.prototype._initializeUI=function(){this._div.innerHTML="";var template={elmt:this._div,children:[{tag:"div",field:"headerDiv"},{tag:"div",className:"exhibit-collectionView-body",field:"bodyDiv"},{tag:"div",field:"footerDiv"}]};this._dom=SimileAjax.DOM.createDOMFromTemplate(document,template);var self=this;this._orderedViewFrame._divHeader=this._dom.headerDiv;this._orderedViewFrame._divFooter=this._dom.footerDiv;this._orderedViewFrame._generatedContentElmtRetriever=function(){return self._dom.bodyDiv;};this._orderedViewFrame.initializeUI();this._reconstruct();};Exhibit.ThumbnailView.prototype._reconstruct=function(){var view=this;var state={div:this._dom.bodyDiv,itemContainer:null,groupDoms:[],groupCounts:[]};var closeGroups=function(groupLevel){for(var i=groupLevel;i<state.groupDoms.length;i++){state.groupDoms[i].countSpan.innerHTML=state.groupCounts[i];}
state.groupDoms=state.groupDoms.slice(0,groupLevel);state.groupCounts=state.groupCounts.slice(0,groupLevel);if(groupLevel>0){state.div=state.groupDoms[groupLevel-1].contentDiv;}else{state.div=view._dom.bodyDiv;}
state.itemContainer=null;}
this._orderedViewFrame.onNewGroup=function(groupSortKey,keyType,groupLevel){closeGroups(groupLevel);var groupDom=Exhibit.ThumbnailView.theme.constructGroup(view._exhibit,groupLevel,groupSortKey);state.div.appendChild(groupDom.elmt);state.div=groupDom.contentDiv;state.groupDoms.push(groupDom);state.groupCounts.push(0);};this._orderedViewFrame.onNewItem=function(itemID,index){if(state.itemContainer==null){state.itemContainer=Exhibit.ThumbnailView.theme.constructItemContainer(view._exhibit);state.div.appendChild(state.itemContainer);}
for(var i=0;i<state.groupCounts.length;i++){state.groupCounts[i]++;}
var itemLensDiv=document.createElement("div");itemLensDiv.className=SimileAjax.Platform.browser.isIE?"exhibit-thumbnailView-itemContainer-IE":"exhibit-thumbnailView-itemContainer";var itemLens=view._lensRegistry.createLens(itemID,itemLensDiv,view._exhibit);state.itemContainer.appendChild(itemLensDiv);};this._div.style.display="none";this._dom.bodyDiv.innerHTML="";this._orderedViewFrame.reconstruct();closeGroups(0);this._div.style.display="block";};

/* tile-view.js */

Exhibit.TileView=function(collection,containerElmt,lensRegistry,exhibit){this._collection=collection;this._div=containerElmt;this._lensRegistry=lensRegistry;this._exhibit=exhibit;var view=this;this._listener={onItemsChanged:function(){view._reconstruct();}};collection.addListener(this._listener);this._orderedViewFrame=new Exhibit.OrderedViewFrame(this._collection,this._exhibit);this._orderedViewFrame.parentReconstruct=function(){view._reconstruct();}};Exhibit.TileView.create=function(configuration,containerElmt,lensRegistry,exhibit){};Exhibit.TileView.createFromDOM=function(configElmt,containerElmt,lensRegistry,exhibit){var configuration=Exhibit.getConfigurationFromDOM(configElmt);var collection=Exhibit.Collection.getCollectionFromDOM(configElmt,configuration,exhibit);var lensRegistry2=Exhibit.Component.createLensRegistryFromDOM(configElmt,configuration,lensRegistry);var view=new Exhibit.TileView(collection,containerElmt!=null?containerElmt:configElmt,lensRegistry2,exhibit);view._orderedViewFrame.configureFromDOM(configElmt);view._initializeUI();return view;};Exhibit.TileView.prototype.dispose=function(){this._collection.removeListener(this._listener);this._div.innerHTML="";this._orderedViewFrame.dispose();this._orderedViewFrame=null;this._dom=null;this._collection=null;this._div=null;this._lensRegistry=null;this._exhibit=null;};Exhibit.TileView.prototype._initializeUI=function(){this._div.innerHTML="";var template={elmt:this._div,children:[{tag:"div",field:"headerDiv"},{tag:"div",className:"exhibit-collectionView-body",field:"bodyDiv"},{tag:"div",field:"footerDiv"}]};this._dom=SimileAjax.DOM.createDOMFromTemplate(document,template);var self=this;this._orderedViewFrame._divHeader=this._dom.headerDiv;this._orderedViewFrame._divFooter=this._dom.footerDiv;this._orderedViewFrame._generatedContentElmtRetriever=function(){return self._dom.bodyDiv;};this._orderedViewFrame.initializeUI();this._reconstruct();};Exhibit.TileView.prototype._reconstruct=function(){var view=this;var state={div:this._dom.bodyDiv,table:null,groupDoms:[],groupCounts:[]};var closeGroups=function(groupLevel){for(var i=groupLevel;i<state.groupDoms.length;i++){state.groupDoms[i].countSpan.innerHTML=state.groupCounts[i];}
state.groupDoms=state.groupDoms.slice(0,groupLevel);state.groupCounts=state.groupCounts.slice(0,groupLevel);if(groupLevel>0){state.div=state.groupDoms[groupLevel-1].contentDiv;}else{state.div=view._dom.bodyDiv;}
state.table=null;}
this._orderedViewFrame.onNewGroup=function(groupSortKey,keyType,groupLevel){closeGroups(groupLevel);var groupDom=Exhibit.TileView.theme.constructGroup(view._exhibit,groupLevel,groupSortKey);state.div.appendChild(groupDom.elmt);state.div=groupDom.contentDiv;state.groupDoms.push(groupDom);state.groupCounts.push(0);};this._orderedViewFrame.onNewItem=function(itemID,index){if(state.table==null){state.table=Exhibit.TileView.theme.constructTable(view._exhibit);state.div.appendChild(state.table);}
for(var i=0;i<state.groupCounts.length;i++){state.groupCounts[i]++;}
var rows=state.table.rows;var tr=state.table.insertRow(rows.length);var tdIndex=tr.insertCell(0);tdIndex.className="exhibit-tileView-itemIndex";tdIndex.innerHTML=(index+1)+".";var tdItemLens=tr.insertCell(1);var itemLensDiv=document.createElement("div");var itemLens=view._lensRegistry.createLens(itemID,itemLensDiv,view._exhibit);tdItemLens.appendChild(itemLensDiv);};this._div.style.display="none";this._dom.bodyDiv.innerHTML="";this._orderedViewFrame.reconstruct();closeGroups(0);this._div.style.display="block";};

/* timeline-view.js */

Exhibit.TimelineView=function(collection,containerElmt,lensRegistry,exhibit){this._collection=collection;this._div=containerElmt;this._lensRegistry=lensRegistry;this._exhibit=exhibit;this._densityFactor=50;this._topBandIntervalPixels=150;this._bottomBandIntervalPixels=200;this._bubbleWidth=400;this._bubbleHeight=300;this._timelineConstructor=null;this._getDurations=function(itemID,database){return{};};this._getMarkerKey=function(itemID,database){return"";};this._getEventLabel=function(itemID,database){return database.getObject(itemID,"label");};this._durationCache=new Object();this._markerKeyCache=new Object();this._markerCache=new Object();this._maxMarker=0;this._largestSize=0;var view=this;this._listener={onItemsChanged:function(){view._reconstruct();}};collection.addListener(this._listener);};Exhibit.TimelineView.create=function(configuration,containerElmt,lensRegistry,exhibit){var collection=Exhibit.Collection.getCollection(configuration,exhibit);var lensRegistry2=Exhibit.Component.createLensRegistry(configuration,lensRegistry);var view=new Exhibit.TimelineView(collection,containerElmt!=null?containerElmt:configElmt,lensRegistry2,exhibit);Exhibit.TimelineView._configure(view,configuration);view._initializeUI();return view;};Exhibit.TimelineView.createFromDOM=function(configElmt,containerElmt,lensRegistry,exhibit){var configuration=Exhibit.getConfigurationFromDOM(configElmt);var collection=Exhibit.Collection.getCollectionFromDOM(configElmt,configuration,exhibit);var lensRegistry2=Exhibit.Component.createLensRegistryFromDOM(configElmt,configuration,lensRegistry);var view=new Exhibit.TimelineView(collection,containerElmt!=null?containerElmt:configElmt,lensRegistry2,exhibit);try{var getStart=null;var getEnd=function(){return null;};var start=Exhibit.getAttribute(configElmt,"start");if(start!=null&&start.length>0){getStart=Exhibit.TimelineView._makeAccessor(start);}
var end=Exhibit.getAttribute(configElmt,"end");if(end!=null&&end.length>0){getEnd=Exhibit.TimelineView._makeAccessor(end);}
if(start!=null){var getStartEnd=function(itemID,database){return{start:getStart(itemID,database),end:getEnd(itemID,database)};}
var proxy=Exhibit.getAttribute(configElmt,"proxy");if(proxy!=null&&proxy.length>0){view._getDurations=Exhibit.TimelineView._makeGetDurations(proxy,getStartEnd);}else{view._getDurations=getStartEnd;}}}catch(e){SimileAjax.Debug.exception("TimelineView: Error processing configuration of timeline view",e);}
try{var marker=Exhibit.getAttribute(configElmt,"marker");if(marker!=null&&marker.length>0){view._getMarkerKey=Exhibit.TimelineView._makeGetMarker(marker);}}catch(e){SimileAjax.Debug.exception("TimelineView: Error processing marker configuration of timeline view",e);}
try{var eventLabel=Exhibit.getAttribute(configElmt,"eventLabel");if(eventLabel!=null&&eventLabel.length>0){view._getEventLabel=Exhibit.TimelineView._makeEventLabel(eventLabel);}}catch(e){SimileAjax.Debug.exception("TimelineView: Error processing eventLabel configuration of timeline view",e);}
try{var topBandIntervalPixels=Exhibit.getAttribute(configElmt,"topBandIntervalPixels");if(topBandIntervalPixels!=null&&topBandIntervalPixels.length>0){view._topBandIntervalPixels=parseInt(topBandIntervalPixels);}
var bottomBandIntervalPixels=Exhibit.getAttribute(configElmt,"bottomBandIntervalPixels");if(bottomBandIntervalPixels!=null&&bottomBandIntervalPixels.length>0){view._bottomBandIntervalPixels=parseInt(bottomBandIntervalPixels);}
var densityFactor=Exhibit.getAttribute(configElmt,"densityFactor");if(densityFactor!=null&&densityFactor.length>0){view._densityFactor=parseFloat(densityFactor);}
var bubbleWidth=Exhibit.getAttribute(configElmt,"bubbleWidth");if(bubbleWidth!=null&&bubbleWidth.length>0){view._bubbleWidth=parseInt(bubbleWidth);}
var bubbleHeight=Exhibit.getAttribute(configElmt,"bubbleHeight");if(bubbleHeight!=null&&bubbleHeight.length>0){view._bubbleHeight=parseInt(bubbleHeight);}
var timelineConstructor=Exhibit.getAttribute(configElmt,"timelineConstructor");if(timelineConstructor!=null){var f=eval(timelineConstructor);if(typeof f=="function"){view._timelineConstructor=f;}}}catch(e){SimileAjax.Debug.exception("TimelineView: Error processing configuration of timeline view",e);}
view._initializeUI();return view;};Exhibit.TimelineView._configure=function(view,configuration){try{var getStart=null;var getEnd=function(){return null;};if("start"in configuration){getStart=Exhibit.TimelineView._makeAccessor(configuration.start);}
if("end"in configuration){getEnd=Exhibit.TimelineView._makeAccessor(configuration.end);}
if(start!=null){var getStartEnd=function(itemID,database){return{start:getStart(itemID,database),end:getEnd(itemID,database)};}
if("proxy"in configuration){view._getDurations=Exhibit.TimelineView._makeGetDurations(configuration.proxy,getStartEnd);}else{view._getDurations=getStartEnd;}}}catch(e){SimileAjax.Debug.exception("TimelineView: Error processing configuration of timeline view",e);}
try{if("marker"in configuration){view._getMarkerKey=Exhibit.TimelineView._makeGetMarker(configuration.marker);}}catch(e){SimileAjax.Debug.exception("TimelineView: Error processing marker configuration of timeline view",e);}
try{if("eventLabel"in configuration){view._getEventLabel=Exhibit.TimelineView._makeEventLabel(configuration.eventLabel);}}catch(e){SimileAjax.Debug.exception("TimelineView: Error processing eventLabel configuration of timeline view",e);}
try{if("topBandIntervalPixels"in configuration){view._topBandIntervalPixels=configuration.topBandIntervalPixels;}
if("bottomBandIntervalPixels"in configuration){view._bottomBandIntervalPixels=configuration.bottomBandIntervalPixels;}
if("densityFactor"in configuration){view._densityFactor=configuration.densityFactor;}
if("bubbleWidth"in configuration){view._bubbleWidth=configuration.bubbleWidth;}
if("bubbleHeight"in configuration){view._bubbleHeight=configuration.bubbleHeight;}
if("timelineConstructor"in configuration){view._timelineConstructor=configuration.timelineConstructor;}}catch(e){SimileAjax.Debug.exception("TimelineView: Error processing configuration of timeline view",e);}};Exhibit.TimelineView._makeAccessor=function(expression){var expr=Exhibit.Expression.parse(expression);return function(itemID,database){var v=expr.evaluateSingleOnItem(itemID,database).value;if(v==null){return v;}else if(v instanceof Date){return v;}else{return SimileAjax.DateTime.parseIso8601DateTime(v);}};};Exhibit.TimelineView._makeGetDurations=function(s,getStartEnd){var expr=Exhibit.Expression.parse(s);return function(itemID,database){var pairs=[];expr.evaluateOnItem(itemID,database).values.visit(function(v){var startEnd=getStartEnd(v,database);if(startEnd.start!=null){pairs.push(startEnd);}});return pairs;};};Exhibit.TimelineView._makeGetMarker=function(s){var markerExpression=Exhibit.Expression.parse(s);return function(itemID,database){var key=markerExpression.evaluateSingleOnItem(itemID,database).value;return key!=null?key:"";};};Exhibit.TimelineView._makeGetEventLabel=function(s){var expression=Exhibit.Expression.parse(s);return function(itemID,database){var label=expression.evaluateSingleOnItem(itemID,database).value;return label!=null?label:itemID;}};Exhibit.TimelineView.prototype.dispose=function(){this._collection.removeListener(this._listener);this._dom.timeline=null;this._dom=null;this._div.innerHTML="";this._div=null;this._collection=null;this._exhibit=null;};Exhibit.TimelineView.prototype._initializeUI=function(){var self=this;this._div.innerHTML="";this._dom=Exhibit.TimelineView.theme.constructDom(this._collection,this._exhibit,this._div,function(elmt,evt,target){Exhibit.ViewPanel.resetCollection(self._collection);SimileAjax.DOM.cancelEvent(evt);return false;},function(elmt,evt,target){self._largestSize=0;self._reconstruct();SimileAjax.DOM.cancelEvent(evt);return false;});this._eventSource=new Timeline.DefaultEventSource();this._reconstruct();};Exhibit.TimelineView.prototype._reconstructTimeline=function(newEvents){if(this._dom.timeline!=null){this._dom.timeline.dispose();}
if(newEvents){this._eventSource.addMany(newEvents);}
var timelineDiv=this._dom.getTimelineDiv();if(this._timelineConstructor!=null){this._dom.timeline=this._timelineConstructor(timelineDiv,this._eventSource);}else{timelineDiv.style.height="400px";var earliest=this._eventSource.getEarliestDate();var latest=this._eventSource.getLatestDate();var duration=latest.getTime()-earliest.getTime();var intervalUnit=Timeline.DateTime.MILLENNIUM;while(intervalUnit>0){var intervalLength=Timeline.DateTime.gregorianUnitLengths[intervalUnit];if(duration/intervalLength>this._densityFactor){break;}
intervalUnit--;}
var theme=Timeline.ClassicTheme.create();theme.event.bubble.width=this._bubbleWidth;theme.event.bubble.height=this._bubbleHeight;var bandInfos=[Timeline.createBandInfo({width:"75%",intervalUnit:intervalUnit,intervalPixels:this._topBandIntervalPixels,eventSource:this._eventSource,theme:theme}),Timeline.createBandInfo({width:"25%",intervalUnit:intervalUnit+1,intervalPixels:this._bottomBandIntervalPixels,eventSource:this._eventSource,showEventText:false,trackHeight:0.5,trackGap:0.2,theme:theme})];bandInfos[1].syncWith=0;bandInfos[1].highlight=true;bandInfos[1].eventPainter.setLayout(bandInfos[0].eventPainter.getLayout());this._dom.timeline=Timeline.create(timelineDiv,bandInfos,Timeline.HORIZONTAL);}};Exhibit.TimelineView.prototype._reconstruct=function(){var self=this;var exhibit=this._exhibit;var database=exhibit.getDatabase();var originalSize=this._collection.countAllItems();var currentSize=this._collection.countRestrictedItems();var plottableSize=0;var usedKeys={};this._dom.clearLegend();this._eventSource.clear();if(currentSize>0){var currentSet=this._collection.getRestrictedItems();var events=[];var addEvent=function(itemID,duration,markerData){var evt=new Timeline.DefaultEventSource.Event(duration.start,duration.end,null,null,duration.end==null,self._getEventLabel(itemID,database),"no description",null,null,null,"#"+markerData.color,"#"+(duration.end==null?markerData.color:markerData.textColor));evt._itemID=itemID;evt.getProperty=function(name){return database.getObject(this._itemID,name);};evt.fillInfoBubble=function(elmt,theme,labeller){self._fillInfoBubble(this,elmt,theme,labeller);};events.push(evt);};currentSet.visit(function(itemID){var durations;if(itemID in self._durationCache){durations=self._durationCache[itemID];}else{durations=self._getDurations(itemID,database);self._durationCache[itemID]=durations;}
if((durations instanceof Array&&durations.length>0)||(durations.start!=null)){plottableSize++;var markerKey;if(itemID in self._markerKeyCache){markerKey=self._markerKeyCache[itemID];}else{markerKey=self._getMarkerKey(itemID,database);self._markerKeyCache[itemID]=markerKey;}
usedKeys[markerKey]=true;if(markerKey in self._markerCache){markerData=self._markerCache[markerKey];}else{markerData=Exhibit.TimelineView.theme.markers[self._maxMarker];self._markerCache[markerKey]=markerData;self._maxMarker=(self._maxMarker+1)%Exhibit.TimelineView.theme.markers.length;}
if(durations instanceof Array){for(var i=0;i<durations.length;i++){addEvent(itemID,durations[i],markerData);}}else{addEvent(itemID,durations,markerData);}}});if(plottableSize>this._largestSize){this._largestSize=plottableSize;this._reconstructTimeline(events);}else{this._eventSource.addMany(events);}
var legendLabels=[];var legendColors=[];for(markerKey in this._markerCache){if(markerKey in usedKeys){var markerData=this._markerCache[markerKey];legendLabels.push(markerKey);legendColors.push("#"+markerData.color);}}
this._dom.addLegendBlock(Exhibit.TimelineView.theme.constructLegendBlockDom(this._exhibit,Exhibit.TimelineView.l10n.colorLegendTitle,legendColors,legendLabels));this._dom.setTypes(database.getTypeLabels(currentSet)[currentSize>1?1:0]);var band=this._dom.timeline.getBand(0);var centerDate=band.getCenterVisibleDate();if(centerDate<this._eventSource.getEarliestDate()){band.scrollToCenter(this._eventSource.getEarliestDate());}else if(centerDate>this._eventSource.getLatestDate()){band.scrollToCenter(this._eventSource.getLatestDate());}}
this._dom.setCounts(currentSize,plottableSize,originalSize);};Exhibit.TimelineView.prototype._fillInfoBubble=function(evt,elmt,theme,labeller){this._lensRegistry.createLens(evt._itemID,elmt,this._exhibit);};