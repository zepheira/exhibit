<html>
<head>
  <meta name="Content-Type" content="text/html; charset=UTF-8" />
  <title>Temperaturer i Sverige (temperatur.nu)</title>

  <link rel="exhibit/data" type="application/jsonp" ex:converter="geoconv"
   href="http://www.editgrid.com/user/ecmanaut/sverige-geografi.exhibit.jsonp"
   jsonp-callback="editgridCallback" />

  <link rel="exhibit/data" type="application/jsonp" ex:converter="tnuconv"
   href="http://www.temperatur.nu/api/platser" />

  <link rel="shortcut icon" type="image/x-icon"
   href="http://www.temperatur.nu/favicon.ico" />

  <script type="text/javascript">
function format_time( t ) {
  function p( x ){ return x<10 ? '0'+x : x; }
  t = new Date( t*1e3 );
  var Y = t.getFullYear(), M = t.getMonth() + 1, D = t.getDate();
  var h = t.getHours(), m = t.getMinutes();// s = t.getSeconds();
  return Y+'-'+p(M)+'-'+p(D) + ' ' + p(h)+':'+p(m);
}

function name_label( ort, item ) {
  var name = [ort];
  if( item.stadsdel ) {
    name.unshift( item.stadsdel );
/*  if( item.kommun == ort )
      name.pop();
*/
  }
  return name.join(', ');
}

var landsdel = {}, landskap = {}; // Kludge (facet must be a direct property)

function geoconv( json, url ) {
  var items = json.items, item, name;
  for( var i = 0; item = items[i]; i++ ) {
    if( item.type == 'Landskap' ) {
      item['län'] = item['län'].split(';');
      for( var j = 0; name = item['län'][j]; j++ ) { // Kludge
        landsdel[name] = item.landsdel;
        landskap[name] = item.label;
      }
    }
  }
  return json;
}

// Kludge: the landskap/landsdel properties here are needed to make them facets
function tnuconv( json, url ) {
  var map = { id:'id', ort:'ort', temp:'temperatur', time:'last_update',
	      lat:'latitud', lon:'longitud', kommun:'kommun', 'län':'län',
	      label:'ort', stadsdel:'stadsdel', 'type':'id', landsdel:'län',
	      ok:'temperatur', weather:'weatherstation_url', landskap:'län',
	      desc:'desc', url:'homepage_url', interval:'fetch_intervall' };
  var conv = { label:name_label, time:format_time,
	       landsdel:function(l){ return landsdel[l.replace(' L',' l')]; },
	       landskap:function(l){ return landskap[l.replace(' L',' l')]; },
	       type:function(){ return 'Plats'; },
	       temp:function(t){ return t === null ? undefined : t; },
	       ok:function(t){ return t !== null ? 'Ja' : 'Nej'; } };
  var items = Exhibit.JSONPImporter.transformJSON( json, 'platser', map, conv );
  var props = { temp:{ valueType:'number', label:'temperatur (°C)' },
		ok:{ _valueType:'boolean', label:'levererar mätdata' },
		url:{ valueType:'url', label:'hemsida' },
		time:{ valueType:'date' },
		weather:{ valueType:'url', label:'vädersida' } };
  return { items:items, properties:props,
	   types:{ Plats:{ pluralLabel:'Platser' } } };
}

function load( url ) {
  var script = '<script type="text/javascript" src="'+ url +'"></scr'+'ipt>\n';
  document.write( script );
}

</script>

<link rel='stylesheet' href='http://simile.mit.edu/exhibit/examples/presidents/styles.css' type='text/css' />
<script type="text/javascript" src='../../../api/exhibit-api.js?views=chart,timeline&gmapkey=ABQIAAAA5JLLfCE9c7HAtg25QM2KCRT5LtkxOPBYoMsEVM7PszcKlvbgPBSuyv33s9BC557dxHekLQenXP30HA&bundle=false'> </script>
<script type="text/javascript" src="../../../extensions/chart/chart-extension.js&bundle=false"> </script>

  <style type="text/css">
.ok .exhibit-facet-body {
  height:3em;
}

.landsdel div.exhibit-facet-body {
  height:4.5em;
}

#sidebar {
  width:23%;
  background-image:url("temperatur.nu.snowy-trees.jpg");
}

#bg-credits {
  color:snow;
  white-space:pre;
  text-align:right;
  margin:7px;
}

#bg-credits a {
  color:#24F;
  text-decoration:none;
}

div.map-lens {
  height:50px;
  width:250px;
}

div.exhibit-scatterPlotView-legend table,
div.exhibit-mapView-legend table { width:100%; }

div.exhibit-scatterPlotView-legendBlock-entry { float:left; width:9em; }
div.exhibit-mapView-legendBlock-entry { float:left; width:4.5em; }
div.exhibit-scatterPlotView-legendBlock-entry:last-child,
div.exhibit-mapView-legendBlock-entry:last-child { display:none; }

/* perhaps something more wintery? (needs more matching colours)
#content {
  background-color: #E3E6EC;
}
*/
  </style>
</head>

<body>
  <div ex:role="exhibit-collection" ex:itemTypes="Plats"></div>
  <div ex:role="exhibit-logo" ex:color="Snow"></div>
  <table id="frame">
    <tr>
      <td id="content">
        <h1>Temperaturer i Sverige (<a href="http://temperatur.nu/">temperatur.nu</a>)</h1>
            <div ex:role="coder" ex:coderClass="ColorGradient" id="temperature-colors" 
			ex:gradientPoints="5, #000088; 15, #ffffff; 25, #ff0000"></div>
          <div ex:role="exhibit-viewPanel">

          <!--<div class="item" ex:role="exhibit-lens" style="display:none;">
	    <div ex:content=".ort"></div>
	    <div ex:content=".kommun"></div>
	    <div ex:content=".län"></div>
	    <div ex:content="!län.landsdel"></div>
          </div>-->

<!--          <div ex:role="exhibit-view"
            ex:label="Latitud / Temperatur"
            ex:viewClass="Exhibit.ScatterPlotView"
            ex:x=".temp"
            ex:y=".lat"
            ex:xLabel="Temperatur&nbsp;(°C)"
            ex:yLabel="Latitud&nbsp;(°)"
            ex:yAxisMin="55"
            ex:color=".landskap">
          </div>
-->

          <div ex:role="exhibit-view"
            ex:viewClass="Exhibit.MapView"
            ex:label="Karta"
            ex:lat=" .lat", ex:lng=".lon"
            ex:colorCoder="temperature-colors"
            ex:size="large"
            ex:marker=".temp"
            _ex:center="38.479394673276445, -95.361328125"
            _ex:zoom="4">
            <div class="map-lens" ex:role="exhibit-lens" style="display: none;">
              <div><span ex:if-exists=".temp">
	  	  <span ex:content=".temp"></span>°C i
	  	</span>
                <span ex:content=".label"></span>
	      </div>
              <div>
	  	(<span ex:content=".kommun"></span>,
	  	 <span ex:content=".län"></span>)
      	      </div>
              <div>Mättillfälle:
	  	<span ex:content=".time"></span>
      	      </div>
            </div>
          </div>

          <div ex:role="exhibit-view"
            ex:viewClass="Exhibit.TabularView"
            ex:label="Tabell"
            ex:columns=".temp, .ort, .stadsdel, .kommun, .län, .time"
            ex:columnLabels="°C, Ort, Stadsdel, Kommun, Län, Mättillfälle"
            ex:columnFormats="list, list, list"
            ex:sortColumn="0"
            ex:sortAscending="false"
            _ex:rowStyler="rowStyler"
            ></div>



<!--
          <div ex:role="exhibit-view"
            ex:viewClass="Exhibit.TileView"
            ex:label="Details"
            ex:orders=".time"
            ex:possibleOrders=".url, .label, .description"
            ex:grouped="false"
            ></div>
-->

          <div ex:role="exhibit-view"
            ex:viewClass="Exhibit.TimelineView"
            ex:label="Senaste mätvärde"
            ex:start=".time"
            _ex:end="."
            ex:marker=".label"
            ex:bubbleWidth="320"
            ex:bubbleHeight="200"
            ></div>

        </div>
      </td>
      <td id="sidebar">
        <div ex:role="exhibit-facet" ex:expression=".landsdel" ex:facetLabel="Landsdel"></div>
        <div ex:role="exhibit-facet" ex:expression=".landskap" ex:facetLabel="Landskap"></div>
        <div ex:role="exhibit-facet" ex:expression=".kommun" ex:facetLabel="Kommu"></div>
        <div ex:role="exhibit-facet" ex:expression=".ok" ex:facetLabel="Ok"></div>
        <div id="bg-credits">Foto:&nbsp;<a href="http://flickr.com/photos/weston/2715655/">Weston Renoud</a></div>
      </td>
    </tr>
  </table>
</body>
</html>
